<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المحاضرات الأكاديمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 50%, #1b263b 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-item:hover {
            background: rgba(45, 212, 191, 0.15);
            transform: translateX(-5px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.2) 0%, transparent 100%);
            border-right: 3px solid #2dd4bf;
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(45, 212, 191, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #2dd4bf;
            box-shadow: 0 0 20px rgba(45, 212, 191, 0.2);
        }
        
        .schedule-cell {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .lecture-card {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(45, 212, 191, 0.3);
            border-radius: 3px;
        }
        
        .toast {
            animation: slideIn 0.3s ease forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* تأثيرات زر القائمة */
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);
            border: none;
            outline: none;
        }

        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(45, 212, 191, 0.4);
        }

        .menu-toggle span {
            display: block;
            width: 24px;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-toggle span:before,
        .menu-toggle span:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
        }

        .menu-toggle span:before {
            top: -8px;
        }

        .menu-toggle span:after {
            bottom: -8px;
        }

        .menu-toggle.open span {
            background: transparent;
        }

        .menu-toggle.open span:before {
            top: 0;
            transform: rotate(45deg);
        }

        .menu-toggle.open span:after {
            bottom: 0;
            transform: rotate(-45deg);
        }

        /* تأثيرات القائمة الجانبية */
        #sidebar {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        /* القائمة على الشاشات الصغيرة */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                height: 100vh;
                transform: translateX(100%);
                opacity: 0;
            }
            
            #sidebar.visible {
                transform: translateX(0);
                opacity: 1;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            /* منع التمرير عند فتح القائمة */
            body.sidebar-open {
                overflow: hidden;
            }
        }

        /* القائمة على الشاشات الكبيرة */
        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }

        /* تأثير التعتيم للخلفية على الهواتف */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
    <style>@view-transition { navigation: auto; }</style>
</head>
<body class="h-full gradient-bg text-white overflow-auto">
    <div id="app" class="h-full w-full">
        <!-- Login Page -->
        <div id="login-page" class="min-h-full flex items-center justify-center p-4">
            <div class="glass-card rounded-3xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h1 id="system-title" class="text-2xl font-bold mb-2">نظام إدارة المحاضرات الأكاديمية</h1>
                    <p id="welcome-text" class="text-gray-400">مرحباً بك في النظام</p>
                </div>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع المستخدم</label>
                        <select id="user-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="student">طالب</option>
                            <option value="doctor">دكتور</option>
                            <option value="admin">عمادة</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                        <input type="email" id="login-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="example@university.edu">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">كلمة المرور</label>
                        <input type="password" id="login-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="••••••••">
                    </div>
                </div>
                <button onclick="handleLogin()" class="btn-primary w-full py-3 rounded-xl font-bold text-white mb-4">تسجيل الدخول</button>
                <div class="text-center">
                    <button onclick="showRegister()" class="text-teal-400 hover:text-teal-300 text-sm">إنشاء حساب جديد</button>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="min-h-full flex items-center justify-center p-4 hidden">
            <div class="glass-card rounded-3xl p-8 w-full max-w-md">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">إنشاء حساب جديد</h2>
                    <p class="text-gray-400">أدخل بياناتك للتسجيل</p>
                </div>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع الحساب</label>
                        <select id="register-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" onchange="updateRegisterForm()">
                            <option value="student">طالب</option>
                            <option value="doctor">دكتور</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">الاسم الكامل</label>
                        <input type="text" id="register-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="الاسم الكامل">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                        <input type="email" id="register-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="example@university.edu">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">كلمة المرور</label>
                        <input type="password" id="register-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="••••••••">
                    </div>
                    <div id="specialization-field">
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="register-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="">اختر التخصص</option>
                        </select>
                    </div>
                    <div id="group-field">
                        <label class="block text-sm text-gray-400 mb-2">المجموعة</label>
                        <select id="register-group" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="">اختر المجموعة</option>
                        </select>
                    </div>
                </div>
                <button onclick="handleRegister()" class="btn-primary w-full py-3 rounded-xl font-bold text-white mb-4">تسجيل</button>
                <div class="text-center">
                    <button onclick="showLogin()" class="text-teal-400 hover:text-teal-300 text-sm">لدي حساب بالفعل</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard" class="h-full hidden">
            <!-- زر القائمة للشاشات الصغيرة -->
            <button id="menu-toggle" class="menu-toggle" onclick="toggleSidebar()">
                <span></span>
            </button>
            
            <div class="flex h-full">
                <!-- Sidebar -->
                <aside id="sidebar" class="w-72 glass-card border-l border-white/10 flex flex-col">
                    <div class="p-6 border-b border-white/10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg">LMS</h2>
                                <p id="user-role-display" class="text-xs text-gray-400">نظام المحاضرات</p>
                            </div>
                        </div>
                    </div>
                    <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-auto">
                        <!-- Navigation items will be inserted here -->
                    </nav>
                    <div class="p-4 border-t border-white/10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <span id="user-avatar" class="font-bold">م</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p id="user-name-display" class="font-medium truncate">المستخدم</p>
                                <p id="user-email-display" class="text-xs text-gray-400 truncate">email@example.com</p>
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="w-full py-2 px-4 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg> تسجيل الخروج
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 overflow-auto">
                    <div id="main-content" class="p-6">
                        <!-- Content will be loaded here -->
                    </div>
                </main>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 left-4 z-50 space-y-2"></div>

        <!-- Modal Container -->
        <div id="modal-container" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div id="modal-content" class="glass-card rounded-2xl p-6 w-full max-w-lg max-h-[90%] overflow-auto">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
        
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="hideSidebar()"></div>
    </div>

    <script>
        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB3U2bt-PuZlUOb0uRPI1aPxL01Yg8lrts",
            authDomain: "universityti-d2e74.firebaseapp.com",
            projectId: "universityti-d2e74",
            storageBucket: "universityti-d2e74.firebasestorage.app",
            messagingSenderId: "205897642006",
            appId: "1:205897642006:web:d63e9753006d55f0b84537",
            measurementId: "G-6JHV42GV0H"
        };

        // تهيئة Firebase
        let firebaseApp, auth, db;
        
        // Default configuration
        const defaultConfig = {
            background_color: '#0d1b2a',
            surface_color: '#1e3a5f',
            text_color: '#ffffff',
            primary_action: '#2dd4bf',
            secondary_action: '#14b8a6',
            font_family: 'Tajawal',
            font_size: 16,
            system_title: 'نظام إدارة المحاضرات الأكاديمية',
            welcome_message: 'مرحباً بك في النظام'
        };

        let config = { ...defaultConfig };
        let allData = [];
        let currentUser = null;
        let currentView = 'dashboard';
        let recordCount = 0;

        // Data Handler
        const dataHandler = {
            onDataChanged(data) {
                allData = data;
                recordCount = data.length;
                updateUI();
            }
        };

        // Initialize SDKs
        async function initializeApp() {
            try {
                // Initialize Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log("Firebase initialized successfully");
                
                // Check authentication state
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log("User is signed in:", user.email);
                    } else {
                        console.log("No user is signed in");
                    }
                });
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showToast('فشل في تهيئة قاعدة البيانات', 'error');
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (newConfig) => {
                        config = { ...defaultConfig, ...newConfig };
                        applyConfig();
                    },
                    mapToCapabilities: (cfg) => ({
                        recolorables: [
                            {
                                get: () => cfg.background_color || defaultConfig.background_color,
                                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
                            },
                            {
                                get: () => cfg.surface_color || defaultConfig.surface_color,
                                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
                            },
                            {
                                get: () => cfg.text_color || defaultConfig.text_color,
                                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
                            },
                            {
                                get: () => cfg.primary_action || defaultConfig.primary_action,
                                set: (v) => { cfg.primary_action = v; window.elementSdk.setConfig({ primary_action: v }); }
                            },
                            {
                                get: () => cfg.secondary_action || defaultConfig.secondary_action,
                                set: (v) => { cfg.secondary_action = v; window.elementSdk.setConfig({ secondary_action: v }); }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => cfg.font_family || defaultConfig.font_family,
                            set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
                        },
                        fontSizeable: {
                            get: () => cfg.font_size || defaultConfig.font_size,
                            set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
                        }
                    }),
                    mapToEditPanelValues: (cfg) => new Map([
                        ['system_title', cfg.system_title || defaultConfig.system_title],
                        ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }

            // Initialize Data SDK
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    showToast('فشل في تهيئة قاعدة البيانات', 'error');
                }
            }

            applyConfig();
            
            // تحميل البيانات الأولية من Firebase
            await loadInitialData();
        }

        async function loadInitialData() {
            try {
                // جلب التخصصات من Firebase
                const specsSnapshot = await db.collection('specializations').get();
                const specializations = [];
                specsSnapshot.forEach(doc => {
                    specializations.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                // دمج مع البيانات الحالية
                allData = allData.filter(d => d.type !== 'specialization');
                specializations.forEach(spec => {
                    allData.push({
                        type: 'specialization',
                        ...spec
                    });
                });
                
                // جلب المجموعات
                const groupsSnapshot = await db.collection('groups').get();
                const groups = [];
                groupsSnapshot.forEach(doc => {
                    groups.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                allData = allData.filter(d => d.type !== 'group');
                groups.forEach(group => {
                    allData.push({
                        type: 'group',
                        ...group
                    });
                });
                
                // جلب المستخدمين
                const usersSnapshot = await db.collection('users').get();
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                allData = allData.filter(d => d.type !== 'user');
                users.forEach(user => {
                    allData.push({
                        type: 'user',
                        ...user
                    });
                });
                
                updateUI();
                
            } catch (error) {
                console.error("Error loading initial data:", error);
            }
        }

        function applyConfig() {
            const font = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;
            const bgColor = config.background_color || defaultConfig.background_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action || defaultConfig.primary_action;

            document.body.style.fontFamily = `${font}, sans-serif`;
            document.body.style.fontSize = `${fontSize}px`;
            
            document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
            document.getElementById('welcome-text').textContent = config.welcome_message || defaultConfig.welcome_message;

            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_action || defaultConfig.secondary_action} 100%)`;
            });
        }

        // UI Helpers
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-teal-500/90' : type === 'error' ? 'bg-red-500/90' : 'bg-blue-500/90';
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg backdrop-blur-sm`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // وظائف إدارة القائمة الجانبية
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('visible')) {
                    hideSidebar();
                } else {
                    showSidebar();
                }
            }
        }

        function showSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.add('visible');
            overlay.classList.add('active');
            toggleBtn.classList.add('open');
            document.body.classList.add('sidebar-open');
        }

        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.remove('visible');
            overlay.classList.remove('active');
            toggleBtn.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }

        // تحديث حالة القائمة عند تغيير حجم النافذة
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (window.innerWidth > 768) {
                // على الشاشات الكبيرة، تأكد من أن القائمة مرئية
                sidebar.classList.remove('visible');
                if (overlay) overlay.classList.remove('active');
                if (toggleBtn) toggleBtn.classList.remove('open');
                document.body.classList.remove('sidebar-open');
            }
        }

        // إغلاق القائمة عند النقر على رابط في القائمة (للشاشات الصغيرة)
        function closeSidebarOnClick() {
            const navItems = document.querySelectorAll('#sidebar-nav button, #sidebar button');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            hideSidebar();
                        }, 300);
                    }
                });
            });
        }

        // Navigation
        const adminNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'specializations', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', label: 'التخصصات' },
            { id: 'doctors', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z', label: 'الدكاترة' },
            { id: 'courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'المقررات' },
            { id: 'schedules', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'الجداول' },
            { id: 'groups', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z', label: 'المجموعات' },
            { id: 'rooms', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', label: 'القاعات' },
            { id: 'reports', icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z', label: 'التقارير' }
        ];

        const doctorNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'my-schedule', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'جدولي' },
            { id: 'my-courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'موادي' },
            { id: 'my-students', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', label: 'طلابي' },
            { id: 'attendance', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', label: 'الحضور' }
        ];

        const studentNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'full-schedule', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'الجدول الكامل' },
            { id: 'today-schedule', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z', label: 'جدول اليوم' },
            { id: 'my-courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'مقرراتي' },
            { id: 'my-doctors', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z', label: 'دكاترتي' },
            { id: 'my-attendance', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', label: 'حضوري' }
        ];

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            let navItems = [];
            
            if (currentUser.role === 'admin') {
                navItems = adminNav;
                document.getElementById('user-role-display').textContent = 'لوحة العمادة';
            } else if (currentUser.role === 'doctor') {
                navItems = doctorNav;
                document.getElementById('user-role-display').textContent = 'لوحة الدكتور';
            } else {
                navItems = studentNav;
                document.getElementById('user-role-display').textContent = 'لوحة الطالب';
            }

            nav.innerHTML = navItems.map(item => `
                <button onclick="navigateTo('${item.id}')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:text-white ${currentView === item.id ? 'active' : ''}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"/>
                    </svg>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function navigateTo(viewId) {
            currentView = viewId;
            renderSidebar();
            renderContent();
        }

        // Auth Functions with Firebase
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const userType = document.getElementById('user-type').value;

            if (!email || !password) {
                showToast('يرجى إدخال جميع البيانات', 'error');
                return;
            }

            try {
                // Check for admin login
                if (userType === 'admin') {
                    if (email === 'admin@university.edu' && password === 'admin123') {
                        currentUser = {
                            id: 'admin',
                            name: 'مدير النظام',
                            email: email,
                            role: 'admin'
                        };
                        showDashboard();
                        return;
                    } else {
                        showToast('بيانات الدخول غير صحيحة', 'error');
                        return;
                    }
                }

                // Login with Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Get user data from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.role === userType) {
                        currentUser = {
                            id: user.uid,
                            name: userData.name,
                            email: user.email,
                            role: userData.role,
                            specialization_id: userData.specialization_id,
                            group_id: userData.group_id
                        };
                        showDashboard();
                    } else {
                        showToast('نوع المستخدم غير متطابق', 'error');
                        await auth.signOut();
                    }
                } else {
                    showToast('بيانات المستخدم غير موجودة', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Login error:", error);
                showToast('بيانات الدخول غير صحيحة', 'error');
            }
        }

        async function handleRegister() {
            const type = document.getElementById('register-type').value;
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const specialization = document.getElementById('register-specialization').value;
            const group = document.getElementById('register-group').value;

            if (!name || !email || !password) {
                showToast('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }

            if (type === 'student' && (!specialization || !group)) {
                showToast('يرجى اختيار التخصص والمجموعة', 'error');
                return;
            }

            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    role: type,
                    specialization_id: type === 'student' ? specialization : '',
                    group_id: type === 'student' ? group : '',
                    created_at: new Date().toISOString()
                });

                showToast('تم التسجيل بنجاح');
                showLogin();
            } catch (error) {
                console.error("Registration error:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('البريد الإلكتروني مسجل بالفعل', 'error');
                } else {
                    showToast('فشل في التسجيل', 'error');
                }
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error);
            }
            
            currentUser = null;
            currentView = 'dashboard';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            updateSpecializationOptions();
        }

        function updateRegisterForm() {
            const type = document.getElementById('register-type').value;
            const specField = document.getElementById('specialization-field');
            const groupField = document.getElementById('group-field');
            
            if (type === 'doctor') {
                specField.classList.add('hidden');
                groupField.classList.add('hidden');
            } else {
                specField.classList.remove('hidden');
                groupField.classList.remove('hidden');
            }
        }

        function updateSpecializationOptions() {
            const specializations = allData.filter(d => d.type === 'specialization');
            const select = document.getElementById('register-specialization');
            select.innerHTML = '<option value="">اختر التخصص</option>' + 
                specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = currentUser.name;
            document.getElementById('user-email-display').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
            
            renderSidebar();
            renderContent();
            
            // إضافة مستمعين لتغيير حجم النافذة
            window.addEventListener('resize', handleResize);
            
            // إغلاق القائمة عند النقر على الروابط
            closeSidebarOnClick();
            
            // تهيئة حالة القائمة
            handleResize();
        }

        // Content Rendering (متبقي كما هو مع تعديلات طفيفة)
        function renderContent() {
            const container = document.getElementById('main-content');
            
            if (currentUser.role === 'admin') {
                renderAdminContent(container);
            } else if (currentUser.role === 'doctor') {
                renderDoctorContent(container);
            } else {
                renderStudentContent(container);
            }
        }

        // باقي دوال التصيير تبقى كما هي مع تعديلات لاستخدام Firebase بدلاً من SDKs القديمة

        // Admin Dashboard
        function renderAdminDashboard(container) {
            const specs = allData.filter(d => d.type === 'specialization').length;
            const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor').length;
            const students = allData.filter(d => d.type === 'user' && d.role === 'student').length;
            const courses = allData.filter(d => d.type === 'course').length;
            const rooms = allData.filter(d => d.type === 'room').length;
            const groups = allData.filter(d => d.type === 'group').length;

            container.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold mb-2">مرحباً بك في لوحة التحكم</h1>
                    <p class="text-gray-400">إدارة شاملة للنظام الأكاديمي</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${specs}</span>
                        </div>
                        <h3 class="font-semibold text-lg">التخصصات</h3>
                        <p class="text-gray-400 text-sm">الأقسام الأكاديمية</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${doctors}</span>
                        </div>
                        <h3 class="font-semibold text-lg">الدكاترة</h3>
                        <p class="text-gray-400 text-sm">أعضاء هيئة التدريس</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${students}</span>
                        </div>
                        <h3 class="font-semibold text-lg">الطلاب</h3>
                        <p class="text-gray-400 text-sm">المسجلين في النظام</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${courses}</span>
                        </div>
                        <h3 class="font-semibold text-lg">المقررات</h3>
                        <p class="text-gray-400 text-sm">المواد الدراسية</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${rooms}</span>
                        </div>
                        <h3 class="font-semibold text-lg">القاعات</h3>
                        <p class="text-gray-400 text-sm">قاعات ومعامل</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${groups}</span>
                        </div>
                        <h3 class="font-semibold text-lg">المجموعات</h3>
                        <p class="text-gray-400 text-sm">مجموعات الطلاب</p>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4">إجراءات سريعة</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="navigateTo('specializations')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة تخصص
                        </button>
                        <button onclick="navigateTo('doctors')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة دكتور
                        </button>
                        <button onclick="navigateTo('courses')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة مقرر
                        </button>
                        <button onclick="navigateTo('schedules')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إدارة الجداول
                        </button>
                    </div>
                </div>
            `;
        }
// بعد سطر 1070، أضف الكود التالي:
// إدارة التخصصات (للعمادة)
function renderAdminSpecializations(container) {
    const specializations = allData.filter(d => d.type === 'specialization');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة التخصصات</h1>
                <button onclick="showAddSpecializationModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة تخصص
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة التخصصات الأكاديمية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم التخصص</th>
                            <th class="text-right py-3 px-4">عدد المقررات</th>
                            <th class="text-right py-3 px-4">عدد المجموعات</th>
                            <th class="text-right py-3 px-4">عدد الطلاب</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${specializations.map(spec => {
                            const courses = allData.filter(d => d.type === 'course' && d.specialization_id === spec.__backendId).length;
                            const groups = allData.filter(d => d.type === 'group' && d.specialization_id === spec.__backendId).length;
                            const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === spec.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4 font-medium">${spec.name}</td>
                                    <td class="py-3 px-4">${courses}</td>
                                    <td class="py-3 px-4">${groups}</td>
                                    <td class="py-3 px-4">${students}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">نشط</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editSpecialization('${spec.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteSpecialization('${spec.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
function showAddSpecializationModal() {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة تخصص جديد</h2>
            <p class="text-gray-400">أدخل بيانات التخصص الجديد</p>
        </div>
        <form onsubmit="addSpecialization(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: علوم الحاسب">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف التخصص</label>
                    <textarea id="spec-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3" placeholder="وصف مختصر للتخصص..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">عدد المستويات</label>
                    <select id="spec-levels" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                        ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">${l} مستويات</option>`).join('')}
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addSpecialization(e) {
    e.preventDefault();
    const name = document.getElementById('spec-name').value;
    const description = document.getElementById('spec-description').value;
    const levels = document.getElementById('spec-levels').value;

    try {
        const docRef = await db.collection('specializations').add({
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة التخصص بنجاح');
        hideModal();

        allData.push({
            type: 'specialization',
            __backendId: docRef.id,
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active'
        });

        updateUI();
    } catch (error) {
        console.error("Error adding specialization:", error);
        showToast('فشل في إضافة التخصص', 'error');
    }
}

async function deleteSpecialization(id) {
    if (!confirm('هل أنت متأكد من حذف هذا التخصص؟ سيتم حذف جميع المقررات والمجموعات المرتبطة به.')) return;
    
    try {
        await db.collection('specializations').doc(id).delete();
        showToast('تم حذف التخصص');
        
        allData = allData.filter(d => !(d.type === 'specialization' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting specialization:", error);
        showToast('فشل في الحذف', 'error');
    }
}
function showAddSpecializationModal() {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة تخصص جديد</h2>
            <p class="text-gray-400">أدخل بيانات التخصص الجديد</p>
        </div>
        <form onsubmit="addSpecialization(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: علوم الحاسب">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف التخصص</label>
                    <textarea id="spec-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3" placeholder="وصف مختصر للتخصص..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">عدد المستويات</label>
                    <select id="spec-levels" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                        ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">${l} مستويات</option>`).join('')}
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addSpecialization(e) {
    e.preventDefault();
    const name = document.getElementById('spec-name').value;
    const description = document.getElementById('spec-description').value;
    const levels = document.getElementById('spec-levels').value;

    try {
        const docRef = await db.collection('specializations').add({
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة التخصص بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'specialization',
            __backendId: docRef.id,
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active'
        });

        updateUI();
    } catch (error) {
        console.error("Error adding specialization:", error);
        showToast('فشل في إضافة التخصص', 'error');
    }
}

async function deleteSpecialization(id) {
    if (!confirm('هل أنت متأكد من حذف هذا التخصص؟ سيتم حذف جميع المقررات والمجموعات المرتبطة به.')) return;
    
    try {
        await db.collection('specializations').doc(id).delete();
        showToast('تم حذف التخصص');
        
        allData = allData.filter(d => !(d.type === 'specialization' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting specialization:", error);
        showToast('فشل في الحذف', 'error');
    }
}
// إدارة الدكاترة (للعمادة)
function renderAdminDoctors(container) {
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة الدكاترة</h1>
                <button onclick="showAddDoctorModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة دكتور
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة أعضاء هيئة التدريس</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">الاسم</th>
                            <th class="text-right py-3 px-4">البريد الإلكتروني</th>
                            <th class="text-right py-3 px-4">الهاتف</th>
                            <th class="text-right py-3 px-4">عدد المقررات</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${doctors.map(doctor => {
                            const courses = allData.filter(d => d.type === 'course' && d.doctor_id === doctor.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${doctor.name}</td>
                                    <td class="py-3 px-4">${doctor.email}</td>
                                    <td class="py-3 px-4">${doctor.phone || 'غير محدد'}</td>
                                    <td class="py-3 px-4">${courses}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">نشط</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editDoctor('${doctor.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteDoctor('${doctor.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddDoctorModal() {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة دكتور جديد</h2>
            <p class="text-gray-400">أدخل بيانات الدكتور الجديد</p>
        </div>
        <form onsubmit="addDoctor(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الاسم الكامل</label>
                    <input type="text" id="doctor-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                    <input type="email" id="doctor-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">رقم الهاتف</label>
                    <input type="tel" id="doctor-phone" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">كلمة المرور الافتراضية</label>
                    <input type="text" id="doctor-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" value="doctor123" readonly>
                    <p class="text-xs text-gray-400 mt-1">سيتم تغييرها عند أول دخول</p>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addDoctor(e) {
    e.preventDefault();
    const name = document.getElementById('doctor-name').value;
    const email = document.getElementById('doctor-email').value;
    const phone = document.getElementById('doctor-phone').value;
    const password = document.getElementById('doctor-password').value;

    try {
        // إنشاء حساب في Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // حفظ بيانات الدكتور في Firestore
        await db.collection('users').doc(user.uid).set({
            name: name,
            email: email,
            phone: phone || '',
            role: 'doctor',
            status: 'active',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة الدكتور بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'user',
            __backendId: user.uid,
            name: name,
            email: email,
            phone: phone || '',
            role: 'doctor',
            status: 'active'
        });

        updateUI();
    } catch (error) {
        console.error("Error adding doctor:", error);
        showToast('فشل في إضافة الدكتور', 'error');
    }
}

async function deleteDoctor(id) {
    if (!confirm('هل أنت متأكد من حذف هذا الدكتور؟')) return;
    
    try {
        // حذف من Firestore
        await db.collection('users').doc(id).delete();
        
        // حذف من Authentication (يتطلب صلاحيات إدارية في Firebase)
        // Note: هذا الجزء يتطلب صلاحيات خاصة في Firebase
        
        showToast('تم حذف الدكتور');
        
        // تحديث البيانات المحلية
        allData = allData.filter(d => !(d.type === 'user' && d.__backendId === id && d.role === 'doctor'));
        updateUI();
    } catch (error) {
        console.error("Error deleting doctor:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة المقررات (للعمادة)
function renderAdminCourses(container) {
    const courses = allData.filter(d => d.type === 'course');
    const specializations = allData.filter(d => d.type === 'specialization');
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة المقررات</h1>
                <button onclick="showAddCourseModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة مقرر
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة المواد الدراسية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">رمز المقرر</th>
                            <th class="text-right py-3 px-4">اسم المقرر</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">الدكتور</th>
                            <th class="text-right py-3 px-4">الساعات</th>
                            <th class="text-right py-3 px-4">النوع</th>
                            <th class="text-right py-3 px-4">المستوى</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => {
                            const specialization = specializations.find(s => s.__backendId === course.specialization_id);
                            const doctor = doctors.find(d => d.__backendId === course.doctor_id);
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4 font-mono">${course.code || 'غير محدد'}</td>
                                    <td class="py-3 px-4">${course.name}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${doctor ? doctor.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${course.hours || 0}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                            ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">${course.level || 1}</td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editCourse('${course.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteCourse('${course.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddCourseModal() {
    const specializations = allData.filter(d => d.type === 'specialization');
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة مقرر جديد</h2>
            <p class="text-gray-400">أدخل بيانات المقرر الجديد</p>
        </div>
        <form onsubmit="addCourse(event)">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">رمز المقرر</label>
                        <input type="text" id="course-code" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">اسم المقرر</label>
                        <input type="text" id="course-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="course-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر التخصص</option>
                            ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">الدكتور</label>
                        <select id="course-doctor" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر الدكتور</option>
                            ${doctors.map(d => `<option value="${d.__backendId}">${d.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">عدد الساعات</label>
                        <input type="number" id="course-hours" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" min="1" max="10" value="3" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المستوى</label>
                        <select id="course-level" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">المستوى ${l}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع المقرر</label>
                        <select id="course-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="theoretical">نظري</option>
                            <option value="practical">عملي</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الوصف</label>
                    <textarea id="course-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addCourse(e) {
    e.preventDefault();
    const code = document.getElementById('course-code').value;
    const name = document.getElementById('course-name').value;
    const specialization_id = document.getElementById('course-specialization').value;
    const doctor_id = document.getElementById('course-doctor').value;
    const hours = document.getElementById('course-hours').value;
    const level = document.getElementById('course-level').value;
    const course_type = document.getElementById('course-type').value;
    const description = document.getElementById('course-description').value;

    try {
        const docRef = await db.collection('courses').add({
            code: code,
            name: name,
            specialization_id: specialization_id,
            doctor_id: doctor_id,
            hours: parseInt(hours),
            level: parseInt(level),
            course_type: course_type,
            description: description || '',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المقرر بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'course',
            __backendId: docRef.id,
            code: code,
            name: name,
            specialization_id: specialization_id,
            doctor_id: doctor_id,
            hours: parseInt(hours),
            level: parseInt(level),
            course_type: course_type,
            description: description || ''
        });

        updateUI();
    } catch (error) {
        console.error("Error adding course:", error);
        showToast('فشل في إضافة المقرر', 'error');
    }
}

async function deleteCourse(id) {
    if (!confirm('هل أنت متأكد من حذف هذا المقرر؟')) return;
    
    try {
        await db.collection('courses').doc(id).delete();
        showToast('تم حذف المقرر');
        
        allData = allData.filter(d => !(d.type === 'course' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting course:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة الجداول (للعمادة)
function renderAdminSchedules(container) {
    const schedules = allData.filter(d => d.type === 'schedule');
    const courses = allData.filter(d => d.type === 'course');
    const groups = allData.filter(d => d.type === 'group');
    const rooms = allData.filter(d => d.type === 'room');
    const specializations = allData.filter(d => d.type === 'specialization');
    
    const uniqueLevels = [...new Set(courses.map(c => c.level))].sort((a, b) => a - b);
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة الجداول</h1>
                <div class="flex gap-3">
                    <select id="schedule-specialization" onchange="filterSchedules()" class="input-field px-4 py-3 rounded-xl text-white outline-none w-48">
                        <option value="">جميع التخصصات</option>
                        ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                    </select>
                    <select id="schedule-level" onchange="filterSchedules()" class="input-field px-4 py-3 rounded-xl text-white outline-none w-48">
                        <option value="">جميع المستويات</option>
                        ${uniqueLevels.map(l => `<option value="${l}">المستوى ${l}</option>`).join('')}
                    </select>
                    <button onclick="showAddScheduleModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                        إضافة محاضرة
                    </button>
                </div>
            </div>
            <p class="text-gray-400 mt-2">جدولة المحاضرات حسب التخصص والمستوى</p>
        </div>
        
        <div id="schedules-container" class="space-y-8">
            <!-- سيتم عرض الجداول هنا -->
        </div>
    `;
    
    renderFilteredSchedules();
}

function renderFilteredSchedules() {
    const container = document.getElementById('schedules-container');
    const selectedSpec = document.getElementById('schedule-specialization').value;
    const selectedLevel = document.getElementById('schedule-level').value;
    
    const schedules = allData.filter(d => d.type === 'schedule');
    const courses = allData.filter(d => d.type === 'course');
    const groups = allData.filter(d => d.type === 'group');
    const rooms = allData.filter(d => d.type === 'room');
    const specializations = allData.filter(d => d.type === 'specialization');
    
    const filteredSchedules = schedules.filter(schedule => {
        const course = courses.find(c => c.__backendId === schedule.course_id);
        if (!course) return false;
        
        if (selectedSpec && course.specialization_id !== selectedSpec) return false;
        if (selectedLevel && course.level != selectedLevel) return false;
        
        return true;
    });
    
    if (filteredSchedules.length === 0) {
        container.innerHTML = `
            <div class="glass-card rounded-2xl p-12 text-center">
                <svg class="w-20 h-20 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <h3 class="text-xl font-medium mb-2">لا توجد محاضرات</h3>
                <p class="text-gray-400">${selectedSpec || selectedLevel ? 'لا توجد محاضرات مطابقة للفلاتر المحددة' : 'لم تتم إضافة أي محاضرات بعد'}</p>
            </div>
        `;
        return;
    }
    
    const groupedSchedules = {};
    
    filteredSchedules.forEach(schedule => {
        const course = courses.find(c => c.__backendId === schedule.course_id);
        if (!course) return;
        
        const spec = specializations.find(s => s.__backendId === course.specialization_id);
        const key = `${course.specialization_id}_${course.level}`;
        
        if (!groupedSchedules[key]) {
            groupedSchedules[key] = {
                specialization: spec,
                level: course.level,
                schedules: []
            };
        }
        
        groupedSchedules[key].schedules.push(schedule);
    });
    
    container.innerHTML = Object.values(groupedSchedules).map(group => {
        return `
            <div class="glass-card rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold">${group.specialization ? group.specialization.name : 'غير معروف'} - المستوى ${group.level}</h2>
                        <p class="text-gray-400">عدد المحاضرات: ${group.schedules.length}</p>
                    </div>
                    <button onclick="downloadSchedule('${group.specialization ? group.specialization.__backendId : ''}', ${group.level})" class="px-4 py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                        تصدير الجدول
                    </button>
                </div>
                
                <div class="grid grid-cols-7 gap-4 mb-4">
                    ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                        <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                    `).join('')}
                </div>
                <div class="grid grid-cols-7 gap-4">
                    ${Array.from({length: 7}, (_, dayIndex) => {
                        const daySchedules = group.schedules.filter(s => s.day === dayIndex);
                        return `
                            <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                                ${daySchedules.map(schedule => {
                                    const course = courses.find(c => c.__backendId === schedule.course_id);
                                    const groupObj = groups.find(g => g.__backendId === schedule.group_id);
                                    const room = rooms.find(r => r.__backendId === schedule.room_id);
                                    return `
                                        <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                            <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                            <div class="text-sm text-gray-400">${groupObj ? groupObj.name : 'غير معروف'}</div>
                                            <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                            <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                            <div class="flex gap-1 mt-2">
                                                <button onclick="editSchedule('${schedule.__backendId}')" class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                    تعديل
                                                </button>
                                                <button onclick="deleteSchedule('${schedule.__backendId}')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                    حذف
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function filterSchedules() {
    renderFilteredSchedules();
}

function downloadSchedule(specializationId, level) {
    const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === specializationId);
    showToast(`تم تصدير جدول ${specialization ? specialization.name : ''} - المستوى ${level}`, 'success');
}

function showAddScheduleModal() {
    const courses = allData.filter(d => d.type === 'course');
    const groups = allData.filter(d => d.type === 'group');
    const rooms = allData.filter(d => d.type === 'room');
    const specializations = allData.filter(d => d.type === 'specialization');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة محاضرة جديدة</h2>
            <p class="text-gray-400">جدولة محاضرة في الجدول</p>
        </div>
        <form onsubmit="addSchedule(event)">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="schedule-specialization-select" onchange="updateCoursesBySpecialization()" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر التخصص</option>
                            ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المستوى</label>
                        <select id="schedule-level-select" onchange="updateCoursesByLevel()" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر المستوى</option>
                            ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">المستوى ${l}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المقرر</label>
                        <select id="schedule-course" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر المقرر</option>
                            ${courses.map(c => `<option value="${c.__backendId}" data-spec="${c.specialization_id}" data-level="${c.level}">${c.code} - ${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المجموعة</label>
                        <select id="schedule-group" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر المجموعة</option>
                            ${groups.map(g => `<option value="${g.__backendId}">${g.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">اليوم</label>
                        <select id="schedule-day" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="0">الأحد</option>
                            <option value="1">الاثنين</option>
                            <option value="2">الثلاثاء</option>
                            <option value="3">الأربعاء</option>
                            <option value="4">الخميس</option>
                            <option value="5">الجمعة</option>
                            <option value="6">السبت</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">القاعة</label>
                        <select id="schedule-room" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر القاعة</option>
                            ${rooms.map(r => `<option value="${r.__backendId}">${r.name} (${r.type === 'lecture' ? 'قاعة' : 'معمل'})</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">وقت البداية</label>
                        <input type="time" id="schedule-start" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required value="08:00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">وقت النهاية</label>
                        <input type="time" id="schedule-end" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required value="10:00">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">نوع المحاضرة</label>
                    <select id="schedule-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                        <option value="theoretical">نظري</option>
                        <option value="practical">عملي</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}
function updateCoursesBySpecialization() {
    const specId = document.getElementById('schedule-specialization-select').value;
    const levelSelect = document.getElementById('schedule-level-select');
    const courseSelect = document.getElementById('schedule-course');
    const courses = allData.filter(d => d.type === 'course');
    
    const levels = [...new Set(courses.filter(c => c.specialization_id === specId).map(c => c.level))].sort((a, b) => a - b);
    
    levelSelect.innerHTML = '<option value="">اختر المستوى</option>' + 
        levels.map(l => `<option value="${l}">المستوى ${l}</option>`).join('');
    
    updateCoursesByLevel();
}

function updateCoursesByLevel() {
    const specId = document.getElementById('schedule-specialization-select').value;
    const level = document.getElementById('schedule-level-select').value;
    const courseSelect = document.getElementById('schedule-course');
    const courses = allData.filter(d => d.type === 'course');
    
    let filteredCourses = courses;
    
    if (specId) {
        filteredCourses = filteredCourses.filter(c => c.specialization_id === specId);
    }
    
    if (level) {
        filteredCourses = filteredCourses.filter(c => c.level == level);
    }
    
    courseSelect.innerHTML = '<option value="">اختر المقرر</option>' + 
        filteredCourses.map(c => `<option value="${c.__backendId}">${c.code} - ${c.name}</option>`).join('');
}

async function addSchedule(e) {
    e.preventDefault();
    const course_id = document.getElementById('schedule-course').value;
    const group_id = document.getElementById('schedule-group').value;
    const day = parseInt(document.getElementById('schedule-day').value);
    const room_id = document.getElementById('schedule-room').value;
    const start_time = document.getElementById('schedule-start').value;
    const end_time = document.getElementById('schedule-end').value;
    const type = document.getElementById('schedule-type').value;

    try {
        const docRef = await db.collection('schedules').add({
            course_id: course_id,
            group_id: group_id,
            day: day,
            room_id: room_id,
            start_time: start_time,
            end_time: end_time,
            type: type,
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المحاضرة بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'schedule',
            __backendId: docRef.id,
            course_id: course_id,
            group_id: group_id,
            day: day,
            room_id: room_id,
            start_time: start_time,
            end_time: end_time,
            type: type
        });

        updateUI();
    } catch (error) {
        console.error("Error adding schedule:", error);
        showToast('فشل في إضافة المحاضرة', 'error');
    }
}

async function deleteSchedule(id) {
    if (!confirm('هل أنت متأكد من حذف هذه المحاضرة؟')) return;
    
    try {
        await db.collection('schedules').doc(id).delete();
        showToast('تم حذف المحاضرة');
        
        allData = allData.filter(d => !(d.type === 'schedule' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting schedule:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة المجموعات (للعمادة)
function renderAdminGroups(container) {
    const groups = allData.filter(d => d.type === 'group');
    const specializations = allData.filter(d => d.type === 'specialization');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة المجموعات</h1>
                <button onclick="showAddGroupModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة مجموعة
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة مجموعات الطلاب</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم المجموعة</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">عدد الطلاب</th>
                            <th class="text-right py-3 px-4">السعة</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groups.map(group => {
                            const specialization = specializations.find(s => s.__backendId === group.specialization_id);
                            const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.group_id === group.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${group.name}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${students}</td>
                                    <td class="py-3 px-4">${group.capacity || 30}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${students < (group.capacity || 30) ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                            ${students < (group.capacity || 30) ? 'متاحة' : 'ممتلئة'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editGroup('${group.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteGroup('${group.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddGroupModal() {
    const specializations = allData.filter(d => d.type === 'specialization');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة مجموعة جديدة</h2>
            <p class="text-gray-400">أدخل بيانات المجموعة الجديدة</p>
        </div>
        <form onsubmit="addGroup(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم المجموعة</label>
                    <input type="text" id="group-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: المجموعة أ">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="group-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر التخصص</option>
                            ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">السعة</label>
                        <input type="number" id="group-capacity" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" min="1" max="100" value="30" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الوصف</label>
                    <textarea id="group-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="2" placeholder="وصف المجموعة..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addGroup(e) {
    e.preventDefault();
    const name = document.getElementById('group-name').value;
    const specialization_id = document.getElementById('group-specialization').value;
    const capacity = document.getElementById('group-capacity').value;
    const description = document.getElementById('group-description').value;

    try {
        const docRef = await db.collection('groups').add({
            name: name,
            specialization_id: specialization_id,
            capacity: parseInt(capacity),
            description: description || '',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المجموعة بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'group',
            __backendId: docRef.id,
            name: name,
            specialization_id: specialization_id,
            capacity: parseInt(capacity),
            description: description || ''
        });

        updateUI();
    } catch (error) {
        console.error("Error adding group:", error);
        showToast('فشل في إضافة المجموعة', 'error');
    }
}

// إدارة القاعات (للعمادة)
function renderAdminRooms(container) {
    const rooms = allData.filter(d => d.type === 'room');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة القاعات</h1>
                <button onclick="showAddRoomModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة قاعة
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة القاعات والمعامل</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم القاعة</th>
                            <th class="text-right py-3 px-4">النوع</th>
                            <th class="text-right py-3 px-4">السعة</th>
                            <th class="text-right py-3 px-4">الموقع</th>
                            <th class="text-right py-3 px-4">المعدات</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rooms.map(room => `
                            <tr class="border-b border-white/5 hover:bg-white/5">
                                <td class="py-3 px-4">${room.name}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${room.type === 'lecture' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                        ${room.type === 'lecture' ? 'قاعة محاضرات' : 'معمل'}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${room.capacity}</td>
                                <td class="py-3 px-4">${room.location || 'غير محدد'}</td>
                                <td class="py-3 px-4">${room.equipment || 'لا يوجد'}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${room.status === 'available' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                        ${room.status === 'available' ? 'متاحة' : 'غير متاحة'}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <button onclick="editRoom('${room.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                            تعديل
                                        </button>
                                        <button onclick="deleteRoom('${room.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                            حذف
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// واجهة الدكتور
function renderDoctorDashboard(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const doctorSchedules = allData.filter(d => d.type === 'schedule');
    const today = new Date().getDay(); // 0-6 where 0 is Sunday
    
    const todaySchedules = doctorSchedules.filter(schedule => {
        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
        return course && course.doctor_id === currentUser.id && schedule.day === today;
    });

    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مرحباً دكتور ${currentUser.name}</h1>
            <p class="text-gray-400">لوحة تحكم الدكتور</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${doctorCourses.length}</span>
                </div>
                <h3 class="font-semibold text-lg">المقررات</h3>
                <p class="text-gray-400 text-sm">المواد المسندة إليك</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${todaySchedules.length}</span>
                </div>
                <h3 class="font-semibold text-lg">محاضرات اليوم</h3>
                <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">85%</span>
                </div>
                <h3 class="font-semibold text-lg">نسبة الحضور</h3>
                <p class="text-gray-400 text-sm">متوسط حضور الطلاب</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">محاضرات اليوم</h2>
                <div class="space-y-3">
                    ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                        const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                        const group = allData.find(g => g.type === 'group' && g.__backendId === schedule.group_id);
                        
                        return `
                            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course ? course.name : 'غير معروف'}</h3>
                                        <p class="text-sm text-gray-400">${group ? group.name : 'غير معروف'} - ${room ? room.name : 'غير معروف'}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-medium">${schedule.start_time} - ${schedule.end_time}</div>
                                        <button onclick="takeAttendance('${schedule.__backendId}')" class="mt-2 px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                            تسجيل حضور
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>لا توجد محاضرات اليوم</p>
                        </div>
                    `}
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">أحدث المقررات</h2>
                <div class="space-y-3">
                    ${doctorCourses.slice(0, 3).map(course => {
                        const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === course.specialization_id);
                        const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === course.specialization_id).length;
                        
                        return `
                            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course.name}</h3>
                                        <p class="text-sm text-gray-400">${specialization ? specialization.name : ''} - ${course.code}</p>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">
                                        ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between mt-3 text-sm">
                                    <span class="text-gray-400">${students} طالب</span>
                                    <span class="text-gray-400">${course.hours} ساعة</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
}

// واجهة الطالب
function renderStudentDashboard(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    const today = new Date().getDay();
    const todaySchedules = studentSchedules.filter(schedule => schedule.day === today);
    const studentCourses = allData.filter(d => d.type === 'course');
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مرحباً ${currentUser.name}</h1>
            <p class="text-gray-400">لوحة تحكم الطالب</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${todaySchedules.length}</span>
                </div>
                <h3 class="font-semibold text-lg">محاضرات اليوم</h3>
                <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${studentCourses.length}</span>
                </div>
                <h3 class="font-semibold text-lg">المقررات</h3>
                <p class="text-gray-400 text-sm">المواد المسجلة</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">92%</span>
                </div>
                <h3 class="font-semibold text-lg">نسبة الحضور</h3>
                <p class="text-gray-400 text-sm">حضورك الشخصي</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">جدول اليوم</h2>
                <div class="space-y-3">
                    ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                        const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                        const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                        
                        return `
                            <div class="p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course ? course.name : 'غير معروف'}</h3>
                                        <p class="text-sm text-gray-400">${doctor ? doctor.name : 'غير معروف'}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-medium">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-sm text-gray-400">${room ? room.name : 'غير معروف'}</div>
                                    </div>
                                </div>
                                <div class="mt-3 flex items-center justify-between text-sm">
                                    <span class="px-2 py-1 rounded-full ${schedule.type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                        ${schedule.type === 'theoretical' ? 'نظري' : 'عملي'}
                                    </span>
                                    <button onclick="confirmAttendance('${schedule.__backendId}')" class="px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                        تأكيد الحضور
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>لا توجد محاضرات اليوم</p>
                        </div>
                    `}
                </div>
            </div>
            
            <div class="glasscard rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">معلومات التخصص</h2>
                ${(() => {
                    const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === currentUser.specialization_id);
                    const group = allData.find(g => g.type === 'group' && g.__backendId === currentUser.group_id);
                    
                    if (specialization) {
                        return `
                            <div class="space-y-4">
                                <div class="p-4 rounded-lg bg-white/5">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="font-medium">${specialization.name}</h3>
                                            <p class="text-sm text-gray-400">تخصصك الأكاديمي</p>
                                        </div>
                                    </div>
                                </div>
                                
                                ${group ? `
                                    <div class="p-4 rounded-lg bg-white/5">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-medium">${group.name}</h3>
                                                <p class="text-sm text-gray-400">مجموعتك الدراسية</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    return '<p class="text-gray-400">لا توجد معلومات متاحة</p>';
                })()}
            </div>
        </div>
    `;
}

// وظائف مساعدة
function takeAttendance(scheduleId) {
    showToast('تم فتح صفحة تسجيل الحضور', 'info');
    // هنا يمكن تنفيذ منطق تسجيل الحضور
}

function confirmAttendance(scheduleId) {
    showToast('تم تأكيد حضورك', 'success');
}
// إدارة التخصصات - أضف هذا الكود
function renderAdminSpecializations(container) {
    const specializations = allData.filter(d => d.type === 'specialization');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة التخصصات</h1>
                <button onclick="showAddSpecializationModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة تخصص
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة التخصصات الأكاديمية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم التخصص</th>
                            <th class="text-right py-3 px-4">عدد المقررات</th>
                            <th class="text-right py-3 px-4">عدد المجموعات</th>
                            <th class="text-right py-3 px-4">عدد الطلاب</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${specializations.map(spec => {
                            const courses = allData.filter(d => d.type === 'course' && d.specialization_id === spec.__backendId).length;
                            const groups = allData.filter(d => d.type === 'group' && d.specialization_id === spec.__backendId).length;
                            const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === spec.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4 font-medium">${spec.name}</td>
                                    <td class="py-3 px-4">${courses}</td>
                                    <td class="py-3 px-4">${groups}</td>
                                    <td class="py-3 px-4">${students}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">نشط</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editSpecialization('${spec.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteSpecialization('${spec.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// تحديث دالة renderAdminContent
function renderAdminContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderAdminDashboard(container);
            break;
        case 'specializations':
            renderAdminSpecializations(container);
            break;
        case 'doctors':
            renderAdminDoctors(container);
            break;
        case 'courses':
            renderAdminCourses(container);
            break;
        case 'schedules':
            renderAdminSchedules(container);
            break;
        case 'groups':
            renderAdminGroups(container);
            break;
        case 'rooms':
            renderAdminRooms(container);
            break;
        case 'reports':
            renderAdminReports(container);
            break;
        default:
            renderAdminDashboard(container);
    }
} 

function renderAdminReports(container) {
    const specializations = allData.filter(d => d.type === 'specialization').length;
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor').length;
    const students = allData.filter(d => d.type === 'user' && d.role === 'student').length;
    const courses = allData.filter(d => d.type === 'course').length;
    const schedules = allData.filter(d => d.type === 'schedule').length;
    const groups = allData.filter(d => d.type === 'group').length;
    const rooms = allData.filter(d => d.type === 'room').length;
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">التقارير والإحصائيات</h1>
            <p class="text-gray-400">إحصائيات شاملة عن النظام</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات النظام</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد التخصصات</span>
                        <span class="font-bold">${specializations}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد الدكاترة</span>
                        <span class="font-bold">${doctors}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد الطلاب</span>
                        <span class="font-bold">${students}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المقررات</span>
                        <span class="font-bold">${courses}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المجموعات</span>
                        <span class="font-bold">${groups}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد القاعات</span>
                        <span class="font-bold">${rooms}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المحاضرات</span>
                        <span class="font-bold">${schedules}</span>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">تقارير الحضور</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور العامة</span>
                            <span>85%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-teal-500" style="width: 85%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور النظرية</span>
                            <span>88%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500" style="width: 88%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور العملية</span>
                            <span>82%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-orange-500" style="width: 82%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-medium mb-3">أعلى 5 مقررات حضوراً</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>هياكل البيانات</span>
                            <span class="text-teal-400">94%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>قواعد البيانات</span>
                            <span class="text-teal-400">91%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>برمجة الويب</span>
                            <span class="text-teal-400">89%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>الشبكات</span>
                            <span class="text-teal-400">87%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>الرياضيات</span>
                            <span class="text-teal-400">85%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// تحديث دالة renderDoctorContent
function renderDoctorContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderDoctorDashboard(container);
            break;
        case 'my-schedule':
            renderDoctorSchedule(container);
            break;
        case 'my-courses':
            renderDoctorCourses(container);
            break;
        case 'my-students':
            renderDoctorStudents(container);
            break;
        case 'attendance':
            renderDoctorAttendance(container);
            break;
        default:
            renderDoctorDashboard(container);
    }
}

function renderDoctorSchedule(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const schedules = allData.filter(d => d.type === 'schedule');
    const doctorSchedules = schedules.filter(schedule => {
        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
        return course && course.doctor_id === currentUser.id;
    });
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">جدولي الأسبوعي</h1>
            <p class="text-gray-400">محاضراتي المجدولة لهذا الأسبوع</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-7 gap-4 mb-4">
                ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                    <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                `).join('')}
            </div>
            <div class="grid grid-cols-7 gap-4">
                ${Array.from({length: 7}, (_, dayIndex) => {
                    const daySchedules = doctorSchedules.filter(s => s.day === dayIndex);
                    return `
                        <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                            ${daySchedules.map(schedule => {
                                const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                                const group = allData.find(g => g.type === 'group' && g.__backendId === schedule.group_id);
                                const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                                return `
                                    <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                        <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                        <div class="text-sm text-gray-400">${group ? group.name : 'غير معروف'}</div>
                                        <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                        <button onclick="takeAttendance('${schedule.__backendId}')" class="w-full mt-2 px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                            تسجيل حضور
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function renderDoctorCourses(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">المقررات المسندة إلي</h1>
            <p class="text-gray-400">جميع المواد التي أقوم بتدريسها</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${doctorCourses.map(course => {
                const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === course.specialization_id);
                const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === course.specialization_id).length;
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <span class="text-2xl font-bold">${course.hours || 0}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2">${course.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${specialization ? specialization.name : ''}</p>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">${course.code || 'لا يوجد رمز'}</span>
                            <span class="px-2 py-1 rounded-full ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                            </span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400">عدد الطلاب:</span>
                                <span class="font-medium">${students}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">المستوى:</span>
                                <span class="font-medium">${course.level || 1}</span>
                            </div>
                        </div>
                        <button onclick="uploadCourseMaterial('${course.__backendId}')" class="w-full mt-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            رفع مواد دراسية
                        </button>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderDoctorStudents(container) {
    // طلاب الدكتور بناءً على المقررات التي يدرسها
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const students = allData.filter(d => d.type === 'user' && d.role === 'student');
    
    // تجميع الطلاب الذين يدرسون مقررات هذا الدكتور
    const doctorStudents = students.filter(student => {
        // التحقق إذا كان الطالب في تخصص يدرس فيه الدكتور مقرراً
        return doctorCourses.some(course => course.specialization_id === student.specialization_id);
    });
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">قائمة الطلاب</h1>
            <p class="text-gray-400">طلابي في المقررات المختلفة</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم الطالب</th>
                            <th class="text-right py-3 px-4">البريد الإلكتروني</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">المجموعة</th>
                            <th class="text-right py-3 px-4">نسبة الحضور</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${doctorStudents.map(student => {
                            const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === student.specialization_id);
                            const group = allData.find(g => g.type === 'group' && g.__backendId === student.group_id);
                            
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${student.name}</td>
                                    <td class="py-3 px-4">${student.email}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${group ? group.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-teal-500" style="width: ${Math.floor(Math.random() * 30) + 70}%"></div>
                                            </div>
                                            <span>${Math.floor(Math.random() * 30) + 70}%</span>
                                        </div>
                                    </td>
                                    <td class="py-3 px-4">
                                        <button onclick="viewStudentDetails('${student.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                            عرض التفاصيل
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderDoctorAttendance(container) {
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">نظام الحضور والغياب</h1>
            <p class="text-gray-400">تسجيل حضور طلابك</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">المحاضرات القادمة</h2>
                <div class="space-y-3">
                    ${Array.from({length: 3}).map((_, i) => {
                        const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                        const times = ['08:00 - 10:00', '10:00 - 12:00', '14:00 - 16:00'];
                        const rooms = ['قاعة 101', 'معمل 203', 'قاعة 305'];
                        
                        return `
                            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-medium">${courses[i]}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                        ${times[i]}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-400 mb-3">${rooms[i]}</p>
                                <button onclick="startAttendanceSession(${i})" class="w-full py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                    بدء تسجيل الحضور
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات الحضور</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-medium mb-2">نسبة الحضور حسب المقرر</h3>
                        <div class="space-y-3">
                            ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب', 'الشبكات', 'الرياضيات'].map((course, i) => {
                                const percentage = [94, 91, 89, 87, 85][i];
                                return `
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm">${course}</span>
                                            <span class="text-sm">${percentage}%</span>
                                        </div>
                                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-teal-500" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">آخر تسجيلات الحضور</h3>
                        <div class="space-y-2">
                            ${['اليوم 08:00', 'أمس 14:00', '٢٠/١٠ 10:00'].map((time, i) => {
                                const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                                return `
                                    <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                                        <span>${courses[i]}</span>
                                        <span class="text-sm text-gray-400">${time}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function uploadCourseMaterial(courseId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">رفع مواد دراسية</h2>
            <p class="text-gray-400">أرفع المواد التعليمية للطلاب</p>
        </div>
        <form onsubmit="handleMaterialUpload(event, '${courseId}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">عنوان المادة</label>
                    <input type="text" id="material-title" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: محاضرة الأسبوع الأول">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف المادة</label>
                    <textarea id="material-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3" placeholder="وصف مختصر للمادة..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">نوع المادة</label>
                    <select id="material-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                        <option value="lecture">محاضرة</option>
                        <option value="assignment">واجب</option>
                        <option value="exam">امتحان</option>
                        <option value="resource">مرجع</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">رفع ملف</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-gray-400 mb-2">اسحب وأفلت الملف هنا أو</p>
                        <input type="file" id="material-file" class="hidden" accept=".pdf,.doc,.docx,.ppt,.pptx">
                        <label for="material-file" class="cursor-pointer px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            اختر ملف
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">رفع</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

function handleMaterialUpload(e, courseId) {
    e.preventDefault();
    showToast('تم رفع المادة الدراسية بنجاح', 'success');
    hideModal();
}

function startAttendanceSession(index) {
    showToast(`بدأت جلسة تسجيل الحضور للمحاضرة ${index + 1}`, 'info');
}

function viewStudentDetails(studentId) {
    const student = allData.find(d => d.type === 'user' && d.__backendId === studentId);
    if (!student) return;
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">تفاصيل الطالب</h2>
            <p class="text-gray-400">معلومات الطالب وأداؤه</p>
        </div>
        
        <div class="space-y-6">
            <div class="flex items-center gap-4 p-4 rounded-xl bg-white/5">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                    <span class="text-xl font-bold">${student.name.charAt(0)}</span>
                </div>
                <div>
                    <h3 class="font-bold text-lg">${student.name}</h3>
                    <p class="text-gray-400">${student.email}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 rounded-xl bg-white/5">
                    <p class="text-gray-400 text-sm">نسبة الحضور</p>
                    <p class="text-2xl font-bold text-teal-400">${Math.floor(Math.random() * 30) + 70}%</p>
                </div>
                <div class="p-4 rounded-xl bg-white/5">
                    <p class="text-gray-400 text-sm">عدد الغيابات</p>
                    <p class="text-2xl font-bold text-orange-400">${Math.floor(Math.random() * 5)}</p>
                </div>
            </div>
            
            <div>
                <h3 class="font-medium mb-3">مقررات الطالب</h3>
                <div class="space-y-2">
                    ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'].map(course => `
                        <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                            <span>${course}</span>
                            <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                ${Math.floor(Math.random() * 30) + 70}%
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

// تحديث دالة renderStudentContent
function renderStudentContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderStudentDashboard(container);
            break;
        case 'full-schedule':
            renderStudentFullSchedule(container);
            break;
        case 'today-schedule':
            renderStudentTodaySchedule(container);
            break;
        case 'my-courses':
            renderStudentCourses(container);
            break;
        case 'my-doctors':
            renderStudentDoctors(container);
            break;
        case 'my-attendance':
            renderStudentAttendance(container);
            break;
        default:
            renderStudentDashboard(container);
    }
}

function renderStudentFullSchedule(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">الجدول الدراسي الكامل</h1>
            <p class="text-gray-400">جميع المحاضرات الأسبوعية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-7 gap-4 mb-4">
                ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                    <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                `).join('')}
            </div>
            <div class="grid grid-cols-7 gap-4">
                ${Array.from({length: 7}, (_, dayIndex) => {
                    const daySchedules = studentSchedules.filter(s => s.day === dayIndex);
                    return `
                        <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                            ${daySchedules.map(schedule => {
                                const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                                const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                                const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                                return `
                                    <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                        <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                        <div class="text-sm text-gray-400">${doctor ? doctor.name : 'غير معروف'}</div>
                                        <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function renderStudentTodaySchedule(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    const today = new Date().getDay();
    const todaySchedules = studentSchedules.filter(schedule => schedule.day === today);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">جدول اليوم</h1>
            <p class="text-gray-400">محاضرات اليوم الدراسي</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="space-y-4">
                ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                    const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                    const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                    const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                    
                    // محاكاة حالة حضور الدكتور
                    const isDoctorPresent = Math.random() > 0.2; // 80% حضور
                    
                    return `
                        <div class="p-4 rounded-xl ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${course ? course.name : 'غير معروف'}</h3>
                                    <p class="text-gray-400">${doctor ? doctor.name : 'غير معروف'}</p>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-xl">${schedule.start_time} - ${schedule.end_time}</div>
                                    <div class="text-sm text-gray-400">${room ? room.name : 'غير معروف'}</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between mt-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full ${isDoctorPresent ? 'bg-green-500 pulse-dot' : 'bg-red-500'}"></div>
                                    <span class="text-sm ${isDoctorPresent ? 'text-green-400' : 'text-red-400'}">
                                        ${isDoctorPresent ? 'الدكتور حاضر' : 'الدكتور غائب'}
                                    </span>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="confirmAttendance('${schedule.__backendId}')" class="px-4 py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                        تأكيد حضوري
                                    </button>
                                    <button onclick="viewCourseMaterials('${course ? course.__backendId : ''}')" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                        المواد الدراسية
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : `
                    <div class="text-center py-12">
                        <svg class="w-20 h-20 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <h3 class="text-xl font-medium mb-2">لا توجد محاضرات اليوم</h3>
                        <p class="text-gray-400">استمتع بيوم إجازة!</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderStudentCourses(container) {
    // مقررات الطالب بناءً على تخصصه
    const studentCourses = allData.filter(d => d.type === 'course' && d.specialization_id === currentUser.specialization_id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مقرراتي الدراسية</h1>
            <p class="text-gray-400">جميع المواد المسجلة في تخصصي</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${studentCourses.map(course => {
                const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <span class="text-2xl font-bold">${course.hours || 0}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2">${course.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${doctor ? doctor.name : 'غير معروف'}</p>
                        <div class="flex items-center justify-between text-sm mb-4">
                            <span class="text-gray-400">${course.code || 'لا يوجد رمز'}</span>
                            <span class="px-2 py-1 rounded-full ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                            </span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400">المستوى:</span>
                                <span class="font-medium">${course.level || 1}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">الساعات:</span>
                                <span class="font-medium">${course.hours || 0} ساعة</span>
                            </div>
                        </div>
                        <button onclick="viewCourseMaterials('${course.__backendId}')" class="w-full mt-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            عرض المواد الدراسية
                        </button>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function viewCourseMaterials(courseId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">المواد الدراسية</h2>
            <p class="text-gray-400">المراجع والمواد التعليمية</p>
        </div>
        
        <div class="space-y-4">
            ${Array.from({length: 3}).map((_, i) => {
                const materials = ['محاضرة الأسبوع الأول', 'واجب الهياكل', 'مرجع قواعد البيانات'];
                const types = ['PDF', 'DOC', 'PDF'];
                const dates = ['اليوم', 'أمس', 'منذ 3 أيام'];
                
                return `
                    <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium">${materials[i]}</h3>
                            <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">
                                ${types[i]}
                            </span>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">مادة تعليمية مقدمة من الدكتور</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">${dates[i]}</span>
                            <button class="px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                تحميل
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

function renderStudentDoctors(container) {
    // دكاترة الطالب بناءً على المقررات في تخصصه
    const studentCourses = allData.filter(d => d.type === 'course' && d.specialization_id === currentUser.specialization_id);
    const doctorIds = [...new Set(studentCourses.map(course => course.doctor_id))];
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor' && doctorIds.includes(d.__backendId));
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">دكاترتي</h1>
            <p class="text-gray-400">أعضاء هيئة التدريس في تخصصي</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${doctors.map(doctor => {
                const doctorCourses = studentCourses.filter(course => course.doctor_id === doctor.__backendId);
                
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                <span class="text-xl font-bold">${doctor.name.charAt(0)}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">${doctor.name}</h3>
                                <p class="text-gray-400 text-sm">${doctor.email}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="p-3 rounded-lg bg-white/5">
                                <p class="text-gray-400 text-sm mb-1">عدد المقررات</p>
                                <p class="font-medium">${doctorCourses.length} مقرر</p>
                            </div>
                            
                            <div class="p-3 rounded-lg bg-white/5">
                                <p class="text-gray-400 text-sm mb-1">التواصل</p>
                                <div class="flex gap-2">
                                    <button onclick="contactDoctor('${doctor.__backendId}')" class="flex-1 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 text-sm">
                                        إرسال رسالة
                                    </button>
                                    <button onclick="viewDoctorSchedule('${doctor.__backendId}')" class="flex-1 py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                        مواعيد المكتب
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <p class="text-gray-400 text-sm mb-2">المقررات:</p>
                            <div class="flex flex-wrap gap-1">
                                ${doctorCourses.slice(0, 3).map(course => `
                                    <span class="px-2 py-1 rounded-full text-xs bg-white/10">
                                        ${course.name}
                                    </span>
                                `).join('')}
                                ${doctorCourses.length > 3 ? `
                                    <span class="px-2 py-1 rounded-full text-xs bg-white/10">
                                        +${doctorCourses.length - 3} أكثر
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderStudentAttendance(container) {
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">سجل الحضور والغياب</h1>
            <p class="text-gray-400">متابعة حضورك في المقررات</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات الحضور</h2>
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-40 h-40 rounded-full border-8 border-teal-500/20 relative">
                            <div class="absolute inset-0 rounded-full border-8 border-teal-500" style="clip-path: polygon(0 0, 100% 0, 100% 85%, 0 85%);"></div>
                            <div class="text-center">
                                <div class="text-4xl font-bold">92%</div>
                                <div class="text-gray-400 text-sm">نسبة الحضور</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-teal-400">45</div>
                            <div class="text-gray-400 text-sm">محاضرة حضرت</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-orange-400">4</div>
                            <div class="text-gray-400 text-sm">محاضرة غبت</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-blue-400">2</div>
                            <div class="text-gray-400 text-sm">إجازة</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">تفاصيل الحضور حسب المقرر</h2>
                <div class="space-y-4">
                    ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب', 'الشبكات', 'الرياضيات'].map((course, i) => {
                        const percentages = [94, 91, 89, 87, 85];
                        const attended = [28, 26, 25, 24, 23];
                        const missed = [2, 3, 3, 4, 4];
                        
                        return `
                            <div class="p-4 rounded-xl bg-white/5">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-medium">${course}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                        ${percentages[i]}%
                                    </span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">حضرت: ${attended[i]}</span>
                                    <span class="text-gray-400">غبت: ${missed[i]}</span>
                                    <span class="text-gray-400">إجمالي: ${attended[i] + missed[i]}</span>
                                </div>
                                <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-teal-500" style="width: ${percentages[i]}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
        
        <div class="glass-card rounded-2xl p-6 mt-6">
            <h2 class="text-xl font-bold mb-4">آخر 10 محاضرات</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">المقرر</th>
                            <th class="text-right py-3 px-4">التاريخ</th>
                            <th class="text-right py-3 px-4">الوقت</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from({length: 10}).map((_, i) => {
                            const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                            const dates = ['اليوم', 'أمس', '٢٠/١٠', '١٩/١٠', '١٨/١٠'];
                            const times = ['08:00', '10:00', '14:00'];
                            const statuses = ['حاضر', 'حاضر', 'غائب', 'حاضر', 'حاضر', 'إجازة'];
                            
                            const course = courses[i % 3];
                            const date = dates[i % 5];
                            const time = times[i % 3];
                            const status = statuses[i % 6];
                            
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${course}</td>
                                    <td class="py-3 px-4">${date}</td>
                                    <td class="py-3 px-4">${time}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${
                                            status === 'حاضر' ? 'bg-green-500/20 text-green-400' : 
                                            status === 'غائب' ? 'bg-red-500/20 text-red-400' : 
                                            'bg-orange-500/20 text-orange-400'
                                        }">
                                            ${status}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function contactDoctor(doctorId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إرسال رسالة للدكتور</h2>
            <p class="text-gray-400">تواصل مع أستاذك</p>
        </div>
        <form onsubmit="sendMessage(event, '${doctorId}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الموضوع</label>
                    <input type="text" id="message-subject" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="موضوع الرسالة">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الرسالة</label>
                    <textarea id="message-content" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="5" required placeholder="اكتب رسالتك هنا..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إرسال</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

function sendMessage(e, doctorId) {
    e.preventDefault();
    showToast('تم إرسال الرسالة بنجاح', 'success');
    hideModal();
}

function viewDoctorSchedule(doctorId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">مواعيد المكتب</h2>
            <p class="text-gray-400">أوقات استقبال الدكتور</p>
        </div>
        
        <div class="space-y-4">
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الأحد</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        10:00 - 12:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
            
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الثلاثاء</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        14:00 - 16:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
            
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الخميس</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        09:00 - 11:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
        </div>
        
        <div class="mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
            <h3 class="font-medium mb-2">ملاحظات:</h3>
            <ul class="text-sm text-gray-400 space-y-1">
                <li>• يرجى الحضور في الوقت المحدد</li>
                <li>• يمكن حجز موعد مسبق عبر النظام</li>
                <li>• للاستفسارات الطارئة: 555-0123</li>
            </ul>
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

// بعد السطر 450، أضف دالة loadInitialData محدثة لتحميل بيانات إضافية
async function loadInitialData() {
    try {
        // جلب التخصصات من Firebase
        const specsSnapshot = await db.collection('specializations').get();
        const specializations = [];
        specsSnapshot.forEach(doc => {
            specializations.push({
                type: 'specialization',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المستخدمين
        const usersSnapshot = await db.collection('users').get();
        const users = [];
        usersSnapshot.forEach(doc => {
            users.push({
                type: 'user',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المجموعات
        const groupsSnapshot = await db.collection('groups').get();
        const groups = [];
        groupsSnapshot.forEach(doc => {
            groups.push({
                type: 'group',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المقررات
        const coursesSnapshot = await db.collection('courses').get();
        const courses = [];
        coursesSnapshot.forEach(doc => {
            courses.push({
                type: 'course',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب الجداول
        const schedulesSnapshot = await db.collection('schedules').get();
        const schedules = [];
        schedulesSnapshot.forEach(doc => {
            schedules.push({
                type: 'schedule',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // دمج كل البيانات
        allData = [
            ...specializations,
            ...users,
            ...groups,
            ...courses,
            ...schedules
        ];
        
        // بيانات افتراضية للقاعات إذا لم تكن موجودة
        if (!allData.some(d => d.type === 'room')) {
            const defaultRooms = [
                { type: 'room', __backendId: 'room1', name: 'قاعة 101', type: 'lecture', capacity: 50, location: 'المبنى الرئيسي', status: 'available' },
                { type: 'room', __backendId: 'room2', name: 'قاعة 203', type: 'lecture', capacity: 40, location: 'المبنى الرئيسي', status: 'available' },
                { type: 'room', __backendId: 'room3', name: 'معمل 105', type: 'lab', capacity: 30, location: 'مبنى المعامل', equipment: 'حواسيب', status: 'available' },
                { type: 'room', __backendId: 'room4', name: 'قاعة 301', type: 'lecture', capacity: 60, location: 'المبنى الجديد', status: 'available' },
                { type: 'room', __backendId: 'room5', name: 'معمل 205', type: 'lab', capacity: 25, location: 'مبنى المعامل', equipment: 'أجهزة شبكات', status: 'maintenance' }
            ];
            allData.push(...defaultRooms);
        }
        
        updateUI();
        
    } catch (error) {
        console.error("Error loading initial data:", error);
    }
}

// بعد السطر 950، أضف دالة editSpecialization
async function editSpecialization(id) {
    const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === id);
    if (!specialization) return;
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">تعديل التخصص</h2>
            <p class="text-gray-400">تعديل بيانات التخصص</p>
        </div>
        <form onsubmit="updateSpecialization(event, '${id}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="edit-spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" value="${specialization.name}" required>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">حفظ التغييرات</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function updateSpecialization(e, id) {
    e.preventDefault();
    const name = document.getElementById('edit-spec-name').value;
    
    try {
        await db.collection('specializations').doc(id).update({
            name: name,
            updated_at: new Date().toISOString()
        });
        
        showToast('تم تحديث التخصص بنجاح');
        hideModal();
        
        // تحديث البيانات المحلية
        const index = allData.findIndex(d => d.type === 'specialization' && d.__backendId === id);
        if (index !== -1) {
            allData[index].name = name;
        }
        
        updateUI();
    } catch (error) {
        console.error("Error updating specialization:", error);
        showToast('فشل في تحديث التخصص', 'error');
    }
}// بعد سطر 1070، أضف الكود التالي:

// إدارة الدكاترة (للعمادة)
function renderAdminDoctors(container) {
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة الدكاترة</h1>
                <button onclick="showAddDoctorModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة دكتور
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة أعضاء هيئة التدريس</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">الاسم</th>
                            <th class="text-right py-3 px-4">البريد الإلكتروني</th>
                            <th class="text-right py-3 px-4">الهاتف</th>
                            <th class="text-right py-3 px-4">عدد المقررات</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${doctors.map(doctor => {
                            const courses = allData.filter(d => d.type === 'course' && d.doctor_id === doctor.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${doctor.name}</td>
                                    <td class="py-3 px-4">${doctor.email}</td>
                                    <td class="py-3 px-4">${doctor.phone || 'غير محدد'}</td>
                                    <td class="py-3 px-4">${courses}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">نشط</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editDoctor('${doctor.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteDoctor('${doctor.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddDoctorModal() {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة دكتور جديد</h2>
            <p class="text-gray-400">أدخل بيانات الدكتور الجديد</p>
        </div>
        <form onsubmit="addDoctor(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الاسم الكامل</label>
                    <input type="text" id="doctor-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                    <input type="email" id="doctor-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">رقم الهاتف</label>
                    <input type="tel" id="doctor-phone" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">كلمة المرور الافتراضية</label>
                    <input type="text" id="doctor-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" value="doctor123" readonly>
                    <p class="text-xs text-gray-400 mt-1">سيتم تغييرها عند أول دخول</p>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addDoctor(e) {
    e.preventDefault();
    const name = document.getElementById('doctor-name').value;
    const email = document.getElementById('doctor-email').value;
    const phone = document.getElementById('doctor-phone').value;
    const password = document.getElementById('doctor-password').value;

    try {
        // إنشاء حساب في Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // حفظ بيانات الدكتور في Firestore
        await db.collection('users').doc(user.uid).set({
            name: name,
            email: email,
            phone: phone || '',
            role: 'doctor',
            status: 'active',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة الدكتور بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'user',
            __backendId: user.uid,
            name: name,
            email: email,
            phone: phone || '',
            role: 'doctor',
            status: 'active'
        });

        updateUI();
    } catch (error) {
        console.error("Error adding doctor:", error);
        showToast('فشل في إضافة الدكتور', 'error');
    }
}

async function deleteDoctor(id) {
    if (!confirm('هل أنت متأكد من حذف هذا الدكتور؟')) return;
    
    try {
        // حذف من Firestore
        await db.collection('users').doc(id).delete();
        
        // حذف من Authentication (يتطلب صلاحيات إدارية في Firebase)
        // Note: هذا الجزء يتطلب صلاحيات خاصة في Firebase
        
        showToast('تم حذف الدكتور');
        
        // تحديث البيانات المحلية
        allData = allData.filter(d => !(d.type === 'user' && d.__backendId === id && d.role === 'doctor'));
        updateUI();
    } catch (error) {
        console.error("Error deleting doctor:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة المقررات (للعمادة)
function renderAdminCourses(container) {
    const courses = allData.filter(d => d.type === 'course');
    const specializations = allData.filter(d => d.type === 'specialization');
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة المقررات</h1>
                <button onclick="showAddCourseModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة مقرر
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة المواد الدراسية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">رمز المقرر</th>
                            <th class="text-right py-3 px-4">اسم المقرر</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">الدكتور</th>
                            <th class="text-right py-3 px-4">الساعات</th>
                            <th class="text-right py-3 px-4">النوع</th>
                            <th class="text-right py-3 px-4">المستوى</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${courses.map(course => {
                            const specialization = specializations.find(s => s.__backendId === course.specialization_id);
                            const doctor = doctors.find(d => d.__backendId === course.doctor_id);
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4 font-mono">${course.code || 'غير محدد'}</td>
                                    <td class="py-3 px-4">${course.name}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${doctor ? doctor.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${course.hours || 0}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                            ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">${course.level || 1}</td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editCourse('${course.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteCourse('${course.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddCourseModal() {
    const specializations = allData.filter(d => d.type === 'specialization');
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة مقرر جديد</h2>
            <p class="text-gray-400">أدخل بيانات المقرر الجديد</p>
        </div>
        <form onsubmit="addCourse(event)">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">رمز المقرر</label>
                        <input type="text" id="course-code" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">اسم المقرر</label>
                        <input type="text" id="course-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="course-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر التخصص</option>
                            ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">الدكتور</label>
                        <select id="course-doctor" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر الدكتور</option>
                            ${doctors.map(d => `<option value="${d.__backendId}">${d.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">عدد الساعات</label>
                        <input type="number" id="course-hours" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" min="1" max="10" value="3" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المستوى</label>
                        <select id="course-level" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">المستوى ${l}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع المقرر</label>
                        <select id="course-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="theoretical">نظري</option>
                            <option value="practical">عملي</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الوصف</label>
                    <textarea id="course-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addCourse(e) {
    e.preventDefault();
    const code = document.getElementById('course-code').value;
    const name = document.getElementById('course-name').value;
    const specialization_id = document.getElementById('course-specialization').value;
    const doctor_id = document.getElementById('course-doctor').value;
    const hours = document.getElementById('course-hours').value;
    const level = document.getElementById('course-level').value;
    const course_type = document.getElementById('course-type').value;
    const description = document.getElementById('course-description').value;

    try {
        const docRef = await db.collection('courses').add({
            code: code,
            name: name,
            specialization_id: specialization_id,
            doctor_id: doctor_id,
            hours: parseInt(hours),
            level: parseInt(level),
            course_type: course_type,
            description: description || '',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المقرر بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'course',
            __backendId: docRef.id,
            code: code,
            name: name,
            specialization_id: specialization_id,
            doctor_id: doctor_id,
            hours: parseInt(hours),
            level: parseInt(level),
            course_type: course_type,
            description: description || ''
        });

        updateUI();
    } catch (error) {
        console.error("Error adding course:", error);
        showToast('فشل في إضافة المقرر', 'error');
    }
}

async function deleteCourse(id) {
    if (!confirm('هل أنت متأكد من حذف هذا المقرر؟')) return;
    
    try {
        await db.collection('courses').doc(id).delete();
        showToast('تم حذف المقرر');
        
        allData = allData.filter(d => !(d.type === 'course' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting course:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة الجداول (للعمادة)
function renderAdminSchedules(container) {
    const schedules = allData.filter(d => d.type === 'schedule');
    const courses = allData.filter(d => d.type === 'course');
    const groups = allData.filter(d => d.type === 'group');
    const rooms = allData.filter(d => d.type === 'room');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة الجداول</h1>
                <button onclick="showAddScheduleModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة محاضرة
                </button>
            </div>
            <p class="text-gray-400 mt-2">جدولة المحاضرات النظرية والعملية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-7 gap-4 mb-4">
                ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                    <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                `).join('')}
            </div>
            <div class="grid grid-cols-7 gap-4">
                ${Array.from({length: 7}, (_, dayIndex) => {
                    const daySchedules = schedules.filter(s => s.day === dayIndex);
                    return `
                        <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                            ${daySchedules.map(schedule => {
                                const course = courses.find(c => c.__backendId === schedule.course_id);
                                const group = groups.find(g => g.__backendId === schedule.group_id);
                                const room = rooms.find(r => r.__backendId === schedule.room_id);
                                return `
                                    <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                        <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                        <div class="text-sm text-gray-400">${group ? group.name : 'غير معروف'}</div>
                                        <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                        <div class="flex gap-1 mt-2">
                                            <button onclick="editSchedule('${schedule.__backendId}')" class="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteSchedule('${schedule.__backendId}')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function showAddScheduleModal() {
    const courses = allData.filter(d => d.type === 'course');
    const groups = allData.filter(d => d.type === 'group');
    const rooms = allData.filter(d => d.type === 'room');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة محاضرة جديدة</h2>
            <p class="text-gray-400">جدولة محاضرة في الجدول</p>
        </div>
        <form onsubmit="addSchedule(event)">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المقرر</label>
                        <select id="schedule-course" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر المقرر</option>
                            ${courses.map(c => `<option value="${c.__backendId}">${c.code} - ${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">المجموعة</label>
                        <select id="schedule-group" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر المجموعة</option>
                            ${groups.map(g => `<option value="${g.__backendId}">${g.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">اليوم</label>
                        <select id="schedule-day" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="0">الأحد</option>
                            <option value="1">الاثنين</option>
                            <option value="2">الثلاثاء</option>
                            <option value="3">الأربعاء</option>
                            <option value="4">الخميس</option>
                            <option value="5">الجمعة</option>
                            <option value="6">السبت</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">القاعة</label>
                        <select id="schedule-room" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر القاعة</option>
                            ${rooms.map(r => `<option value="${r.__backendId}">${r.name} (${r.type === 'lecture' ? 'قاعة' : 'معمل'})</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">وقت البداية</label>
                        <input type="time" id="schedule-start" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required value="08:00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">وقت النهاية</label>
                        <input type="time" id="schedule-end" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required value="10:00">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">نوع المحاضرة</label>
                    <select id="schedule-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                        <option value="theoretical">نظري</option>
                        <option value="practical">عملي</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addSchedule(e) {
    e.preventDefault();
    const course_id = document.getElementById('schedule-course').value;
    const group_id = document.getElementById('schedule-group').value;
    const day = parseInt(document.getElementById('schedule-day').value);
    const room_id = document.getElementById('schedule-room').value;
    const start_time = document.getElementById('schedule-start').value;
    const end_time = document.getElementById('schedule-end').value;
    const type = document.getElementById('schedule-type').value;

    try {
        const docRef = await db.collection('schedules').add({
            course_id: course_id,
            group_id: group_id,
            day: day,
            room_id: room_id,
            start_time: start_time,
            end_time: end_time,
            type: type,
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المحاضرة بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'schedule',
            __backendId: docRef.id,
            course_id: course_id,
            group_id: group_id,
            day: day,
            room_id: room_id,
            start_time: start_time,
            end_time: end_time,
            type: type
        });

        updateUI();
    } catch (error) {
        console.error("Error adding schedule:", error);
        showToast('فشل في إضافة المحاضرة', 'error');
    }
}

async function deleteSchedule(id) {
    if (!confirm('هل أنت متأكد من حذف هذه المحاضرة؟')) return;
    
    try {
        await db.collection('schedules').doc(id).delete();
        showToast('تم حذف المحاضرة');
        
        allData = allData.filter(d => !(d.type === 'schedule' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting schedule:", error);
        showToast('فشل في الحذف', 'error');
    }
}

// إدارة المجموعات (للعمادة)
function renderAdminGroups(container) {
    const groups = allData.filter(d => d.type === 'group');
    const specializations = allData.filter(d => d.type === 'specialization');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة المجموعات</h1>
                <button onclick="showAddGroupModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة مجموعة
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة مجموعات الطلاب</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم المجموعة</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">عدد الطلاب</th>
                            <th class="text-right py-3 px-4">السعة</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groups.map(group => {
                            const specialization = specializations.find(s => s.__backendId === group.specialization_id);
                            const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.group_id === group.__backendId).length;
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${group.name}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${students}</td>
                                    <td class="py-3 px-4">${group.capacity || 30}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${students < (group.capacity || 30) ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                            ${students < (group.capacity || 30) ? 'متاحة' : 'ممتلئة'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="flex gap-2">
                                            <button onclick="editGroup('${group.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                تعديل
                                            </button>
                                            <button onclick="deleteGroup('${group.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function showAddGroupModal() {
    const specializations = allData.filter(d => d.type === 'specialization');
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة مجموعة جديدة</h2>
            <p class="text-gray-400">أدخل بيانات المجموعة الجديدة</p>
        </div>
        <form onsubmit="addGroup(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم المجموعة</label>
                    <input type="text" id="group-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: المجموعة أ">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="group-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required>
                            <option value="">اختر التخصص</option>
                            ${specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">السعة</label>
                        <input type="number" id="group-capacity" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" min="1" max="100" value="30" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الوصف</label>
                    <textarea id="group-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="2" placeholder="وصف المجموعة..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addGroup(e) {
    e.preventDefault();
    const name = document.getElementById('group-name').value;
    const specialization_id = document.getElementById('group-specialization').value;
    const capacity = document.getElementById('group-capacity').value;
    const description = document.getElementById('group-description').value;

    try {
        const docRef = await db.collection('groups').add({
            name: name,
            specialization_id: specialization_id,
            capacity: parseInt(capacity),
            description: description || '',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة المجموعة بنجاح');
        hideModal();

        // تحديث البيانات المحلية
        allData.push({
            type: 'group',
            __backendId: docRef.id,
            name: name,
            specialization_id: specialization_id,
            capacity: parseInt(capacity),
            description: description || ''
        });

        updateUI();
    } catch (error) {
        console.error("Error adding group:", error);
        showToast('فشل في إضافة المجموعة', 'error');
    }
}

// إدارة القاعات (للعمادة)
function renderAdminRooms(container) {
    const rooms = allData.filter(d => d.type === 'room');
    
    container.innerHTML = `
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">إدارة القاعات</h1>
                <button onclick="showAddRoomModal()" class="btn-primary px-6 py-3 rounded-xl font-medium">
                    إضافة قاعة
                </button>
            </div>
            <p class="text-gray-400 mt-2">إدارة القاعات والمعامل</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم القاعة</th>
                            <th class="text-right py-3 px-4">النوع</th>
                            <th class="text-right py-3 px-4">السعة</th>
                            <th class="text-right py-3 px-4">الموقع</th>
                            <th class="text-right py-3 px-4">المعدات</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rooms.map(room => `
                            <tr class="border-b border-white/5 hover:bg-white/5">
                                <td class="py-3 px-4">${room.name}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${room.type === 'lecture' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                        ${room.type === 'lecture' ? 'قاعة محاضرات' : 'معمل'}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${room.capacity}</td>
                                <td class="py-3 px-4">${room.location || 'غير محدد'}</td>
                                <td class="py-3 px-4">${room.equipment || 'لا يوجد'}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs ${room.status === 'available' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                        ${room.status === 'available' ? 'متاحة' : 'غير متاحة'}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <button onclick="editRoom('${room.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                            تعديل
                                        </button>
                                        <button onclick="deleteRoom('${room.__backendId}')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                            حذف
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// واجهة الدكتور
function renderDoctorDashboard(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const doctorSchedules = allData.filter(d => d.type === 'schedule');
    const today = new Date().getDay(); // 0-6 where 0 is Sunday
    
    const todaySchedules = doctorSchedules.filter(schedule => {
        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
        return course && course.doctor_id === currentUser.id && schedule.day === today;
    });

    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مرحباً دكتور ${currentUser.name}</h1>
            <p class="text-gray-400">لوحة تحكم الدكتور</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${doctorCourses.length}</span>
                </div>
                <h3 class="font-semibold text-lg">المقررات</h3>
                <p class="text-gray-400 text-sm">المواد المسندة إليك</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${todaySchedules.length}</span>
                </div>
                <h3 class="font-semibold text-lg">محاضرات اليوم</h3>
                <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">85%</span>
                </div>
                <h3 class="font-semibold text-lg">نسبة الحضور</h3>
                <p class="text-gray-400 text-sm">متوسط حضور الطلاب</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">محاضرات اليوم</h2>
                <div class="space-y-3">
                    ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                        const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                        const group = allData.find(g => g.type === 'group' && g.__backendId === schedule.group_id);
                        
                        return `
                            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course ? course.name : 'غير معروف'}</h3>
                                        <p class="text-sm text-gray-400">${group ? group.name : 'غير معروف'} - ${room ? room.name : 'غير معروف'}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-medium">${schedule.start_time} - ${schedule.end_time}</div>
                                        <button onclick="takeAttendance('${schedule.__backendId}')" class="mt-2 px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                            تسجيل حضور
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>لا توجد محاضرات اليوم</p>
                        </div>
                    `}
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">أحدث المقررات</h2>
                <div class="space-y-3">
                    ${doctorCourses.slice(0, 3).map(course => {
                        const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === course.specialization_id);
                        const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === course.specialization_id).length;
                        
                        return `
                            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course.name}</h3>
                                        <p class="text-sm text-gray-400">${specialization ? specialization.name : ''} - ${course.code}</p>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">
                                        ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between mt-3 text-sm">
                                    <span class="text-gray-400">${students} طالب</span>
                                    <span class="text-gray-400">${course.hours} ساعة</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
}

// واجهة الطالب
function renderStudentDashboard(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    const today = new Date().getDay();
    const todaySchedules = studentSchedules.filter(schedule => schedule.day === today);
    const studentCourses = allData.filter(d => d.type === 'course');
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مرحباً ${currentUser.name}</h1>
            <p class="text-gray-400">لوحة تحكم الطالب</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${todaySchedules.length}</span>
                </div>
                <h3 class="font-semibold text-lg">محاضرات اليوم</h3>
                <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">${studentCourses.length}</span>
                </div>
                <h3 class="font-semibold text-lg">المقررات</h3>
                <p class="text-gray-400 text-sm">المواد المسجلة</p>
            </div>
            
            <div class="glass-card rounded-2xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                    </div>
                    <span class="text-3xl font-bold">92%</span>
                </div>
                <h3 class="font-semibold text-lg">نسبة الحضور</h3>
                <p class="text-gray-400 text-sm">حضورك الشخصي</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">جدول اليوم</h2>
                <div class="space-y-3">
                    ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                        const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                        const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                        
                        return `
                            <div class="p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-medium">${course ? course.name : 'غير معروف'}</h3>
                                        <p class="text-sm text-gray-400">${doctor ? doctor.name : 'غير معروف'}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-medium">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-sm text-gray-400">${room ? room.name : 'غير معروف'}</div>
                                    </div>
                                </div>
                                <div class="mt-3 flex items-center justify-between text-sm">
                                    <span class="px-2 py-1 rounded-full ${schedule.type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                        ${schedule.type === 'theoretical' ? 'نظري' : 'عملي'}
                                    </span>
                                    <button onclick="confirmAttendance('${schedule.__backendId}')" class="px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                        تأكيد الحضور
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : `
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>لا توجد محاضرات اليوم</p>
                        </div>
                    `}
                </div>
            </div>
            
            <div class="glasscard rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">معلومات التخصص</h2>
                ${(() => {
                    const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === currentUser.specialization_id);
                    const group = allData.find(g => g.type === 'group' && g.__backendId === currentUser.group_id);
                    
                    if (specialization) {
                        return `
                            <div class="space-y-4">
                                <div class="p-4 rounded-lg bg-white/5">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="font-medium">${specialization.name}</h3>
                                            <p class="text-sm text-gray-400">تخصصك الأكاديمي</p>
                                        </div>
                                    </div>
                                </div>
                                
                                ${group ? `
                                    <div class="p-4 rounded-lg bg-white/5">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="font-medium">${group.name}</h3>
                                                <p class="text-sm text-gray-400">مجموعتك الدراسية</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    return '<p class="text-gray-400">لا توجد معلومات متاحة</p>';
                })()}
            </div>
        </div>
    `;
}

// وظائف مساعدة
function takeAttendance(scheduleId) {
    showToast('تم فتح صفحة تسجيل الحضور', 'info');
    // هنا يمكن تنفيذ منطق تسجيل الحضور
}

function confirmAttendance(scheduleId) {
    showToast('تم تأكيد حضورك', 'success');
}

// تحديث دالة renderAdminContent
function renderAdminContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderAdminDashboard(container);
            break;
        case 'specializations':
            renderAdminSpecializations(container);
            break;
        case 'doctors':
            renderAdminDoctors(container);
            break;
        case 'courses':
            renderAdminCourses(container);
            break;
        case 'schedules':
            renderAdminSchedules(container);
            break;
        case 'groups':
            renderAdminGroups(container);
            break;
        case 'rooms':
            renderAdminRooms(container);
            break;
        case 'reports':
            renderAdminReports(container);
            break;
        default:
            renderAdminDashboard(container);
    }
}

function renderAdminReports(container) {
    const specializations = allData.filter(d => d.type === 'specialization').length;
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor').length;
    const students = allData.filter(d => d.type === 'user' && d.role === 'student').length;
    const courses = allData.filter(d => d.type === 'course').length;
    const schedules = allData.filter(d => d.type === 'schedule').length;
    const groups = allData.filter(d => d.type === 'group').length;
    const rooms = allData.filter(d => d.type === 'room').length;
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">التقارير والإحصائيات</h1>
            <p class="text-gray-400">إحصائيات شاملة عن النظام</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات النظام</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد التخصصات</span>
                        <span class="font-bold">${specializations}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد الدكاترة</span>
                        <span class="font-bold">${doctors}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد الطلاب</span>
                        <span class="font-bold">${students}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المقررات</span>
                        <span class="font-bold">${courses}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المجموعات</span>
                        <span class="font-bold">${groups}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد القاعات</span>
                        <span class="font-bold">${rooms}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                        <span>عدد المحاضرات</span>
                        <span class="font-bold">${schedules}</span>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">تقارير الحضور</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور العامة</span>
                            <span>85%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-teal-500" style="width: 85%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور النظرية</span>
                            <span>88%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500" style="width: 88%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>نسبة الحضور العملية</span>
                            <span>82%</span>
                        </div>
                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-orange-500" style="width: 82%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="font-medium mb-3">أعلى 5 مقررات حضوراً</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>هياكل البيانات</span>
                            <span class="text-teal-400">94%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>قواعد البيانات</span>
                            <span class="text-teal-400">91%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>برمجة الويب</span>
                            <span class="text-teal-400">89%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>الشبكات</span>
                            <span class="text-teal-400">87%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                            <span>الرياضيات</span>
                            <span class="text-teal-400">85%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// تحديث دالة renderDoctorContent
function renderDoctorContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderDoctorDashboard(container);
            break;
        case 'my-schedule':
            renderDoctorSchedule(container);
            break;
        case 'my-courses':
            renderDoctorCourses(container);
            break;
        case 'my-students':
            renderDoctorStudents(container);
            break;
        case 'attendance':
            renderDoctorAttendance(container);
            break;
        default:
            renderDoctorDashboard(container);
    }
}

function renderDoctorSchedule(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const schedules = allData.filter(d => d.type === 'schedule');
    const doctorSchedules = schedules.filter(schedule => {
        const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
        return course && course.doctor_id === currentUser.id;
    });
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">جدولي الأسبوعي</h1>
            <p class="text-gray-400">محاضراتي المجدولة لهذا الأسبوع</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-7 gap-4 mb-4">
                ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                    <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                `).join('')}
            </div>
            <div class="grid grid-cols-7 gap-4">
                ${Array.from({length: 7}, (_, dayIndex) => {
                    const daySchedules = doctorSchedules.filter(s => s.day === dayIndex);
                    return `
                        <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                            ${daySchedules.map(schedule => {
                                const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                                const group = allData.find(g => g.type === 'group' && g.__backendId === schedule.group_id);
                                const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                                return `
                                    <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                        <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                        <div class="text-sm text-gray-400">${group ? group.name : 'غير معروف'}</div>
                                        <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                        <button onclick="takeAttendance('${schedule.__backendId}')" class="w-full mt-2 px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                            تسجيل حضور
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function renderDoctorCourses(container) {
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">المقررات المسندة إلي</h1>
            <p class="text-gray-400">جميع المواد التي أقوم بتدريسها</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${doctorCourses.map(course => {
                const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === course.specialization_id);
                const students = allData.filter(d => d.type === 'user' && d.role === 'student' && d.specialization_id === course.specialization_id).length;
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <span class="text-2xl font-bold">${course.hours || 0}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2">${course.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${specialization ? specialization.name : ''}</p>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">${course.code || 'لا يوجد رمز'}</span>
                            <span class="px-2 py-1 rounded-full ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                            </span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400">عدد الطلاب:</span>
                                <span class="font-medium">${students}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">المستوى:</span>
                                <span class="font-medium">${course.level || 1}</span>
                            </div>
                        </div>
                        <button onclick="uploadCourseMaterial('${course.__backendId}')" class="w-full mt-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            رفع مواد دراسية
                        </button>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderDoctorStudents(container) {
    // طلاب الدكتور بناءً على المقررات التي يدرسها
    const doctorCourses = allData.filter(d => d.type === 'course' && d.doctor_id === currentUser.id);
    const students = allData.filter(d => d.type === 'user' && d.role === 'student');
    
    // تجميع الطلاب الذين يدرسون مقررات هذا الدكتور
    const doctorStudents = students.filter(student => {
        // التحقق إذا كان الطالب في تخصص يدرس فيه الدكتور مقرراً
        return doctorCourses.some(course => course.specialization_id === student.specialization_id);
    });
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">قائمة الطلاب</h1>
            <p class="text-gray-400">طلابي في المقررات المختلفة</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">اسم الطالب</th>
                            <th class="text-right py-3 px-4">البريد الإلكتروني</th>
                            <th class="text-right py-3 px-4">التخصص</th>
                            <th class="text-right py-3 px-4">المجموعة</th>
                            <th class="text-right py-3 px-4">نسبة الحضور</th>
                            <th class="text-right py-3 px-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${doctorStudents.map(student => {
                            const specialization = allData.find(s => s.type === 'specialization' && s.__backendId === student.specialization_id);
                            const group = allData.find(g => g.type === 'group' && g.__backendId === student.group_id);
                            
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${student.name}</td>
                                    <td class="py-3 px-4">${student.email}</td>
                                    <td class="py-3 px-4">${specialization ? specialization.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">${group ? group.name : 'غير معروف'}</td>
                                    <td class="py-3 px-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div class="h-full bg-teal-500" style="width: ${Math.floor(Math.random() * 30) + 70}%"></div>
                                            </div>
                                            <span>${Math.floor(Math.random() * 30) + 70}%</span>
                                        </div>
                                    </td>
                                    <td class="py-3 px-4">
                                        <button onclick="viewStudentDetails('${student.__backendId}')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                            عرض التفاصيل
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderDoctorAttendance(container) {
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">نظام الحضور والغياب</h1>
            <p class="text-gray-400">تسجيل حضور طلابك</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">المحاضرات القادمة</h2>
                <div class="space-y-3">
                    ${Array.from({length: 3}).map((_, i) => {
                        const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                        const times = ['08:00 - 10:00', '10:00 - 12:00', '14:00 - 16:00'];
                        const rooms = ['قاعة 101', 'معمل 203', 'قاعة 305'];
                        
                        return `
                            <div class="p-4 rounded-lg bg-white/5 border border-white/10">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-medium">${courses[i]}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                        ${times[i]}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-400 mb-3">${rooms[i]}</p>
                                <button onclick="startAttendanceSession(${i})" class="w-full py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                    بدء تسجيل الحضور
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات الحضور</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-medium mb-2">نسبة الحضور حسب المقرر</h3>
                        <div class="space-y-3">
                            ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب', 'الشبكات', 'الرياضيات'].map((course, i) => {
                                const percentage = [94, 91, 89, 87, 85][i];
                                return `
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm">${course}</span>
                                            <span class="text-sm">${percentage}%</span>
                                        </div>
                                        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-teal-500" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">آخر تسجيلات الحضور</h3>
                        <div class="space-y-2">
                            ${['اليوم 08:00', 'أمس 14:00', '٢٠/١٠ 10:00'].map((time, i) => {
                                const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                                return `
                                    <div class="flex justify-between items-center p-2 rounded-lg bg-white/5">
                                        <span>${courses[i]}</span>
                                        <span class="text-sm text-gray-400">${time}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function uploadCourseMaterial(courseId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">رفع مواد دراسية</h2>
            <p class="text-gray-400">أرفع المواد التعليمية للطلاب</p>
        </div>
        <form onsubmit="handleMaterialUpload(event, '${courseId}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">عنوان المادة</label>
                    <input type="text" id="material-title" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: محاضرة الأسبوع الأول">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف المادة</label>
                    <textarea id="material-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3" placeholder="وصف مختصر للمادة..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">نوع المادة</label>
                    <select id="material-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                        <option value="lecture">محاضرة</option>
                        <option value="assignment">واجب</option>
                        <option value="exam">امتحان</option>
                        <option value="resource">مرجع</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">رفع ملف</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-gray-400 mb-2">اسحب وأفلت الملف هنا أو</p>
                        <input type="file" id="material-file" class="hidden" accept=".pdf,.doc,.docx,.ppt,.pptx">
                        <label for="material-file" class="cursor-pointer px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            اختر ملف
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">رفع</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

function handleMaterialUpload(e, courseId) {
    e.preventDefault();
    showToast('تم رفع المادة الدراسية بنجاح', 'success');
    hideModal();
}

function startAttendanceSession(index) {
    showToast(`بدأت جلسة تسجيل الحضور للمحاضرة ${index + 1}`, 'info');
}

function viewStudentDetails(studentId) {
    const student = allData.find(d => d.type === 'user' && d.__backendId === studentId);
    if (!student) return;
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">تفاصيل الطالب</h2>
            <p class="text-gray-400">معلومات الطالب وأداؤه</p>
        </div>
        
        <div class="space-y-6">
            <div class="flex items-center gap-4 p-4 rounded-xl bg-white/5">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                    <span class="text-xl font-bold">${student.name.charAt(0)}</span>
                </div>
                <div>
                    <h3 class="font-bold text-lg">${student.name}</h3>
                    <p class="text-gray-400">${student.email}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 rounded-xl bg-white/5">
                    <p class="text-gray-400 text-sm">نسبة الحضور</p>
                    <p class="text-2xl font-bold text-teal-400">${Math.floor(Math.random() * 30) + 70}%</p>
                </div>
                <div class="p-4 rounded-xl bg-white/5">
                    <p class="text-gray-400 text-sm">عدد الغيابات</p>
                    <p class="text-2xl font-bold text-orange-400">${Math.floor(Math.random() * 5)}</p>
                </div>
            </div>
            
            <div>
                <h3 class="font-medium mb-3">مقررات الطالب</h3>
                <div class="space-y-2">
                    ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'].map(course => `
                        <div class="flex justify-between items-center p-3 rounded-lg bg-white/5">
                            <span>${course}</span>
                            <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                ${Math.floor(Math.random() * 30) + 70}%
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

// تحديث دالة renderStudentContent
function renderStudentContent(container) {
    switch(currentView) {
        case 'dashboard':
            renderStudentDashboard(container);
            break;
        case 'full-schedule':
            renderStudentFullSchedule(container);
            break;
        case 'today-schedule':
            renderStudentTodaySchedule(container);
            break;
        case 'my-courses':
            renderStudentCourses(container);
            break;
        case 'my-doctors':
            renderStudentDoctors(container);
            break;
        case 'my-attendance':
            renderStudentAttendance(container);
            break;
        default:
            renderStudentDashboard(container);
    }
}

function renderStudentFullSchedule(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">الجدول الدراسي الكامل</h1>
            <p class="text-gray-400">جميع المحاضرات الأسبوعية</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="grid grid-cols-7 gap-4 mb-4">
                ${['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(day => `
                    <div class="text-center py-2 font-medium border-b border-teal-500/30">${day}</div>
                `).join('')}
            </div>
            <div class="grid grid-cols-7 gap-4">
                ${Array.from({length: 7}, (_, dayIndex) => {
                    const daySchedules = studentSchedules.filter(s => s.day === dayIndex);
                    return `
                        <div class="min-h-[200px] schedule-cell rounded-xl p-3">
                            ${daySchedules.map(schedule => {
                                const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                                const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                                const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                                return `
                                    <div class="lecture-card mb-2 p-3 rounded-lg ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                                        <div class="font-medium">${course ? course.name : 'غير معروف'}</div>
                                        <div class="text-sm text-gray-400">${doctor ? doctor.name : 'غير معروف'}</div>
                                        <div class="text-xs text-gray-500 mt-1">${schedule.start_time} - ${schedule.end_time}</div>
                                        <div class="text-xs text-gray-500">${room ? room.name : 'غير معروف'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function renderStudentTodaySchedule(container) {
    const studentSchedules = allData.filter(d => d.type === 'schedule' && d.group_id === currentUser.group_id);
    const today = new Date().getDay();
    const todaySchedules = studentSchedules.filter(schedule => schedule.day === today);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">جدول اليوم</h1>
            <p class="text-gray-400">محاضرات اليوم الدراسي</p>
        </div>
        
        <div class="glass-card rounded-2xl p-6">
            <div class="space-y-4">
                ${todaySchedules.length > 0 ? todaySchedules.map(schedule => {
                    const course = allData.find(c => c.type === 'course' && c.__backendId === schedule.course_id);
                    const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                    const room = allData.find(r => r.type === 'room' && r.__backendId === schedule.room_id);
                    
                    // محاكاة حالة حضور الدكتور
                    const isDoctorPresent = Math.random() > 0.2; // 80% حضور
                    
                    return `
                        <div class="p-4 rounded-xl ${schedule.type === 'theoretical' ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-orange-500/10 border border-orange-500/20'}">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${course ? course.name : 'غير معروف'}</h3>
                                    <p class="text-gray-400">${doctor ? doctor.name : 'غير معروف'}</p>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-xl">${schedule.start_time} - ${schedule.end_time}</div>
                                    <div class="text-sm text-gray-400">${room ? room.name : 'غير معروف'}</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between mt-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full ${isDoctorPresent ? 'bg-green-500 pulse-dot' : 'bg-red-500'}"></div>
                                    <span class="text-sm ${isDoctorPresent ? 'text-green-400' : 'text-red-400'}">
                                        ${isDoctorPresent ? 'الدكتور حاضر' : 'الدكتور غائب'}
                                    </span>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="confirmAttendance('${schedule.__backendId}')" class="px-4 py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                        تأكيد حضوري
                                    </button>
                                    <button onclick="viewCourseMaterials('${course ? course.__backendId : ''}')" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                        المواد الدراسية
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : `
                    <div class="text-center py-12">
                        <svg class="w-20 h-20 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <h3 class="text-xl font-medium mb-2">لا توجد محاضرات اليوم</h3>
                        <p class="text-gray-400">استمتع بيوم إجازة!</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderStudentCourses(container) {
    // مقررات الطالب بناءً على تخصصه
    const studentCourses = allData.filter(d => d.type === 'course' && d.specialization_id === currentUser.specialization_id);
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">مقرراتي الدراسية</h1>
            <p class="text-gray-400">جميع المواد المسجلة في تخصصي</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${studentCourses.map(course => {
                const doctor = allData.find(d => d.type === 'user' && d.role === 'doctor' && d.__backendId === course.doctor_id);
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <span class="text-2xl font-bold">${course.hours || 0}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2">${course.name}</h3>
                        <p class="text-gray-400 text-sm mb-4">${doctor ? doctor.name : 'غير معروف'}</p>
                        <div class="flex items-center justify-between text-sm mb-4">
                            <span class="text-gray-400">${course.code || 'لا يوجد رمز'}</span>
                            <span class="px-2 py-1 rounded-full ${course.course_type === 'theoretical' ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'}">
                                ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                            </span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400">المستوى:</span>
                                <span class="font-medium">${course.level || 1}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400">الساعات:</span>
                                <span class="font-medium">${course.hours || 0} ساعة</span>
                            </div>
                        </div>
                        <button onclick="viewCourseMaterials('${course.__backendId}')" class="w-full mt-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
                            عرض المواد الدراسية
                        </button>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function viewCourseMaterials(courseId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">المواد الدراسية</h2>
            <p class="text-gray-400">المراجع والمواد التعليمية</p>
        </div>
        
        <div class="space-y-4">
            ${Array.from({length: 3}).map((_, i) => {
                const materials = ['محاضرة الأسبوع الأول', 'واجب الهياكل', 'مرجع قواعد البيانات'];
                const types = ['PDF', 'DOC', 'PDF'];
                const dates = ['اليوم', 'أمس', 'منذ 3 أيام'];
                
                return `
                    <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium">${materials[i]}</h3>
                            <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">
                                ${types[i]}
                            </span>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">مادة تعليمية مقدمة من الدكتور</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">${dates[i]}</span>
                            <button class="px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30">
                                تحميل
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

function renderStudentDoctors(container) {
    // دكاترة الطالب بناءً على المقررات في تخصصه
    const studentCourses = allData.filter(d => d.type === 'course' && d.specialization_id === currentUser.specialization_id);
    const doctorIds = [...new Set(studentCourses.map(course => course.doctor_id))];
    const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor' && doctorIds.includes(d.__backendId));
    
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">دكاترتي</h1>
            <p class="text-gray-400">أعضاء هيئة التدريس في تخصصي</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${doctors.map(doctor => {
                const doctorCourses = studentCourses.filter(course => course.doctor_id === doctor.__backendId);
                
                return `
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                <span class="text-xl font-bold">${doctor.name.charAt(0)}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">${doctor.name}</h3>
                                <p class="text-gray-400 text-sm">${doctor.email}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="p-3 rounded-lg bg-white/5">
                                <p class="text-gray-400 text-sm mb-1">عدد المقررات</p>
                                <p class="font-medium">${doctorCourses.length} مقرر</p>
                            </div>
                            
                            <div class="p-3 rounded-lg bg-white/5">
                                <p class="text-gray-400 text-sm mb-1">التواصل</p>
                                <div class="flex gap-2">
                                    <button onclick="contactDoctor('${doctor.__backendId}')" class="flex-1 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 text-sm">
                                        إرسال رسالة
                                    </button>
                                    <button onclick="viewDoctorSchedule('${doctor.__backendId}')" class="flex-1 py-2 rounded-lg bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 text-sm">
                                        مواعيد المكتب
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <p class="text-gray-400 text-sm mb-2">المقررات:</p>
                            <div class="flex flex-wrap gap-1">
                                ${doctorCourses.slice(0, 3).map(course => `
                                    <span class="px-2 py-1 rounded-full text-xs bg-white/10">
                                        ${course.name}
                                    </span>
                                `).join('')}
                                ${doctorCourses.length > 3 ? `
                                    <span class="px-2 py-1 rounded-full text-xs bg-white/10">
                                        +${doctorCourses.length - 3} أكثر
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderStudentAttendance(container) {
    container.innerHTML = `
        <div class="mb-8">
            <h1 class="text-3xl font-bold">سجل الحضور والغياب</h1>
            <p class="text-gray-400">متابعة حضورك في المقررات</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">إحصائيات الحضور</h2>
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-40 h-40 rounded-full border-8 border-teal-500/20 relative">
                            <div class="absolute inset-0 rounded-full border-8 border-teal-500" style="clip-path: polygon(0 0, 100% 0, 100% 85%, 0 85%);"></div>
                            <div class="text-center">
                                <div class="text-4xl font-bold">92%</div>
                                <div class="text-gray-400 text-sm">نسبة الحضور</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-teal-400">45</div>
                            <div class="text-gray-400 text-sm">محاضرة حضرت</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-orange-400">4</div>
                            <div class="text-gray-400 text-sm">محاضرة غبت</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-white/5">
                            <div class="text-2xl font-bold text-blue-400">2</div>
                            <div class="text-gray-400 text-sm">إجازة</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">تفاصيل الحضور حسب المقرر</h2>
                <div class="space-y-4">
                    ${['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب', 'الشبكات', 'الرياضيات'].map((course, i) => {
                        const percentages = [94, 91, 89, 87, 85];
                        const attended = [28, 26, 25, 24, 23];
                        const missed = [2, 3, 3, 4, 4];
                        
                        return `
                            <div class="p-4 rounded-xl bg-white/5">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-medium">${course}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                                        ${percentages[i]}%
                                    </span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">حضرت: ${attended[i]}</span>
                                    <span class="text-gray-400">غبت: ${missed[i]}</span>
                                    <span class="text-gray-400">إجمالي: ${attended[i] + missed[i]}</span>
                                </div>
                                <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-teal-500" style="width: ${percentages[i]}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
        
        <div class="glass-card rounded-2xl p-6 mt-6">
            <h2 class="text-xl font-bold mb-4">آخر 10 محاضرات</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-right py-3 px-4">المقرر</th>
                            <th class="text-right py-3 px-4">التاريخ</th>
                            <th class="text-right py-3 px-4">الوقت</th>
                            <th class="text-right py-3 px-4">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Array.from({length: 10}).map((_, i) => {
                            const courses = ['هياكل البيانات', 'قواعد البيانات', 'برمجة الويب'];
                            const dates = ['اليوم', 'أمس', '٢٠/١٠', '١٩/١٠', '١٨/١٠'];
                            const times = ['08:00', '10:00', '14:00'];
                            const statuses = ['حاضر', 'حاضر', 'غائب', 'حاضر', 'حاضر', 'إجازة'];
                            
                            const course = courses[i % 3];
                            const date = dates[i % 5];
                            const time = times[i % 3];
                            const status = statuses[i % 6];
                            
                            return `
                                <tr class="border-b border-white/5 hover:bg-white/5">
                                    <td class="py-3 px-4">${course}</td>
                                    <td class="py-3 px-4">${date}</td>
                                    <td class="py-3 px-4">${time}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-xs ${
                                            status === 'حاضر' ? 'bg-green-500/20 text-green-400' : 
                                            status === 'غائب' ? 'bg-red-500/20 text-red-400' : 
                                            'bg-orange-500/20 text-orange-400'
                                        }">
                                            ${status}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function contactDoctor(doctorId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إرسال رسالة للدكتور</h2>
            <p class="text-gray-400">تواصل مع أستاذك</p>
        </div>
        <form onsubmit="sendMessage(event, '${doctorId}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الموضوع</label>
                    <input type="text" id="message-subject" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="موضوع الرسالة">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">الرسالة</label>
                    <textarea id="message-content" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="5" required placeholder="اكتب رسالتك هنا..."></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إرسال</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

function sendMessage(e, doctorId) {
    e.preventDefault();
    showToast('تم إرسال الرسالة بنجاح', 'success');
    hideModal();
}

function viewDoctorSchedule(doctorId) {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">مواعيد المكتب</h2>
            <p class="text-gray-400">أوقات استقبال الدكتور</p>
        </div>
        
        <div class="space-y-4">
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الأحد</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        10:00 - 12:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
            
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الثلاثاء</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        14:00 - 16:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
            
            <div class="p-4 rounded-xl bg-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">الخميس</h3>
                    <span class="px-2 py-1 rounded-full text-xs bg-teal-500/20 text-teal-400">
                        09:00 - 11:00
                    </span>
                </div>
                <p class="text-sm text-gray-400">قاعة 301 - مبنى الكلية</p>
            </div>
        </div>
        
        <div class="mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20">
            <h3 class="font-medium mb-2">ملاحظات:</h3>
            <ul class="text-sm text-gray-400 space-y-1">
                <li>• يرجى الحضور في الوقت المحدد</li>
                <li>• يمكن حجز موعد مسبق عبر النظام</li>
                <li>• للاستفسارات الطارئة: 555-0123</li>
            </ul>
        </div>
        
        <div class="mt-8">
            <button onclick="hideModal()" class="w-full py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">
                إغلاق
            </button>
        </div>
    `;
    showModal(content);
}

// بعد السطر 450، أضف دالة loadInitialData محدثة لتحميل بيانات إضافية
async function loadInitialData() {
    try {
        // جلب التخصصات من Firebase
        const specsSnapshot = await db.collection('specializations').get();
        const specializations = [];
        specsSnapshot.forEach(doc => {
            specializations.push({
                type: 'specialization',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المستخدمين
        const usersSnapshot = await db.collection('users').get();
        const users = [];
        usersSnapshot.forEach(doc => {
            users.push({
                type: 'user',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المجموعات
        const groupsSnapshot = await db.collection('groups').get();
        const groups = [];
        groupsSnapshot.forEach(doc => {
            groups.push({
                type: 'group',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب المقررات
        const coursesSnapshot = await db.collection('courses').get();
        const courses = [];
        coursesSnapshot.forEach(doc => {
            courses.push({
                type: 'course',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // جلب الجداول
        const schedulesSnapshot = await db.collection('schedules').get();
        const schedules = [];
        schedulesSnapshot.forEach(doc => {
            schedules.push({
                type: 'schedule',
                __backendId: doc.id,
                ...doc.data()
            });
        });
        
        // دمج كل البيانات
        allData = [
            ...specializations,
            ...users,
            ...groups,
            ...courses,
            ...schedules
        ];
        
        // بيانات افتراضية للقاعات إذا لم تكن موجودة
        if (!allData.some(d => d.type === 'room')) {
            const defaultRooms = [
                { type: 'room', __backendId: 'room1', name: 'قاعة 101', type: 'lecture', capacity: 50, location: 'المبنى الرئيسي', status: 'available' },
                { type: 'room', __backendId: 'room2', name: 'قاعة 203', type: 'lecture', capacity: 40, location: 'المبنى الرئيسي', status: 'available' },
                { type: 'room', __backendId: 'room3', name: 'معمل 105', type: 'lab', capacity: 30, location: 'مبنى المعامل', equipment: 'حواسيب', status: 'available' },
                { type: 'room', __backendId: 'room4', name: 'قاعة 301', type: 'lecture', capacity: 60, location: 'المبنى الجديد', status: 'available' },
                { type: 'room', __backendId: 'room5', name: 'معمل 205', type: 'lab', capacity: 25, location: 'مبنى المعامل', equipment: 'أجهزة شبكات', status: 'maintenance' }
            ];
            allData.push(...defaultRooms);
        }
        
        updateUI();
        
    } catch (error) {
        console.error("Error loading initial data:", error);
    }
}

// بعد السطر 950، أضف دالة editSpecialization
async function editSpecialization(id) {
    const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === id);
    if (!specialization) return;
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">تعديل التخصص</h2>
            <p class="text-gray-400">تعديل بيانات التخصص</p>
        </div>
        <form onsubmit="updateSpecialization(event, '${id}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="edit-spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" value="${specialization.name}" required>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">حفظ التغييرات</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function updateSpecialization(e, id) {
    e.preventDefault();
    const name = document.getElementById('edit-spec-name').value;
    
    try {
        await db.collection('specializations').doc(id).update({
            name: name,
            updated_at: new Date().toISOString()
        });
        
        showToast('تم تحديث التخصص بنجاح');
        hideModal();
        
        // تحديث البيانات المحلية
        const index = allData.findIndex(d => d.type === 'specialization' && d.__backendId === id);
        if (index !== -1) {
            allData[index].name = name;
        }
        
        updateUI();
    } catch (error) {
        console.error("Error updating specialization:", error);
        showToast('فشل في تحديث التخصص', 'error');
    }
}
        // تحديث دوال إدارة البيانات لاستخدام Firebase
        async function addSpecialization(e) {
            e.preventDefault();
            const name = document.getElementById('spec-name').value;
            
            try {
                const docRef = await db.collection('specializations').add({
                    name: name,
                    created_at: new Date().toISOString()
                });
                
                showToast('تم إضافة التخصص بنجاح');
                hideModal();
                
                // تحديث البيانات المحلية
                allData.push({
                    type: 'specialization',
                    __backendId: docRef.id,
                    name: name,
                    created_at: new Date().toISOString()
                });
                
                updateUI();
            } catch (error) {
                console.error("Error adding specialization:", error);
                showToast('فشل في إضافة التخصص', 'error');
            }
        }

        async function deleteSpecialization(id) {
            try {
                await db.collection('specializations').doc(id).delete();
                showToast('تم حذف التخصص');
                
                // تحديث البيانات المحلية
                allData = allData.filter(d => !(d.type === 'specialization' && d.__backendId === id));
                updateUI();
            } catch (error) {
                console.error("Error deleting specialization:", error);
                showToast('فشل في الحذف', 'error');
            }
        }

        // باقي الدوال تحتاج إلى تعديلات مشابهة لاستخدام Firebase
        // أضفت مثالين فقط للاختصار

        function updateUI() {
            if (currentUser) {
                renderContent();
                updateSpecializationOptions();
                
                // Update group options based on specialization
                const groups = allData.filter(d => d.type === 'group');
                const groupSelect = document.getElementById('register-group');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">اختر المجموعة</option>' + 
                        groups.map(g => `<option value="${g.__backendId}">${g.name}</option>`).join('');
                }
            }
        }

        // Close modal on backdrop click
        document.getElementById('modal-container').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });
// دوال إدارة التخصصات
function showAddSpecializationModal() {
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">إضافة تخصص جديد</h2>
            <p class="text-gray-400">أدخل بيانات التخصص الجديد</p>
        </div>
        <form onsubmit="addSpecialization(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" required placeholder="مثل: علوم الحاسب">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف التخصص</label>
                    <textarea id="spec-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3" placeholder="وصف مختصر للتخصص..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">عدد المستويات</label>
                    <select id="spec-levels" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                        ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">${l} مستويات</option>`).join('')}
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">إضافة</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function addSpecialization(e) {
    e.preventDefault();
    const name = document.getElementById('spec-name').value;
    const description = document.getElementById('spec-description').value;
    const levels = document.getElementById('spec-levels').value;

    try {
        const docRef = await db.collection('specializations').add({
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active',
            created_at: new Date().toISOString()
        });

        showToast('تم إضافة التخصص بنجاح');
        hideModal();

        allData.push({
            type: 'specialization',
            __backendId: docRef.id,
            name: name,
            description: description || '',
            levels: parseInt(levels),
            status: 'active'
        });

        updateUI();
    } catch (error) {
        console.error("Error adding specialization:", error);
        showToast('فشل في إضافة التخصص', 'error');
    }
}

async function deleteSpecialization(id) {
    if (!confirm('هل أنت متأكد من حذف هذا التخصص؟ سيتم حذف جميع المقررات والمجموعات المرتبطة به.')) return;
    
    try {
        await db.collection('specializations').doc(id).delete();
        showToast('تم حذف التخصص');
        
        allData = allData.filter(d => !(d.type === 'specialization' && d.__backendId === id));
        updateUI();
    } catch (error) {
        console.error("Error deleting specialization:", error);
        showToast('فشل في الحذف', 'error');
    }
}

async function editSpecialization(id) {
    const specialization = allData.find(d => d.type === 'specialization' && d.__backendId === id);
    if (!specialization) return;
    
    const content = `
        <div class="mb-6">
            <h2 class="text-2xl font-bold">تعديل التخصص</h2>
            <p class="text-gray-400">تعديل بيانات التخصص</p>
        </div>
        <form onsubmit="updateSpecialization(event, '${id}')">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                    <input type="text" id="edit-spec-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" value="${specialization.name}" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">وصف التخصص</label>
                    <textarea id="edit-spec-description" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" rows="3">${specialization.description || ''}</textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-medium">حفظ التغييرات</button>
                <button type="button" onclick="hideModal()" class="flex-1 py-3 rounded-xl bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">إلغاء</button>
            </div>
        </form>
    `;
    showModal(content);
}

async function updateSpecialization(e, id) {
    e.preventDefault();
    const name = document.getElementById('edit-spec-name').value;
    const description = document.getElementById('edit-spec-description').value;
    
    try {
        await db.collection('specializations').doc(id).update({
            name: name,
            description: description || '',
            updated_at: new Date().toISOString()
        });
        
        showToast('تم تحديث التخصص بنجاح');
        hideModal();
        
        const index = allData.findIndex(d => d.type === 'specialization' && d.__backendId === id);
        if (index !== -1) {
            allData[index].name = name;
            allData[index].description = description || '';
        }
        
        updateUI();
    } catch (error) {
        console.error("Error updating specialization:", error);
        showToast('فشل في تحديث التخصص', 'error');
    }
}
        // Initialize app
        initializeApp();
        
    </script>
</body>
</html>