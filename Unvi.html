<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المحاضرات الأكاديمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 50%, #1b263b 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-item:hover {
            background: rgba(45, 212, 191, 0.15);
            transform: translateX(-5px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.2) 0%, transparent 100%);
            border-right: 3px solid #2dd4bf;
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(45, 212, 191, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #2dd4bf;
            box-shadow: 0 0 20px rgba(45, 212, 191, 0.2);
        }
        
        .schedule-cell {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .lecture-card {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(45, 212, 191, 0.3);
            border-radius: 3px;
        }
        
        .toast {
            animation: slideIn 0.3s ease forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* تأثيرات زر القائمة */
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);
            border: none;
            outline: none;
        }

        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(45, 212, 191, 0.4);
        }

        .menu-toggle span {
            display: block;
            width: 24px;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-toggle span:before,
        .menu-toggle span:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
        }

        .menu-toggle span:before {
            top: -8px;
        }

        .menu-toggle span:after {
            bottom: -8px;
        }

        .menu-toggle.open span {
            background: transparent;
        }

        .menu-toggle.open span:before {
            top: 0;
            transform: rotate(45deg);
        }

        .menu-toggle.open span:after {
            bottom: 0;
            transform: rotate(-45deg);
        }

        /* تأثيرات القائمة الجانبية */
        #sidebar {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        /* القائمة على الشاشات الصغيرة */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                height: 100vh;
                transform: translateX(100%);
                opacity: 0;
            }
            
            #sidebar.visible {
                transform: translateX(0);
                opacity: 1;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            /* منع التمرير عند فتح القائمة */
            body.sidebar-open {
                overflow: hidden;
            }
        }

        /* القائمة على الشاشات الكبيرة */
        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }

        /* تأثير التعتيم للخلفية على الهواتف */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
    <style>@view-transition { navigation: auto; }</style>
</head>
<body class="h-full gradient-bg text-white overflow-auto">
    <div id="app" class="h-full w-full">
        <!-- Login Page -->
        <div id="login-page" class="min-h-full flex items-center justify-center p-4">
            <div class="glass-card rounded-3xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h1 id="system-title" class="text-2xl font-bold mb-2">نظام إدارة المحاضرات الأكاديمية</h1>
                    <p id="welcome-text" class="text-gray-400">مرحباً بك في النظام</p>
                </div>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع المستخدم</label>
                        <select id="user-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="student">طالب</option>
                            <option value="doctor">دكتور</option>
                            <option value="admin">عمادة</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                        <input type="email" id="login-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="example@university.edu">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">كلمة المرور</label>
                        <input type="password" id="login-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="••••••••">
                    </div>
                </div>
                <button onclick="handleLogin()" class="btn-primary w-full py-3 rounded-xl font-bold text-white mb-4">تسجيل الدخول</button>
                <div class="text-center">
                    <button onclick="showRegister()" class="text-teal-400 hover:text-teal-300 text-sm">إنشاء حساب جديد</button>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="min-h-full flex items-center justify-center p-4 hidden">
            <div class="glass-card rounded-3xl p-8 w-full max-w-md">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">إنشاء حساب جديد</h2>
                    <p class="text-gray-400">أدخل بياناتك للتسجيل</p>
                </div>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">نوع الحساب</label>
                        <select id="register-type" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" onchange="updateRegisterForm()">
                            <option value="student">طالب</option>
                            <option value="doctor">دكتور</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">الاسم الكامل</label>
                        <input type="text" id="register-name" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="الاسم الكامل">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                        <input type="email" id="register-email" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="example@university.edu">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">كلمة المرور</label>
                        <input type="password" id="register-password" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none" placeholder="••••••••">
                    </div>
                    <div id="specialization-field">
                        <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                        <select id="register-specialization" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="">اختر التخصص</option>
                        </select>
                    </div>
                    <div id="group-field">
                        <label class="block text-sm text-gray-400 mb-2">المجموعة</label>
                        <select id="register-group" class="input-field w-full px-4 py-3 rounded-xl text-white outline-none">
                            <option value="">اختر المجموعة</option>
                        </select>
                    </div>
                </div>
                <button onclick="handleRegister()" class="btn-primary w-full py-3 rounded-xl font-bold text-white mb-4">تسجيل</button>
                <div class="text-center">
                    <button onclick="showLogin()" class="text-teal-400 hover:text-teal-300 text-sm">لدي حساب بالفعل</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard" class="h-full hidden">
            <!-- زر القائمة للشاشات الصغيرة -->
            <button id="menu-toggle" class="menu-toggle" onclick="toggleSidebar()">
                <span></span>
            </button>
            
            <div class="flex h-full">
                <!-- Sidebar -->
                <aside id="sidebar" class="w-72 glass-card border-l border-white/10 flex flex-col">
                    <div class="p-6 border-b border-white/10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg">LMS</h2>
                                <p id="user-role-display" class="text-xs text-gray-400">نظام المحاضرات</p>
                            </div>
                        </div>
                    </div>
                    <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-auto">
                        <!-- Navigation items will be inserted here -->
                    </nav>
                    <div class="p-4 border-t border-white/10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <span id="user-avatar" class="font-bold">م</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p id="user-name-display" class="font-medium truncate">المستخدم</p>
                                <p id="user-email-display" class="text-xs text-gray-400 truncate">email@example.com</p>
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="w-full py-2 px-4 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg> تسجيل الخروج
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 overflow-auto">
                    <div id="main-content" class="p-6">
                        <!-- Content will be loaded here -->
                    </div>
                </main>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 left-4 z-50 space-y-2"></div>

        <!-- Modal Container -->
        <div id="modal-container" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div id="modal-content" class="glass-card rounded-2xl p-6 w-full max-w-lg max-h-[90%] overflow-auto">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
        
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="hideSidebar()"></div>
    </div>

    <script>
        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB3U2bt-PuZlUOb0uRPI1aPxL01Yg8lrts",
            authDomain: "universityti-d2e74.firebaseapp.com",
            projectId: "universityti-d2e74",
            storageBucket: "universityti-d2e74.firebasestorage.app",
            messagingSenderId: "205897642006",
            appId: "1:205897642006:web:d63e9753006d55f0b84537",
            measurementId: "G-6JHV42GV0H"
        };

        // تهيئة Firebase
        let firebaseApp, auth, db;
        
        // Default configuration
        const defaultConfig = {
            background_color: '#0d1b2a',
            surface_color: '#1e3a5f',
            text_color: '#ffffff',
            primary_action: '#2dd4bf',
            secondary_action: '#14b8a6',
            font_family: 'Tajawal',
            font_size: 16,
            system_title: 'نظام إدارة المحاضرات الأكاديمية',
            welcome_message: 'مرحباً بك في النظام'
        };

        let config = { ...defaultConfig };
        let allData = [];
        let currentUser = null;
        let currentView = 'dashboard';
        let recordCount = 0;

        // Data Handler
        const dataHandler = {
            onDataChanged(data) {
                allData = data;
                recordCount = data.length;
                updateUI();
            }
        };

        // Initialize SDKs
        async function initializeApp() {
            try {
                // Initialize Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log("Firebase initialized successfully");
                
                // Check authentication state
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log("User is signed in:", user.email);
                    } else {
                        console.log("No user is signed in");
                    }
                });
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showToast('فشل في تهيئة قاعدة البيانات', 'error');
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (newConfig) => {
                        config = { ...defaultConfig, ...newConfig };
                        applyConfig();
                    },
                    mapToCapabilities: (cfg) => ({
                        recolorables: [
                            {
                                get: () => cfg.background_color || defaultConfig.background_color,
                                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
                            },
                            {
                                get: () => cfg.surface_color || defaultConfig.surface_color,
                                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
                            },
                            {
                                get: () => cfg.text_color || defaultConfig.text_color,
                                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
                            },
                            {
                                get: () => cfg.primary_action || defaultConfig.primary_action,
                                set: (v) => { cfg.primary_action = v; window.elementSdk.setConfig({ primary_action: v }); }
                            },
                            {
                                get: () => cfg.secondary_action || defaultConfig.secondary_action,
                                set: (v) => { cfg.secondary_action = v; window.elementSdk.setConfig({ secondary_action: v }); }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => cfg.font_family || defaultConfig.font_family,
                            set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
                        },
                        fontSizeable: {
                            get: () => cfg.font_size || defaultConfig.font_size,
                            set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
                        }
                    }),
                    mapToEditPanelValues: (cfg) => new Map([
                        ['system_title', cfg.system_title || defaultConfig.system_title],
                        ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }

            // Initialize Data SDK
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    showToast('فشل في تهيئة قاعدة البيانات', 'error');
                }
            }

            applyConfig();
            
            // تحميل البيانات الأولية من Firebase
            await loadInitialData();
        }

        async function loadInitialData() {
            try {
                // جلب التخصصات من Firebase
                const specsSnapshot = await db.collection('specializations').get();
                const specializations = [];
                specsSnapshot.forEach(doc => {
                    specializations.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                // دمج مع البيانات الحالية
                allData = allData.filter(d => d.type !== 'specialization');
                specializations.forEach(spec => {
                    allData.push({
                        type: 'specialization',
                        ...spec
                    });
                });
                
                // جلب المجموعات
                const groupsSnapshot = await db.collection('groups').get();
                const groups = [];
                groupsSnapshot.forEach(doc => {
                    groups.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                allData = allData.filter(d => d.type !== 'group');
                groups.forEach(group => {
                    allData.push({
                        type: 'group',
                        ...group
                    });
                });
                
                // جلب المستخدمين
                const usersSnapshot = await db.collection('users').get();
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({
                        __backendId: doc.id,
                        ...doc.data()
                    });
                });
                
                allData = allData.filter(d => d.type !== 'user');
                users.forEach(user => {
                    allData.push({
                        type: 'user',
                        ...user
                    });
                });
                
                updateUI();
                
            } catch (error) {
                console.error("Error loading initial data:", error);
            }
        }

        function applyConfig() {
            const font = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;
            const bgColor = config.background_color || defaultConfig.background_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action || defaultConfig.primary_action;

            document.body.style.fontFamily = `${font}, sans-serif`;
            document.body.style.fontSize = `${fontSize}px`;
            
            document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
            document.getElementById('welcome-text').textContent = config.welcome_message || defaultConfig.welcome_message;

            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${config.secondary_action || defaultConfig.secondary_action} 100%)`;
            });
        }

        // UI Helpers
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-teal-500/90' : type === 'error' ? 'bg-red-500/90' : 'bg-blue-500/90';
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg backdrop-blur-sm`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // وظائف إدارة القائمة الجانبية
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('visible')) {
                    hideSidebar();
                } else {
                    showSidebar();
                }
            }
        }

        function showSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.add('visible');
            overlay.classList.add('active');
            toggleBtn.classList.add('open');
            document.body.classList.add('sidebar-open');
        }

        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.remove('visible');
            overlay.classList.remove('active');
            toggleBtn.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }

        // تحديث حالة القائمة عند تغيير حجم النافذة
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (window.innerWidth > 768) {
                // على الشاشات الكبيرة، تأكد من أن القائمة مرئية
                sidebar.classList.remove('visible');
                if (overlay) overlay.classList.remove('active');
                if (toggleBtn) toggleBtn.classList.remove('open');
                document.body.classList.remove('sidebar-open');
            }
        }

        // إغلاق القائمة عند النقر على رابط في القائمة (للشاشات الصغيرة)
        function closeSidebarOnClick() {
            const navItems = document.querySelectorAll('#sidebar-nav button, #sidebar button');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            hideSidebar();
                        }, 300);
                    }
                });
            });
        }

        // Navigation
        const adminNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'specializations', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', label: 'التخصصات' },
            { id: 'doctors', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z', label: 'الدكاترة' },
            { id: 'courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'المقررات' },
            { id: 'schedules', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'الجداول' },
            { id: 'groups', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z', label: 'المجموعات' },
            { id: 'rooms', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', label: 'القاعات' },
            { id: 'reports', icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z', label: 'التقارير' }
        ];

        const doctorNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'my-schedule', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'جدولي' },
            { id: 'my-courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'موادي' },
            { id: 'my-students', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', label: 'طلابي' },
            { id: 'attendance', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', label: 'الحضور' }
        ];

        const studentNav = [
            { id: 'dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'لوحة التحكم' },
            { id: 'full-schedule', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', label: 'الجدول الكامل' },
            { id: 'today-schedule', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z', label: 'جدول اليوم' },
            { id: 'my-courses', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253', label: 'مقرراتي' },
            { id: 'my-doctors', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z', label: 'دكاترتي' },
            { id: 'my-attendance', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4', label: 'حضوري' }
        ];

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            let navItems = [];
            
            if (currentUser.role === 'admin') {
                navItems = adminNav;
                document.getElementById('user-role-display').textContent = 'لوحة العمادة';
            } else if (currentUser.role === 'doctor') {
                navItems = doctorNav;
                document.getElementById('user-role-display').textContent = 'لوحة الدكتور';
            } else {
                navItems = studentNav;
                document.getElementById('user-role-display').textContent = 'لوحة الطالب';
            }

            nav.innerHTML = navItems.map(item => `
                <button onclick="navigateTo('${item.id}')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:text-white ${currentView === item.id ? 'active' : ''}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"/>
                    </svg>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function navigateTo(viewId) {
            currentView = viewId;
            renderSidebar();
            renderContent();
        }

        // Auth Functions with Firebase
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const userType = document.getElementById('user-type').value;

            if (!email || !password) {
                showToast('يرجى إدخال جميع البيانات', 'error');
                return;
            }

            try {
                // Check for admin login
                if (userType === 'admin') {
                    if (email === 'admin@university.edu' && password === 'admin123') {
                        currentUser = {
                            id: 'admin',
                            name: 'مدير النظام',
                            email: email,
                            role: 'admin'
                        };
                        showDashboard();
                        return;
                    } else {
                        showToast('بيانات الدخول غير صحيحة', 'error');
                        return;
                    }
                }

                // Login with Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Get user data from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.role === userType) {
                        currentUser = {
                            id: user.uid,
                            name: userData.name,
                            email: user.email,
                            role: userData.role,
                            specialization_id: userData.specialization_id,
                            group_id: userData.group_id
                        };
                        showDashboard();
                    } else {
                        showToast('نوع المستخدم غير متطابق', 'error');
                        await auth.signOut();
                    }
                } else {
                    showToast('بيانات المستخدم غير موجودة', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Login error:", error);
                showToast('بيانات الدخول غير صحيحة', 'error');
            }
        }

        async function handleRegister() {
            const type = document.getElementById('register-type').value;
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const specialization = document.getElementById('register-specialization').value;
            const group = document.getElementById('register-group').value;

            if (!name || !email || !password) {
                showToast('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }

            if (type === 'student' && (!specialization || !group)) {
                showToast('يرجى اختيار التخصص والمجموعة', 'error');
                return;
            }

            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    role: type,
                    specialization_id: type === 'student' ? specialization : '',
                    group_id: type === 'student' ? group : '',
                    created_at: new Date().toISOString()
                });

                showToast('تم التسجيل بنجاح');
                showLogin();
            } catch (error) {
                console.error("Registration error:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('البريد الإلكتروني مسجل بالفعل', 'error');
                } else {
                    showToast('فشل في التسجيل', 'error');
                }
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error);
            }
            
            currentUser = null;
            currentView = 'dashboard';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            updateSpecializationOptions();
        }

        function updateRegisterForm() {
            const type = document.getElementById('register-type').value;
            const specField = document.getElementById('specialization-field');
            const groupField = document.getElementById('group-field');
            
            if (type === 'doctor') {
                specField.classList.add('hidden');
                groupField.classList.add('hidden');
            } else {
                specField.classList.remove('hidden');
                groupField.classList.remove('hidden');
            }
        }

        function updateSpecializationOptions() {
            const specializations = allData.filter(d => d.type === 'specialization');
            const select = document.getElementById('register-specialization');
            select.innerHTML = '<option value="">اختر التخصص</option>' + 
                specializations.map(s => `<option value="${s.__backendId}">${s.name}</option>`).join('');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = currentUser.name;
            document.getElementById('user-email-display').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
            
            renderSidebar();
            renderContent();
            
            // إضافة مستمعين لتغيير حجم النافذة
            window.addEventListener('resize', handleResize);
            
            // إغلاق القائمة عند النقر على الروابط
            closeSidebarOnClick();
            
            // تهيئة حالة القائمة
            handleResize();
        }

        // Content Rendering (متبقي كما هو مع تعديلات طفيفة)
        function renderContent() {
            const container = document.getElementById('main-content');
            
            if (currentUser.role === 'admin') {
                renderAdminContent(container);
            } else if (currentUser.role === 'doctor') {
                renderDoctorContent(container);
            } else {
                renderStudentContent(container);
            }
        }

        // باقي دوال التصيير تبقى كما هي مع تعديلات لاستخدام Firebase بدلاً من SDKs القديمة

        // Admin Dashboard
        function renderAdminDashboard(container) {
            const specs = allData.filter(d => d.type === 'specialization').length;
            const doctors = allData.filter(d => d.type === 'user' && d.role === 'doctor').length;
            const students = allData.filter(d => d.type === 'user' && d.role === 'student').length;
            const courses = allData.filter(d => d.type === 'course').length;
            const rooms = allData.filter(d => d.type === 'room').length;
            const groups = allData.filter(d => d.type === 'group').length;

            container.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold mb-2">مرحباً بك في لوحة التحكم</h1>
                    <p class="text-gray-400">إدارة شاملة للنظام الأكاديمي</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${specs}</span>
                        </div>
                        <h3 class="font-semibold text-lg">التخصصات</h3>
                        <p class="text-gray-400 text-sm">الأقسام الأكاديمية</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${doctors}</span>
                        </div>
                        <h3 class="font-semibold text-lg">الدكاترة</h3>
                        <p class="text-gray-400 text-sm">أعضاء هيئة التدريس</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${students}</span>
                        </div>
                        <h3 class="font-semibold text-lg">الطلاب</h3>
                        <p class="text-gray-400 text-sm">المسجلين في النظام</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${courses}</span>
                        </div>
                        <h3 class="font-semibold text-lg">المقررات</h3>
                        <p class="text-gray-400 text-sm">المواد الدراسية</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${rooms}</span>
                        </div>
                        <h3 class="font-semibold text-lg">القاعات</h3>
                        <p class="text-gray-400 text-sm">قاعات ومعامل</p>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <span class="text-3xl font-bold">${groups}</span>
                        </div>
                        <h3 class="font-semibold text-lg">المجموعات</h3>
                        <p class="text-gray-400 text-sm">مجموعات الطلاب</p>
                    </div>
                </div>
                
                <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4">إجراءات سريعة</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="navigateTo('specializations')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة تخصص
                        </button>
                        <button onclick="navigateTo('doctors')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة دكتور
                        </button>
                        <button onclick="navigateTo('courses')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إضافة مقرر
                        </button>
                        <button onclick="navigateTo('schedules')" class="btn-primary py-3 px-4 rounded-xl text-sm font-medium">
                            إدارة الجداول
                        </button>
                    </div>
                </div>
            `;
        }

        // تحديث دوال إدارة البيانات لاستخدام Firebase
        async function addSpecialization(e) {
            e.preventDefault();
            const name = document.getElementById('spec-name').value;
            
            try {
                const docRef = await db.collection('specializations').add({
                    name: name,
                    created_at: new Date().toISOString()
                });
                
                showToast('تم إضافة التخصص بنجاح');
                hideModal();
                
                // تحديث البيانات المحلية
                allData.push({
                    type: 'specialization',
                    __backendId: docRef.id,
                    name: name,
                    created_at: new Date().toISOString()
                });
                
                updateUI();
            } catch (error) {
                console.error("Error adding specialization:", error);
                showToast('فشل في إضافة التخصص', 'error');
            }
        }

        async function deleteSpecialization(id) {
            try {
                await db.collection('specializations').doc(id).delete();
                showToast('تم حذف التخصص');
                
                // تحديث البيانات المحلية
                allData = allData.filter(d => !(d.type === 'specialization' && d.__backendId === id));
                updateUI();
            } catch (error) {
                console.error("Error deleting specialization:", error);
                showToast('فشل في الحذف', 'error');
            }
        }

        // باقي الدوال تحتاج إلى تعديلات مشابهة لاستخدام Firebase
        // أضفت مثالين فقط للاختصار

        function updateUI() {
            if (currentUser) {
                renderContent();
                updateSpecializationOptions();
                
                // Update group options based on specialization
                const groups = allData.filter(d => d.type === 'group');
                const groupSelect = document.getElementById('register-group');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">اختر المجموعة</option>' + 
                        groups.map(g => `<option value="${g.__backendId}">${g.name}</option>`).join('');
                }
            }
        }

        // Close modal on backdrop click
        document.getElementById('modal-container').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });

        // Initialize app
        initializeApp();
    </script>
</body>
</html>