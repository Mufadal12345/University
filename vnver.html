<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المحاضرات الأكاديمية المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2dd4bf;
            --secondary-color: #14b8a6;
            --background-color: #0d1b2a;
            --surface-color: #1e3a5f;
            --text-color: #ffffff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--background-color) 0%, #1b263b 100%);
            color: var(--text-color);
            overflow-x: hidden;
        }
        
        /* تحسينات التصميم الزجاجي */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(45, 212, 191, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        
        /* تحسينات القائمة الجانبية */
        .sidebar-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            margin: 4px 0;
        }
        
        .sidebar-item:hover {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.15) 0%, transparent 100%);
            transform: translateX(-5px);
            border-right: 3px solid var(--primary-color);
        }
        
        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.25) 0%, transparent 100%);
            border-right: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        /* أزرار محسنة */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(45, 212, 191, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(45, 212, 191, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary-color);
        }
        
        /* حقول الإدخال المحسنة */
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
            outline: none;
        }
        
        /* تحسينات الجدول */
        .schedule-cell {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            min-height: 180px;
            transition: all 0.3s ease;
        }
        
        .schedule-cell:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(45, 212, 191, 0.2);
        }
        
        .lecture-card {
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
            border: 1px solid rgba(45, 212, 191, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .lecture-theoretical {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.05) 100%);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .lecture-practical {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        /* تحسينات التنبيهات */
        .toast {
            animation: slideInRight 0.3s ease forwards;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: #1e293b;
            font-weight: 500;
            max-width: 400px;
            border-left: 5px solid;
        }
        
        .toast-success {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        
        .toast-error {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        
        .toast-warning {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        
        .toast-info {
            border-left-color: var(--info-color);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }
        
        /* تحسينات القائمة المتنقلة */
        .menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(45, 212, 191, 0.4);
            border: none;
            outline: none;
        }
        
        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 40px rgba(45, 212, 191, 0.5);
        }
        
        /* تحسينات التحميل */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* تحسينات البطاقات الإحصائية */
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(45, 212, 191, 0.15);
            border-color: rgba(45, 212, 191, 0.3);
        }
        
        /* تحسينات شريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
        }
        
        /* تحسينات الجداول */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            text-align: right;
            font-weight: 600;
            border-bottom: 2px solid rgba(45, 212, 191, 0.3);
        }
        
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* تحسينات العلامات */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* تحسينات النموذج المنبثق */
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.95) 0%, rgba(13, 27, 42, 0.98) 100%);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        /* تحسينات شريط التقدم */
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: width 0.6s ease;
        }
        
        /* تحسينات الأيقونات */
        .icon-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .icon-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .icon-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .icon-green {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
        }
        
        .icon-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .icon-orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .icon-pink {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
        }
        
        /* تحسينات التوابع */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }
        
        .badge-primary {
            background: rgba(45, 212, 191, 0.2);
            color: var(--primary-color);
            border: 1px solid rgba(45, 212, 191, 0.3);
        }
        
        .badge-secondary {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* تحسينات البحث */
        .search-box {
            position: relative;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* تحسينات الاستجابة للهواتف */
        @media (max-width: 768px) {
            .stats-card {
                padding: 16px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .menu-toggle {
                width: 48px;
                height: 48px;
                top: 15px;
                right: 15px;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        /* تحسينات إضافية */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* الرسوم المتحركة */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* تحسينات الطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .glass-card {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
        }
        
        /* تحسينات إمكانية الوصول */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .focus-visible:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* تحسينات الخطوط العربية */
        .arabic-text {
            letter-spacing: 0;
            line-height: 1.8;
            text-align: justify;
        }
        
        .arabic-heading {
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        /* تحسينات نظام الألوان الداكن */
        .dark-mode {
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --text-color: #f1f5f9;
        }
        
        /* تحسينات الرسوم البيانية */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* تحسينات التواجد المباشر */
        .online-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid var(--surface-color);
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        .offline-indicator {
            width: 12px;
            height: 12px;
            background: #6b7280;
            border-radius: 50%;
            border: 2px solid var(--surface-color);
            position: absolute;
            bottom: 0;
            right: 0;
        }
    </style>
</head>
<body class="h-full overflow-hidden">
    <div id="app" class="h-full w-full relative">
        <!-- شاشة التحميل -->
        <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-gray-900 to-gray-800 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="loading-spinner mb-6 mx-auto"></div>
                <h1 class="text-2xl font-bold mb-2">نظام إدارة المحاضرات الأكاديمية</h1>
                <p class="text-gray-400">جاري تحميل النظام...</p>
                <div class="mt-4 w-64 h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="loading-progress" class="h-full bg-gradient-to-r from-teal-500 to-teal-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- صفحة تسجيل الدخول -->
        <div id="login-page" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="w-full max-w-md">
                <div class="glass-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-3xl text-white"></i>
                    </div>
                    <h1 id="system-title" class="text-3xl font-bold mb-2 gradient-text">نظام إدارة المحاضرات الأكاديمية</h1>
                    <p id="welcome-text" class="text-gray-400 text-lg">مرحباً بك في المنصة التعليمية المتكاملة</p>
                </div>
                
                <div class="glass-card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold mb-6 text-center">تسجيل الدخول</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">نوع المستخدم</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="selectUserType('student')" id="student-btn" 
                                        class="user-type-btn p-4 rounded-xl border-2 border-gray-700 hover:border-teal-500 transition-all text-center">
                                    <i class="fas fa-user-graduate text-2xl mb-2"></i>
                                    <div class="font-medium">طالب</div>
                                </button>
                                <button onclick="selectUserType('doctor')" id="doctor-btn" 
                                        class="user-type-btn p-4 rounded-xl border-2 border-gray-700 hover:border-blue-500 transition-all text-center">
                                    <i class="fas fa-user-md text-2xl mb-2"></i>
                                    <div class="font-medium">دكتور</div>
                                </button>
                                <button onclick="selectUserType('admin')" id="admin-btn" 
                                        class="user-type-btn p-4 rounded-xl border-2 border-gray-700 hover:border-purple-500 transition-all text-center">
                                    <i class="fas fa-user-shield text-2xl mb-2"></i>
                                    <div class="font-medium">عمادة</div>
                                </button>
                            </div>
                            <input type="hidden" id="user-type" value="student">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">البريد الإلكتروني</label>
                            <div class="relative">
                                <i class="fas fa-envelope absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                <input type="email" id="login-email" 
                                       class="input-field pl-12" 
                                       placeholder="example@university.edu"
                                       required>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">كلمة المرور</label>
                            <div class="relative">
                                <i class="fas fa-lock absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                <input type="password" id="login-password" 
                                       class="input-field pl-12" 
                                       placeholder="••••••••"
                                       required>
                                <button type="button" onclick="togglePassword('login-password')" 
                                        class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-300">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" id="remember-me" class="rounded border-gray-600 text-teal-500 focus:ring-teal-500">
                                <span class="mr-2 text-sm text-gray-400">تذكرني</span>
                            </label>
                            <button onclick="showForgotPassword()" class="text-sm text-teal-400 hover:text-teal-300">
                                نسيت كلمة المرور؟
                            </button>
                        </div>
                        
                        <button onclick="handleLogin()" 
                                class="btn-primary w-full py-4 text-lg font-bold mt-2">
                            <i class="fas fa-sign-in-alt ml-2"></i>
                            تسجيل الدخول
                        </button>
                        
                        <div class="relative my-6">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-700"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-4 bg-gray-900 text-gray-400">أو</span>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-gray-400 mb-4">ليس لديك حساب؟</p>
                            <button onclick="showRegister()" 
                                    class="btn-secondary w-full py-3 font-medium">
                                <i class="fas fa-user-plus ml-2"></i>
                                إنشاء حساب جديد
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center text-sm text-gray-500">
                    <p>© 2024 نظام إدارة المحاضرات. جميع الحقوق محفوظة.</p>
                    <p class="mt-1">الإصدار 2.0.0</p>
                </div>
            </div>
        </div>

        <!-- صفحة استعادة كلمة المرور -->
        <div id="forgot-password-page" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="w-full max-w-md">
                <button onclick="showLogin()" class="mb-6 text-teal-400 hover:text-teal-300 flex items-center">
                    <i class="fas fa-arrow-right ml-2"></i>
                    العودة لتسجيل الدخول
                </button>
                
                <div class="glass-card rounded-2xl p-8">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                            <i class="fas fa-key text-2xl text-white"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">استعادة كلمة المرور</h2>
                        <p class="text-gray-400">أدخل بريدك الإلكتروني لإرسال رابط الاستعادة</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">البريد الإلكتروني</label>
                            <div class="relative">
                                <i class="fas fa-envelope absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                <input type="email" id="reset-email" 
                                       class="input-field pl-12" 
                                       placeholder="example@university.edu"
                                       required>
                            </div>
                        </div>
                        
                        <button onclick="handlePasswordReset()" 
                                class="btn-primary w-full py-4 text-lg font-bold">
                            <i class="fas fa-paper-plane ml-2"></i>
                            إرسال رابط الاستعادة
                        </button>
                        
                        <div class="text-center mt-4">
                            <p class="text-sm text-gray-400">
                                سيتم إرسال رابط استعادة كلمة المرور إلى بريدك الإلكتروني.
                                يرجى التحقق من صندوق البريد أو مجلد الرسائل غير المرغوب فيها.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحة التسجيل -->
        <div id="register-page" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="w-full max-w-2xl">
                <button onclick="showLogin()" class="mb-6 text-teal-400 hover:text-teal-300 flex items-center">
                    <i class="fas fa-arrow-right ml-2"></i>
                    العودة لتسجيل الدخول
                </button>
                
                <div class="glass-card rounded-2xl p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-2">إنشاء حساب جديد</h2>
                        <p class="text-gray-400">أدخل بياناتك للانضمام إلى المنصة التعليمية</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="text-center">
                            <button onclick="selectRegisterType('student')" id="register-student-btn"
                                    class="w-full p-6 rounded-xl border-2 border-gray-700 hover:border-teal-500 transition-all">
                                <i class="fas fa-user-graduate text-4xl mb-4 text-teal-400"></i>
                                <h3 class="text-xl font-bold mb-2">طالب</h3>
                                <p class="text-gray-400 text-sm">انضم كطالب للوصول إلى المواد والجداول الدراسية</p>
                            </button>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="selectRegisterType('doctor')" id="register-doctor-btn"
                                    class="w-full p-6 rounded-xl border-2 border-gray-700 hover:border-blue-500 transition-all">
                                <i class="fas fa-user-md text-4xl mb-4 text-blue-400"></i>
                                <h3 class="text-xl font-bold mb-2">دكتور</h3>
                                <p class="text-gray-400 text-sm">انضم كأستاذ لإدارة المواد والطلاب والتقييمات</p>
                            </button>
                        </div>
                    </div>
                    
                    <form id="register-form" onsubmit="handleRegister(event)" class="space-y-6">
                        <input type="hidden" id="register-type" value="student">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">الاسم الكامل</label>
                                <div class="relative">
                                    <i class="fas fa-user absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="register-name" 
                                           class="input-field pl-12" 
                                           placeholder="الاسم الكامل"
                                           required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">البريد الإلكتروني</label>
                                <div class="relative">
                                    <i class="fas fa-envelope absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="email" id="register-email" 
                                           class="input-field pl-12" 
                                           placeholder="example@university.edu"
                                           required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">كلمة المرور</label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="password" id="register-password" 
                                           class="input-field pl-12" 
                                           placeholder="••••••••"
                                           minlength="6"
                                           required>
                                    <button type="button" onclick="togglePassword('register-password')" 
                                            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-300">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <p class="mt-2 text-xs text-gray-500">يجب أن تحتوي على 6 أحرف على الأقل</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">تأكيد كلمة المرور</label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="password" id="register-confirm-password" 
                                           class="input-field pl-12" 
                                           placeholder="••••••••"
                                           minlength="6"
                                           required>
                                    <button type="button" onclick="togglePassword('register-confirm-password')" 
                                            class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-300">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقول خاصة بالطالب -->
                        <div id="student-fields" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-3">التخصص</label>
                                    <div class="relative">
                                        <i class="fas fa-graduation-cap absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                        <select id="register-specialization" 
                                                class="input-field pl-12 appearance-none" 
                                                onchange="updateGroupOptions()"
                                                required>
                                            <option value="">اختر التخصص</option>
                                        </select>
                                        <i class="fas fa-chevron-down absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-3">المستوى الدراسي</label>
                                    <div class="relative">
                                        <i class="fas fa-layer-group absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                        <select id="register-level" 
                                                class="input-field pl-12 appearance-none">
                                            <option value="1">المستوى الأول</option>
                                            <option value="2">المستوى الثاني</option>
                                            <option value="3">المستوى الثالث</option>
                                            <option value="4">المستوى الرابع</option>
                                            <option value="5">المستوى الخامس</option>
                                            <option value="6">المستوى السادس</option>
                                            <option value="7">المستوى السابع</option>
                                            <option value="8">المستوى الثامن</option>
                                        </select>
                                        <i class="fas fa-chevron-down absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">المجموعة</label>
                                <div class="relative">
                                    <i class="fas fa-users absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <select id="register-group" 
                                            class="input-field pl-12 appearance-none"
                                            required>
                                        <option value="">اختر المجموعة</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقول خاصة بالدكتور -->
                        <div id="doctor-fields" class="space-y-6 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-3">الدرجة العلمية</label>
                                    <div class="relative">
                                        <i class="fas fa-user-graduate absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                        <select id="register-degree" 
                                                class="input-field pl-12 appearance-none">
                                            <option value="دكتور">دكتور</option>
                                            <option value="أستاذ مساعد">أستاذ مساعد</option>
                                            <option value="أستاذ">أستاذ</option>
                                            <option value="محاضر">محاضر</option>
                                        </select>
                                        <i class="fas fa-chevron-down absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-3">رقم الهاتف</label>
                                    <div class="relative">
                                        <i class="fas fa-phone absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                        <input type="tel" id="register-phone" 
                                               class="input-field pl-12" 
                                               placeholder="05XXXXXXXX">
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">التخصص العلمي</label>
                                <div class="relative">
                                    <i class="fas fa-book absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                    <input type="text" id="register-major" 
                                           class="input-field pl-12" 
                                           placeholder="مثل: علوم الحاسب، هندسة البرمجيات">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="register-terms" 
                                   class="rounded border-gray-600 text-teal-500 focus:ring-teal-500" required>
                            <label for="register-terms" class="mr-2 text-sm text-gray-400">
                                أوافق على <button type="button" onclick="showTermsModal()" class="text-teal-400 hover:text-teal-300">الشروط والأحكام</button> و <button type="button" onclick="showPrivacyModal()" class="text-teal-400 hover:text-teal-300">سياسة الخصوصية</button>
                            </label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="submit" 
                                    class="btn-primary py-4 text-lg font-bold">
                                <i class="fas fa-user-plus ml-2"></i>
                                إنشاء الحساب
                            </button>
                            <button type="button" onclick="showLogin()" 
                                    class="btn-secondary py-4 text-lg font-bold">
                                <i class="fas fa-times ml-2"></i>
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- لوحة التحكم الرئيسية -->
        <div id="dashboard" class="h-full hidden">
            <!-- زر القائمة المتحركة -->
            <button id="menu-toggle" class="menu-toggle no-print" onclick="toggleSidebar()">
                <i class="fas fa-bars text-white"></i>
            </button>
            
            <!-- زر الوضع الداكن -->
            <button id="dark-mode-toggle" class="menu-toggle no-print" style="top: 90px; right: 20px;" onclick="toggleDarkMode()">
                <i class="fas fa-moon text-white"></i>
            </button>
            
            <!-- زر الإشعارات -->
            <button id="notifications-toggle" class="menu-toggle no-print" style="top: 160px; right: 20px;" onclick="toggleNotifications()">
                <i class="fas fa-bell text-white"></i>
                <span id="notification-badge" class="absolute -top-1 -left-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden">3</span>
            </button>
            
            <!-- زر البحث السريع -->
            <button id="quick-search-toggle" class="menu-toggle no-print" style="top: 230px; right: 20px;" onclick="toggleQuickSearch()">
                <i class="fas fa-search text-white"></i>
            </button>
            
            <div class="flex h-full">
                <!-- القائمة الجانبية -->
                <aside id="sidebar" class="w-80 glass-card border-l border-white/10 flex flex-col z-40">
                    <div class="p-6 border-b border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                                    <i class="fas fa-graduation-cap text-2xl text-white"></i>
                                </div>
                                <div id="user-status" class="online-indicator"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h2 class="font-bold text-xl">LMS Pro</h2>
                                <p id="user-role-display" class="text-sm text-gray-400">نظام إدارة التعلم المتكامل</p>
                            </div>
                            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- قسم البحث -->
                    <div class="p-4 border-b border-white/10">
                        <div class="search-box">
                            <input type="text" id="sidebar-search" 
                                   class="search-input" 
                                   placeholder="بحث في النظام..."
                                   onkeyup="handleSidebarSearch(event)">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    
                    <!-- التنقل الرئيسي -->
                    <nav id="sidebar-nav" class="flex-1 p-4 space-y-1 overflow-auto"></nav>
                    
                    <!-- قسم الإحصائيات السريعة -->
                    <div class="p-4 border-t border-white/10 hidden md:block">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="text-center p-3 rounded-xl bg-white/5">
                                <div class="text-2xl font-bold" id="quick-stats-courses">0</div>
                                <div class="text-xs text-gray-400">المقررات</div>
                            </div>
                            <div class="text-center p-3 rounded-xl bg-white/5">
                                <div class="text-2xl font-bold" id="quick-stats-schedule">0</div>
                                <div class="text-xs text-gray-400">محاضرات اليوم</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ملف المستخدم -->
                    <div class="p-4 border-t border-white/10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="relative">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                    <span id="user-avatar" class="font-bold text-white">م</span>
                                </div>
                                <div id="user-status-small" class="online-indicator"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p id="user-name-display" class="font-medium truncate">المستخدم</p>
                                <p id="user-email-display" class="text-xs text-gray-400 truncate">email@example.com</p>
                            </div>
                            <button onclick="showProfileModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="handleLogout()" 
                                    class="py-2 px-4 rounded-xl bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="hidden md:inline">تسجيل الخروج</span>
                            </button>
                            <button onclick="showHelpModal()" 
                                    class="py-2 px-4 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-all flex items-center justify-center gap-2">
                                <i class="fas fa-question-circle"></i>
                                <span class="hidden md:inline">مساعدة</span>
                            </button>
                        </div>
                    </div>
                </aside>
                
                <!-- المحتوى الرئيسي -->
                <main class="flex-1 overflow-auto">
                    <!-- شريط العنوان -->
                    <div class="sticky top-0 z-30 glass-card border-b border-white/10 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 id="page-title" class="text-2xl font-bold"></h1>
                                <p id="page-description" class="text-gray-400 text-sm"></p>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <!-- شريط البحث السريع -->
                                <div id="quick-search-bar" class="hidden">
                                    <div class="search-box">
                                        <input type="text" id="global-search" 
                                               class="search-input" 
                                               placeholder="ابحث عن محاضرة، مقرر، دكتور..."
                                               onkeyup="handleGlobalSearch(event)">
                                        <i class="fas fa-search search-icon"></i>
                                    </div>
                                </div>
                                
                                <!-- أزرار الإجراءات السريعة -->
                                <div id="page-actions" class="flex gap-2"></div>
                                
                                <!-- التاريخ والوقت -->
                                <div class="text-right hidden md:block">
                                    <div id="current-date" class="font-medium"></div>
                                    <div id="current-time" class="text-sm text-gray-400"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- المحتوى الديناميكي -->
                    <div id="main-content" class="p-6"></div>
                    
                    <!-- التذييل -->
                    <footer class="border-t border-white/10 p-6 mt-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h3 class="font-bold mb-3">نظام إدارة المحاضرات</h3>
                                <p class="text-gray-400 text-sm">
                                    منصة متكاملة لإدارة العملية التعليمية بكل جوانبها، مصممة لتلبية احتياجات المؤسسات التعليمية الحديثة.
                                </p>
                            </div>
                            <div>
                                <h3 class="font-bold mb-3">روابط سريعة</h3>
                                <ul class="space-y-2 text-sm text-gray-400">
                                    <li><button onclick="navigateTo('dashboard')" class="hover:text-teal-400">الرئيسية</button></li>
                                    <li><button onclick="showHelpModal()" class="hover:text-teal-400">الدعم الفني</button></li>
                                    <li><button onclick="showAboutModal()" class="hover:text-teal-400">حول النظام</button></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold mb-3">معلومات الاتصال</h3>
                                <ul class="space-y-2 text-sm text-gray-400">
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-phone text-teal-400"></i>
                                        <span>+966 123 456 789</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-envelope text-teal-400"></i>
                                        <span>support@lms.edu</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-white/10 text-center text-sm text-gray-500">
                            <p>© 2024 نظام إدارة المحاضرات الأكاديمية. جميع الحقوق محفوظة.</p>
                        </div>
                    </footer>
                </main>
            </div>
        </div>

        <!-- حاوية التنبيهات -->
        <div id="toast-container" class="fixed bottom-4 left-4 z-50 space-y-2 w-96"></div>
        
        <!-- نافذة الإشعارات -->
        <div id="notifications-panel" class="fixed top-20 right-20 w-96 glass-card rounded-2xl p-6 z-50 hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">الإشعارات</h3>
                <button onclick="toggleNotifications()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="notifications-list" class="space-y-3 max-h-96 overflow-auto">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
            <div class="mt-4 text-center">
                <button onclick="markAllAsRead()" class="text-sm text-teal-400 hover:text-teal-300">
                    تعيين الكل كمقروء
                </button>
            </div>
        </div>
        
        <!-- البحث السريع -->
        <div id="quick-search-panel" class="fixed top-20 right-20 w-96 glass-card rounded-2xl p-6 z-50 hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">البحث السريع</h3>
                <button onclick="toggleQuickSearch()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-box mb-4">
                <input type="text" id="quick-search-input" 
                       class="search-input" 
                       placeholder="اكتب للبحث..."
                       onkeyup="handleQuickSearch(event)">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div id="quick-search-results" class="space-y-2 max-h-80 overflow-auto">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>

        <!-- النماذج المنبثقة -->
        <div id="modal-overlay" class="modal-overlay hidden"></div>
        
        <!-- شاشة المساعدة -->
        <div id="help-modal" class="modal-content hidden">
            <!-- سيتم ملؤها ديناميكياً -->
        </div>
        
        <!-- نافذة الملف الشخصي -->
        <div id="profile-modal" class="modal-content hidden">
            <!-- سيتم ملؤها ديناميكياً -->
        </div>
        
        <!-- نافذة حول النظام -->
        <div id="about-modal" class="modal-content hidden">
            <!-- سيتم ملؤها ديناميكياً -->
        </div>
        
        <!-- نافذة الشروط والأحكام -->
        <div id="terms-modal" class="modal-content hidden">
            <!-- سيتم ملؤها ديناميكياً -->
        </div>
        
        <!-- نافذة سياسة الخصوصية -->
        <div id="privacy-modal" class="modal-content hidden">
            <!-- سيتم ملؤها ديناميكياً -->
        </div>
    </div>

    <script>
        // =============================================
        // تهيئة النظام الأساسية
        // =============================================
        const SYSTEM_CONFIG = {
            VERSION: '2.0.0',
            ENVIRONMENT: 'production',
            DEBUG_MODE: false,
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            SESSION_TIMEOUT: 30 * 60 * 1000, // 30 دقيقة
            ITEMS_PER_PAGE: 20
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyB3U2bt-PuZlUOb0uRPI1aPxL01Yg8lrts",
            authDomain: "universityti-d2e74.firebaseapp.com",
            projectId: "universityti-d2e74",
            storageBucket: "universityti-d2e74.firebasestorage.app",
            messagingSenderId: "205897642006",
            appId: "1:205897642006:web:d63e9753006d55f0b84537",
            measurementId: "G-6JHV42GV0H"
        };

        const DEFAULT_CONFIG = {
            background_color: '#0d1b2a',
            surface_color: '#1e3a5f',
            text_color: '#ffffff',
            primary_action: '#2dd4bf',
            secondary_action: '#14b8a6',
            font_family: 'Tajawal',
            font_size: 16,
            system_title: 'نظام إدارة المحاضرات الأكاديمية',
            welcome_message: 'مرحباً بك في المنصة التعليمية المتكاملة'
        };

        // =============================================
        // المتغيرات العامة للنظام
        // =============================================
        let firebaseApp, auth, db, storage;
        let config = { ...DEFAULT_CONFIG };
        let allData = [];
        let currentUser = null;
        let currentView = 'dashboard';
        let userPreferences = {
            darkMode: false,
            notifications: true,
            compactView: false,
            autoSave: true
        };
        
        let systemNotifications = [];
        let searchIndex = [];
        let dataCache = new Map();
        let lastActivity = Date.now();

        // =============================================
        // الفئات والهياكل الأساسية
        // =============================================
        class User {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.email = data.email;
                this.role = data.role;
                this.specialization_id = data.specialization_id || '';
                this.group_id = data.group_id || '';
                this.avatar = data.avatar || '';
                this.status = data.status || 'active';
                this.lastLogin = data.lastLogin || null;
                this.createdAt = data.createdAt || new Date().toISOString();
            }
        }

        class Course {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.code = data.code;
                this.description = data.description || '';
                this.specialization_id = data.specialization_id;
                this.doctor_id = data.doctor_id;
                this.level = data.level || 1;
                this.hours = data.hours || 3;
                this.course_type = data.course_type || 'theoretical';
                this.status = data.status || 'active';
                this.createdAt = data.createdAt || new Date().toISOString();
            }
        }

        class Schedule {
            constructor(data) {
                this.id = data.id;
                this.course_id = data.course_id;
                this.group_id = data.group_id;
                this.room_id = data.room_id;
                this.day = data.day;
                this.start_time = data.start_time;
                this.end_time = data.end_time;
                this.type = data.type || 'theoretical';
                this.status = data.status || 'scheduled';
                this.createdAt = data.createdAt || new Date().toISOString();
            }
        }

        // =============================================
        // دوال تحميل البيانات من Firebase
        // =============================================
        async function loadInitialData() {
            try {
                updateLoadingProgress(10);
                console.log("🚀 بدأ تحميل البيانات الأولية من Firebase...");
                
                const collections = [
                    { name: 'specializations', type: 'specialization' },
                    { name: 'rooms', type: 'room' },
                    { name: 'groups', type: 'group' },
                    { name: 'users', type: 'user' },
                    { name: 'courses', type: 'course' },
                    { name: 'schedules', type: 'schedule' },
                    { name: 'attendance', type: 'attendance' },
                    { name: 'announcements', type: 'announcement' }
                ];

                for (let i = 0; i < collections.length; i++) {
                    const { name, type } = collections[i];
                    console.log(`📚 جاري تحميل ${name}...`);
                    
                    try {
                        const snapshot = await db.collection(name).get();
                        const data = [];
                        snapshot.forEach(doc => {
                            data.push({
                                type: type,
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // تخزين في الكاش
                        dataCache.set(type, data);
                        allData = allData.concat(data);
                        
                        console.log(`✅ تم تحميل ${data.length} ${name}`);
                        updateLoadingProgress(10 + (i + 1) * 10);
                        
                    } catch (error) {
                        console.error(`❌ خطأ في تحميل ${name}:`, error);
                    }
                }
                
                await checkAndCreateDefaultData();
                buildSearchIndex();
                updateUI();
                updateSpecializationOptions();
                
                showToast('تم تحميل النظام بنجاح 🎉', 'success');
                updateLoadingProgress(100);
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error("❌ خطأ في تحميل البيانات:", error);
                showToast('فشل في تحميل البيانات: ' + error.message, 'error');
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 1000);
            }
        }

        async function checkAndCreateDefaultData() {
            try {
                console.log("🔍 التحقق من وجود بيانات أساسية...");
                
                // التحقق من التخصصات
                const specializations = dataCache.get('specialization') || [];
                if (specializations.length === 0) {
                    console.log("📝 لا توجد تخصصات، جاري إنشاء تخصصات افتراضية...");
                    
                    const defaultSpecializations = [
                        { 
                            name: 'علوم الحاسب', 
                            code: 'CS', 
                            description: 'تخصص علوم الحاسب والبرمجة',
                            levels: 8,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        { 
                            name: 'هندسة البرمجيات', 
                            code: 'SE', 
                            description: 'تخصص هندسة البرمجيات',
                            levels: 8,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        { 
                            name: 'نظم المعلومات', 
                            code: 'IS', 
                            description: 'تخصص نظم المعلومات',
                            levels: 8,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    for (const spec of defaultSpecializations) {
                        const docRef = await db.collection('specializations').add(spec);
                        spec.id = docRef.id;
                        spec.type = 'specialization';
                        
                        allData.push(spec);
                        (dataCache.get('specialization') || []).push(spec);
                    }
                }
                
                // التحقق من القاعات
                const rooms = dataCache.get('room') || [];
                if (rooms.length === 0) {
                    console.log("📝 لا توجد قاعات، جاري إنشاء قاعات افتراضية...");
                    
                    const defaultRooms = [
                        { 
                            name: 'قاعة 101', 
                            type: 'lecture', 
                            capacity: 50, 
                            location: 'المبنى الرئيسي - الطابق الأول',
                            equipment: 'بروجكتر، سبورة ذكية، ميكروفون',
                            status: 'available',
                            createdAt: new Date().toISOString()
                        },
                        { 
                            name: 'معمل البرمجة 1', 
                            type: 'lab', 
                            capacity: 30, 
                            location: 'مبنى الحاسبات - الطابق الثاني',
                            equipment: 'حواسيب، شبكة، برامج تطوير',
                            status: 'available',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    for (const room of defaultRooms) {
                        const docRef = await db.collection('rooms').add(room);
                        room.id = docRef.id;
                        room.type = 'room';
                        
                        allData.push(room);
                        (dataCache.get('room') || []).push(room);
                    }
                }
                
                // التحقق من المستخدمين الإداريين
                const users = dataCache.get('user') || [];
                const adminUsers = users.filter(u => u.role === 'admin');
                if (adminUsers.length === 0) {
                    console.log("👑 لا يوجد مستخدمين إداريين، جاري إنشاء مدير النظام...");
                    
                    const adminData = {
                        name: 'مدير النظام',
                        email: 'admin@university.edu',
                        role: 'admin',
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    };
                    
                    // سيتم إنشاء الحساب في Firebase Authentication بشكل منفصل
                }
                
                console.log("✅ اكتمل التحقق من البيانات الأساسية");
                
            } catch (error) {
                console.error("❌ خطأ في التحقق من البيانات الأساسية:", error);
            }
        }

        function buildSearchIndex() {
            searchIndex = [];
            
            allData.forEach(item => {
                if (item.type === 'course') {
                    searchIndex.push({
                        id: item.id,
                        type: 'course',
                        title: item.name,
                        description: `كود: ${item.code} | نوع: ${item.course_type === 'theoretical' ? 'نظري' : 'عملي'}`,
                        searchText: `${item.name} ${item.code} ${item.description || ''}`.toLowerCase()
                    });
                } else if (item.type === 'user' && item.role === 'doctor') {
                    searchIndex.push({
                        id: item.id,
                        type: 'doctor',
                        title: item.name,
                        description: `دكتور ${item.major || ''}`,
                        searchText: `${item.name} ${item.email} ${item.major || ''}`.toLowerCase()
                    });
                } else if (item.type === 'schedule') {
                    const course = allData.find(c => c.id === item.course_id && c.type === 'course');
                    if (course) {
                        searchIndex.push({
                            id: item.id,
                            type: 'schedule',
                            title: course.name,
                            description: `اليوم: ${getDayName(item.day)} | الوقت: ${item.start_time}-${item.end_time}`,
                            searchText: `${course.name} ${getDayName(item.day)} ${item.start_time}`.toLowerCase()
                        });
                    }
                }
            });
        }

        // =============================================
        // دوال واجهة المستخدم العامة
        // =============================================
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.className = `toast toast-${type} flex items-center gap-3`;
            toast.innerHTML = `
                <i class="fas ${icons[type] || 'fa-info-circle'} text-lg"></i>
                <div class="flex-1">${message}</div>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease reverse forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        function showModal(modalId, content = null) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('modal-overlay');
            
            if (content) {
                modal.innerHTML = content;
            }
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.classList.add('hidden');
            });
            document.getElementById('modal-overlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function updateLoadingProgress(percent) {
            const progressBar = document.getElementById('loading-progress');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
        }

        function applyConfig() {
            // تطبيق تخصيصات الألوان
            document.documentElement.style.setProperty('--primary-color', config.primary_action);
            document.documentElement.style.setProperty('--secondary-color', config.secondary_action);
            document.documentElement.style.setProperty('--background-color', config.background_color);
            document.documentElement.style.setProperty('--surface-color', config.surface_color);
            document.documentElement.style.setProperty('--text-color', config.text_color);
            
            // تطبيق الخطوط
            document.body.style.fontFamily = `${config.font_family}, sans-serif`;
            document.body.style.fontSize = `${config.font_size}px`;
            
            // تحديث النصوص
            document.getElementById('system-title').textContent = config.system_title;
            document.getElementById('welcome-text').textContent = config.welcome_message;
        }

        // =============================================
        // دوال المصادقة والمستخدمين
        // =============================================
        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const userType = document.getElementById('user-type').value;
            const rememberMe = document.getElementById('remember-me').checked;

            if (!email || !password) {
                showToast('يرجى إدخال جميع البيانات', 'error');
                return;
            }

            try {
                // التحقق من دخول المدير
                if (userType === 'admin') {
                    if (email === 'admin@university.edu' && password === 'admin123') {
                        currentUser = new User({
                            id: 'admin_001',
                            name: 'مدير النظام',
                            email: email,
                            role: 'admin',
                            status: 'active'
                        });
                        
                        // حفظ تفضيلات المستخدم
                        if (rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                email: email,
                                type: 'admin'
                            }));
                        }
                        
                        showDashboard();
                        showToast('مرحباً بك يا مدير النظام 👑', 'success');
                        return;
                    } else {
                        showToast('بيانات الدخول غير صحيحة', 'error');
                        return;
                    }
                }

                // تسجيل الدخول عبر Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // الحصول على بيانات المستخدم
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const userRole = userData.role?.toLowerCase();
                    const requestedRole = userType.toLowerCase();
                    
                    if (userRole === requestedRole) {
                        currentUser = new User({
                            id: user.uid,
                            name: userData.name || 'مستخدم',
                            email: user.email,
                            role: userRole,
                            specialization_id: userData.specialization_id || '',
                            group_id: userData.group_id || '',
                            avatar: userData.avatar || '',
                            status: userData.status || 'active'
                        });
                        
                        // تحديث آخر تسجيل دخول
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: new Date().toISOString()
                        });
                        
                        // حفظ تفضيلات المستخدم
                        if (rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                email: email,
                                type: userType
                            }));
                        }
                        
                        showDashboard();
                        showToast(`مرحباً ${currentUser.name} 👋`, 'success');
                    } else {
                        showToast(`نوع المستخدم غير متطابق. أنت مسجل كـ ${userRole === 'doctor' ? 'دكتور' : 'طالب'}`, 'error');
                        await auth.signOut();
                    }
                } else {
                    showToast('بيانات المستخدم غير موجودة', 'error');
                    await auth.signOut();
                }
            } catch (error) {
                console.error("Login error:", error);
                handleAuthError(error);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const type = document.getElementById('register-type').value;
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (!name || !email || !password || !confirmPassword) {
                showToast('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('كلمة المرور غير متطابقة', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            if (type === 'student') {
                const specialization = document.getElementById('register-specialization').value;
                const group = document.getElementById('register-group').value;
                
                if (!specialization || !group) {
                    showToast('يرجى اختيار التخصص والمجموعة', 'error');
                    return;
                }
            }

            try {
                // إنشاء المستخدم في Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // تحضير بيانات المستخدم
                const userData = {
                    name: name,
                    email: email,
                    role: type,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                if (type === 'student') {
                    userData.specialization_id = document.getElementById('register-specialization').value;
                    userData.group_id = document.getElementById('register-group').value;
                    userData.level = document.getElementById('register-level').value;
                } else if (type === 'doctor') {
                    userData.degree = document.getElementById('register-degree').value;
                    userData.phone = document.getElementById('register-phone').value;
                    userData.major = document.getElementById('register-major').value;
                }

                // حفظ بيانات المستخدم في Firestore
                await db.collection('users').doc(user.uid).set(userData);
                
                // إرسال بريد التحقق
                await user.sendEmailVerification();
                
                showToast('تم التسجيل بنجاح ✅ يرجى التحقق من بريدك الإلكتروني', 'success');
                showLogin();
                
            } catch (error) {
                console.error("Registration error:", error);
                handleAuthError(error);
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('reset-email').value.trim();
            
            if (!email) {
                showToast('يرجى إدخال البريد الإلكتروني', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showToast('تم إرسال رابط استعادة كلمة المرور إلى بريدك الإلكتروني', 'success');
                showLogin();
            } catch (error) {
                console.error("Password reset error:", error);
                handleAuthError(error);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                localStorage.removeItem('userPreferences');
                sessionStorage.clear();
                
                currentUser = null;
                currentView = 'dashboard';
                
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                
                showToast('تم تسجيل الخروج بنجاح', 'info');
            } catch (error) {
                console.error("Logout error:", error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
            }
        }

        function handleAuthError(error) {
            switch(error.code) {
                case 'auth/user-not-found':
                    showToast('المستخدم غير موجود', 'error');
                    break;
                case 'auth/wrong-password':
                    showToast('كلمة المرور غير صحيحة', 'error');
                    break;
                case 'auth/invalid-email':
                    showToast('البريد الإلكتروني غير صالح', 'error');
                    break;
                case 'auth/email-already-in-use':
                    showToast('البريد الإلكتروني مسجل بالفعل', 'error');
                    break;
                case 'auth/weak-password':
                    showToast('كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل', 'error');
                    break;
                case 'auth/network-request-failed':
                    showToast('خطأ في الاتصال بالشبكة', 'error');
                    break;
                default:
                    showToast('حدث خطأ: ' + error.message, 'error');
            }
        }

        // =============================================
        // دوال التنقل والعرض
        // =============================================
        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('forgot-password-page').classList.add('hidden');
            
            // استعادة البيانات المحفوظة
            const remembered = localStorage.getItem('rememberedUser');
            if (remembered) {
                const { email, type } = JSON.parse(remembered);
                document.getElementById('login-email').value = email || '';
                document.getElementById('user-type').value = type || 'student';
                selectUserType(type || 'student');
                document.getElementById('remember-me').checked = true;
            }
        }

        function showRegister() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.remove('hidden');
            updateSpecializationOptions();
            selectRegisterType('student');
        }

        function showForgotPassword() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('forgot-password-page').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // تحديث معلومات المستخدم
            document.getElementById('user-name-display').textContent = currentUser.name;
            document.getElementById('user-email-display').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
            document.getElementById('user-role-display').textContent = 
                currentUser.role === 'admin' ? 'لوحة العمادة' :
                currentUser.role === 'doctor' ? 'لوحة الدكتور' : 'لوحة الطالب';
            
            // تحديث القائمة الجانبية والمحتوى
            renderSidebar();
            renderContent();
            updateDateTime();
            
            // بدء تحديث الوقت
            setInterval(updateDateTime, 60000);
            
            // مراقبة النشاط
            setupActivityMonitor();
        }

        function selectUserType(type) {
            document.getElementById('user-type').value = type;
            
            // تحديث أزرار الاختيار
            ['student', 'doctor', 'admin'].forEach(t => {
                const btn = document.getElementById(`${t}-btn`);
                if (btn) {
                    btn.classList.remove('border-teal-500', 'border-blue-500', 'border-purple-500');
                    btn.classList.add('border-gray-700');
                }
            });
            
            const selectedBtn = document.getElementById(`${type}-btn`);
            if (selectedBtn) {
                const borderColor = type === 'student' ? 'teal-500' : 
                                  type === 'doctor' ? 'blue-500' : 'purple-500';
                selectedBtn.classList.remove('border-gray-700');
                selectedBtn.classList.add(`border-${borderColor}`);
            }
        }

        function selectRegisterType(type) {
            document.getElementById('register-type').value = type;
            
            // تحديث أزرار الاختيار
            const studentBtn = document.getElementById('register-student-btn');
            const doctorBtn = document.getElementById('register-doctor-btn');
            
            studentBtn.classList.remove('border-teal-500', 'border-blue-500');
            doctorBtn.classList.remove('border-teal-500', 'border-blue-500');
            
            if (type === 'student') {
                studentBtn.classList.add('border-teal-500');
                document.getElementById('student-fields').classList.remove('hidden');
                document.getElementById('doctor-fields').classList.add('hidden');
            } else {
                doctorBtn.classList.add('border-blue-500');
                document.getElementById('student-fields').classList.add('hidden');
                document.getElementById('doctor-fields').classList.remove('hidden');
            }
        }

        function updateSpecializationOptions() {
            try {
                const specializations = dataCache.get('specialization') || [];
                const select = document.getElementById('register-specialization');
                
                if (select) {
                    select.innerHTML = '<option value="">اختر التخصص</option>' + 
                        specializations.map(s => `
                            <option value="${s.id}">${s.name} (${s.code})</option>
                        `).join('');
                    
                    updateGroupOptions();
                }
            } catch (error) {
                console.error("Error in updateSpecializationOptions:", error);
            }
        }

        function updateGroupOptions() {
            try {
                const specializationId = document.getElementById('register-specialization')?.value;
                const groups = dataCache.get('group') || [];
                const filteredGroups = specializationId ? 
                    groups.filter(g => g.specialization_id === specializationId) : 
                    [];
                
                const groupSelect = document.getElementById('register-group');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">اختر المجموعة</option>' + 
                        filteredGroups.map(g => `
                            <option value="${g.id}">${g.name} (سعة: ${g.capacity || 30})</option>
                        `).join('');
                }
            } catch (error) {
                console.error("Error in updateGroupOptions:", error);
            }
        }

        // =============================================
        // دوال القائمة الجانبية
        // =============================================
        const navigationConfig = {
            admin: [
                { id: 'dashboard', icon: 'fas fa-tachometer-alt', label: 'لوحة التحكم' },
                { id: 'specializations', icon: 'fas fa-graduation-cap', label: 'التخصصات' },
                { id: 'doctors', icon: 'fas fa-user-md', label: 'الدكاترة' },
                { id: 'students', icon: 'fas fa-users', label: 'الطلاب' },
                { id: 'courses', icon: 'fas fa-book', label: 'المقررات' },
                { id: 'schedules', icon: 'fas fa-calendar-alt', label: 'الجداول' },
                { id: 'rooms', icon: 'fas fa-building', label: 'القاعات' },
                { id: 'groups', icon: 'fas fa-layer-group', label: 'المجموعات' },
                { id: 'attendance', icon: 'fas fa-clipboard-check', label: 'الحضور' },
                { id: 'announcements', icon: 'fas fa-bullhorn', label: 'الإعلانات' },
                { id: 'reports', icon: 'fas fa-chart-bar', label: 'التقارير' },
                { id: 'settings', icon: 'fas fa-cog', label: 'الإعدادات' }
            ],
            doctor: [
                { id: 'dashboard', icon: 'fas fa-tachometer-alt', label: 'لوحة التحكم' },
                { id: 'my-schedule', icon: 'fas fa-calendar-alt', label: 'جدولي' },
                { id: 'my-courses', icon: 'fas fa-book', label: 'موادي' },
                { id: 'my-students', icon: 'fas fa-users', label: 'طلابي' },
                { id: 'attendance', icon: 'fas fa-clipboard-check', label: 'الحضور' },
                { id: 'assignments', icon: 'fas fa-tasks', label: 'الواجبات' },
                { id: 'grades', icon: 'fas fa-star', label: 'التقييمات' },
                { id: 'messages', icon: 'fas fa-comments', label: 'الرسائل' }
            ],
            student: [
                { id: 'dashboard', icon: 'fas fa-tachometer-alt', label: 'لوحة التحكم' },
                { id: 'full-schedule', icon: 'fas fa-calendar-alt', label: 'الجدول الكامل' },
                { id: 'today-schedule', icon: 'fas fa-calendar-day', label: 'جدول اليوم' },
                { id: 'my-courses', icon: 'fas fa-book', label: 'مقرراتي' },
                { id: 'my-doctors', icon: 'fas fa-user-md', label: 'دكاترتي' },
                { id: 'my-attendance', icon: 'fas fa-clipboard-check', label: 'حضوري' },
                { id: 'assignments', icon: 'fas fa-tasks', label: 'الواجبات' },
                { id: 'grades', icon: 'fas fa-star', label: 'درجاتي' },
                { id: 'materials', icon: 'fas fa-folder', label: 'المواد' },
                { id: 'announcements', icon: 'fas fa-bullhorn', label: 'الإعلانات' }
            ]
        };

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const navItems = navigationConfig[currentUser.role] || [];
            
            nav.innerHTML = navItems.map(item => `
                <button onclick="navigateTo('${item.id}')" 
                        class="sidebar-item w-full flex items-center gap-4 p-3 text-gray-300 hover:text-white ${currentView === item.id ? 'active' : ''}">
                    <i class="${item.icon} w-5 text-center"></i>
                    <span class="flex-1 text-right">${item.label}</span>
                    ${item.badge ? `<span class="badge badge-primary">${item.badge}</span>` : ''}
                </button>
            `).join('');
            
            // تحديث الإحصائيات السريعة
            updateQuickStats();
        }

        function navigateTo(viewId) {
            currentView = viewId;
            renderSidebar();
            renderContent();
            updatePageTitle();
            
            // إغلاق القائمة الجانبية على الأجهزة المحمولة
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
        }

        // =============================================
        // دوال التصيير الرئيسية
        // =============================================
        function renderContent() {
            const container = document.getElementById('main-content');
            container.innerHTML = '';
            
            switch(currentUser.role) {
                case 'admin':
                    renderAdminContent(container);
                    break;
                case 'doctor':
                    renderDoctorContent(container);
                    break;
                case 'student':
                    renderStudentContent(container);
                    break;
            }
        }

        function updatePageTitle() {
            const titles = {
                dashboard: 'لوحة التحكم',
                specializations: 'إدارة التخصصات',
                doctors: 'إدارة الدكاترة',
                students: 'إدارة الطلاب',
                courses: 'إدارة المقررات',
                schedules: 'جدولة المحاضرات',
                rooms: 'إدارة القاعات',
                groups: 'إدارة المجموعات',
                attendance: 'إدارة الحضور',
                announcements: 'الإعلانات',
                reports: 'التقارير والإحصائيات',
                settings: 'إعدادات النظام',
                'my-schedule': 'جدولي الأسبوعي',
                'my-courses': 'موادي الدراسية',
                'my-students': 'طلابي',
                assignments: 'الواجبات',
                grades: 'التقييمات',
                messages: 'الرسائل',
                'full-schedule': 'الجدول الدراسي الكامل',
                'today-schedule': 'جدول اليوم',
                'my-doctors': 'دكاترتي',
                'my-attendance': 'حضوري الشخصي',
                materials: 'المواد التعليمية'
            };
            
            const descriptions = {
                dashboard: 'نظرة عامة على النظام والإحصائيات',
                specializations: 'إدارة التخصصات الأكاديمية',
                doctors: 'إدارة أعضاء هيئة التدريس',
                students: 'إدارة الطلاب المسجلين',
                courses: 'إدارة المواد الدراسية',
                schedules: 'جدولة المحاضرات النظرية والعملية',
                rooms: 'إدارة القاعات والمعامل',
                groups: 'إدارة مجموعات الطلاب',
                attendance: 'تتبع حضور الطلاب',
                announcements: 'الإعلانات والنشرات',
                reports: 'تقارير وإحصائيات النظام',
                settings: 'إعدادات وتخصيص النظام'
            };
            
            document.getElementById('page-title').textContent = titles[currentView] || 'لوحة التحكم';
            document.getElementById('page-description').textContent = descriptions[currentView] || '';
            
            updatePageActions();
        }

        function updatePageActions() {
            const actionsContainer = document.getElementById('page-actions');
            actionsContainer.innerHTML = '';
            
            const actions = {
                dashboard: [
                    { icon: 'fas fa-sync-alt', label: 'تحديث', onClick: 'refreshDashboard()', color: 'primary' }
                ],
                specializations: [
                    { icon: 'fas fa-plus', label: 'إضافة تخصص', onClick: 'showAddSpecializationModal()', color: 'primary' },
                    { icon: 'fas fa-download', label: 'تصدير', onClick: 'exportSpecializations()', color: 'secondary' }
                ],
                courses: [
                    { icon: 'fas fa-plus', label: 'إضافة مقرر', onClick: 'showAddCourseModal()', color: 'primary' },
                    { icon: 'fas fa-filter', label: 'تصفية', onClick: 'showFilterModal()', color: 'secondary' }
                ],
                schedules: [
                    { icon: 'fas fa-plus', label: 'إضافة محاضرة', onClick: 'showAddScheduleModal()', color: 'primary' },
                    { icon: 'fas fa-print', label: 'طباعة', onClick: 'printSchedule()', color: 'secondary' }
                ]
            };
            
            const currentActions = actions[currentView] || [];
            currentActions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = `btn-${action.color} flex items-center gap-2 px-4 py-2`;
                btn.innerHTML = `<i class="${action.icon}"></i><span class="hidden md:inline">${action.label}</span>`;
                btn.onclick = new Function(action.onClick);
                actionsContainer.appendChild(btn);
            });
        }

        // =============================================
        // دوال واجهة العمادة (Admin)
        // =============================================
        function renderAdminContent(container) {
            switch(currentView) {
                case 'dashboard':
                    renderAdminDashboard(container);
                    break;
                case 'specializations':
                    renderAdminSpecializations(container);
                    break;
                case 'doctors':
                    renderAdminDoctors(container);
                    break;
                case 'students':
                    renderAdminStudents(container);
                    break;
                case 'courses':
                    renderAdminCourses(container);
                    break;
                case 'schedules':
                    renderAdminSchedules(container);
                    break;
                case 'rooms':
                    renderAdminRooms(container);
                    break;
                case 'groups':
                    renderAdminGroups(container);
                    break;
                case 'attendance':
                    renderAdminAttendance(container);
                    break;
                case 'announcements':
                    renderAdminAnnouncements(container);
                    break;
                case 'reports':
                    renderAdminReports(container);
                    break;
                case 'settings':
                    renderAdminSettings(container);
                    break;
                default:
                    renderAdminDashboard(container);
            }
        }

        function renderAdminDashboard(container) {
            const stats = calculateAdminStats();
            
            container.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold mb-2">مرحباً ${currentUser.name} 👋</h1>
                    <p class="text-gray-400 text-lg">نظرة عامة على النظام والإحصائيات</p>
                </div>
                
                <!-- بطاقات الإحصائيات -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-primary">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.specializations}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">التخصصات</h3>
                        <p class="text-gray-400 text-sm">الأقسام الأكاديمية</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-blue">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.doctors}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">الدكاترة</h3>
                        <p class="text-gray-400 text-sm">أعضاء هيئة التدريس</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-green">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.students}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">الطلاب</h3>
                        <p class="text-gray-400 text-sm">المسجلين في النظام</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-purple">
                                <i class="fas fa-book"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.courses}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">المقررات</h3>
                        <p class="text-gray-400 text-sm">المواد الدراسية</p>
                    </div>
                </div>
                
                <!-- مخططات وإحصائيات -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">توزيع الطلاب على التخصصات</h2>
                        <div id="specialization-chart" class="h-64">
                            <!-- سيتم ملؤها ديناميكياً -->
                            ${renderSpecializationChart()}
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">إحصائيات الحضور</h2>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>الحضور العام</span>
                                    <span>${stats.attendanceRate}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${stats.attendanceRate}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>المحاضرات النظرية</span>
                                    <span>${stats.theoreticalRate}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-blue-500" style="width: ${stats.theoreticalRate}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>المحاضرات العملية</span>
                                    <span>${stats.practicalRate}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-orange-500" style="width: ${stats.practicalRate}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- الإجراءات السريعة -->
                <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4">إجراءات سريعة</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="navigateTo('specializations')" class="btn-primary py-3">
                            <i class="fas fa-plus ml-2"></i> إضافة تخصص
                        </button>
                        <button onclick="navigateTo('doctors')" class="btn-primary py-3">
                            <i class="fas fa-plus ml-2"></i> إضافة دكتور
                        </button>
                        <button onclick="navigateTo('courses')" class="btn-primary py-3">
                            <i class="fas fa-plus ml-2"></i> إضافة مقرر
                        </button>
                        <button onclick="navigateTo('schedules')" class="btn-primary py-3">
                            <i class="fas fa-plus ml-2"></i> جدولة محاضرة
                        </button>
                    </div>
                </div>
                
                <!-- أحدث الإعلانات -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">أحدث الإعلانات</h2>
                        <button onclick="navigateTo('announcements')" class="text-teal-400 hover:text-teal-300">
                            عرض الكل <i class="fas fa-arrow-left ml-2"></i>
                        </button>
                    </div>
                    <div id="recent-announcements">
                        ${renderRecentAnnouncements()}
                    </div>
                </div>
            `;
        }

        function renderAdminSpecializations(container) {
            const specializations = dataCache.get('specialization') || [];
            
            container.innerHTML = `
                <div class="mb-8">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">إدارة التخصصات</h1>
                            <p class="text-gray-400">إدارة التخصصات الأكاديمية والبرامج الدراسية</p>
                        </div>
                        <button onclick="showAddSpecializationModal()" class="btn-primary px-6 py-3">
                            <i class="fas fa-plus ml-2"></i> إضافة تخصص
                        </button>
                    </div>
                </div>
                
                <!-- فلترة البحث -->
                <div class="glass-card rounded-2xl p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="search-box">
                            <input type="text" id="search-specializations" 
                                   class="search-input" 
                                   placeholder="ابحث عن تخصص..."
                                   onkeyup="filterSpecializations()">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <select id="filter-status" class="input-field" onchange="filterSpecializations()">
                            <option value="">جميع الحالات</option>
                            <option value="active">نشط</option>
                            <option value="inactive">غير نشط</option>
                        </select>
                        <button onclick="resetSpecializationFilters()" class="btn-secondary">
                            <i class="fas fa-redo ml-2"></i> إعادة تعيين
                        </button>
                    </div>
                </div>
                
                <!-- جدول التخصصات -->
                <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>الرمز</th>
                                    <th>اسم التخصص</th>
                                    <th>عدد المستويات</th>
                                    <th>عدد المقررات</th>
                                    <th>عدد الطلاب</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="specializations-table-body">
                                ${specializations.map(spec => {
                                    const courses = (dataCache.get('course') || []).filter(c => c.specialization_id === spec.id).length;
                                    const students = (dataCache.get('user') || []).filter(u => u.role === 'student' && u.specialization_id === spec.id).length;
                                    
                                    return `
                                        <tr>
                                            <td><span class="font-mono bg-gray-800 px-2 py-1 rounded">${spec.code}</span></td>
                                            <td>
                                                <div class="font-medium">${spec.name}</div>
                                                <div class="text-sm text-gray-400">${spec.description || 'لا يوجد وصف'}</div>
                                            </td>
                                            <td>${spec.levels || 8}</td>
                                            <td>${courses}</td>
                                            <td>${students}</td>
                                            <td>
                                                <span class="status-badge status-${spec.status || 'active'}">
                                                    ${spec.status === 'active' ? 'نشط' : 'غير نشط'}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="flex gap-2">
                                                    <button onclick="editSpecialization('${spec.id}')" 
                                                            class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="viewSpecializationDetails('${spec.id}')" 
                                                            class="px-3 py-1 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="deleteSpecialization('${spec.id}')" 
                                                            class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- الترقيم -->
                    <div class="p-4 border-t border-white/10 flex justify-between items-center">
                        <div class="text-gray-400">
                            إظهار <span id="current-items">${specializations.length}</span> من <span id="total-items">${specializations.length}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10 disabled:opacity-50" disabled>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10">
                                1
                            </button>
                            <button class="px-3 py-1 rounded-lg bg-teal-500/20 text-teal-400">
                                2
                            </button>
                            <button class="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // دوال واجهة الدكتور
        // =============================================
        function renderDoctorContent(container) {
            switch(currentView) {
                case 'dashboard':
                    renderDoctorDashboard(container);
                    break;
                case 'my-schedule':
                    renderDoctorSchedule(container);
                    break;
                case 'my-courses':
                    renderDoctorCourses(container);
                    break;
                case 'my-students':
                    renderDoctorStudents(container);
                    break;
                case 'attendance':
                    renderDoctorAttendance(container);
                    break;
                case 'assignments':
                    renderDoctorAssignments(container);
                    break;
                case 'grades':
                    renderDoctorGrades(container);
                    break;
                case 'messages':
                    renderDoctorMessages(container);
                    break;
                default:
                    renderDoctorDashboard(container);
            }
        }

        function renderDoctorDashboard(container) {
            const stats = calculateDoctorStats();
            
            container.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold mb-2">مرحباً دكتور ${currentUser.name} 👨‍🏫</h1>
                    <p class="text-gray-400 text-lg">لوحة تحكم الدكتور</p>
                </div>
                
                <!-- بطاقات الإحصائيات -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-primary">
                                <i class="fas fa-book"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.courses}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">المقررات</h3>
                        <p class="text-gray-400 text-sm">المواد المسندة إليك</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.students}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">الطلاب</h3>
                        <p class="text-gray-400 text-sm">الطلاب المسجلين في مقرراتك</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-green">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.todayLectures}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">محاضرات اليوم</h3>
                        <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-purple">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.attendanceRate}%</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">نسبة الحضور</h3>
                        <p class="text-gray-400 text-sm">متوسط حضور الطلاب</p>
                    </div>
                </div>
                
                <!-- محاضرات اليوم -->
                <div class="glass-card rounded-2xl p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4">محاضرات اليوم</h2>
                    <div id="today-lectures-list">
                        ${renderTodayLectures()}
                    </div>
                </div>
                
                <!-- الإجراءات السريعة -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">إجراءات سريعة</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="navigateTo('attendance')" class="btn-primary py-3">
                                <i class="fas fa-clipboard-check ml-2"></i> تسجيل حضور
                            </button>
                            <button onclick="navigateTo('assignments')" class="btn-primary py-3">
                                <i class="fas fa-tasks ml-2"></i> إضافة واجب
                            </button>
                            <button onclick="navigateTo('grades')" class="btn-secondary py-3">
                                <i class="fas fa-star ml-2"></i> تقييم طلاب
                            </button>
                            <button onclick="navigateTo('messages')" class="btn-secondary py-3">
                                <i class="fas fa-comments ml-2"></i> الرسائل
                            </button>
                        </div>
                    </div>
                    
                    <div class="glasscard rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">أحدث المقررات</h2>
                        <div class="space-y-3">
                            ${renderRecentCourses()}
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // دوال واجهة الطالب
        // =============================================
        function renderStudentContent(container) {
            switch(currentView) {
                case 'dashboard':
                    renderStudentDashboard(container);
                    break;
                case 'full-schedule':
                    renderStudentFullSchedule(container);
                    break;
                case 'today-schedule':
                    renderStudentTodaySchedule(container);
                    break;
                case 'my-courses':
                    renderStudentCourses(container);
                    break;
                case 'my-doctors':
                    renderStudentDoctors(container);
                    break;
                case 'my-attendance':
                    renderStudentAttendance(container);
                    break;
                case 'assignments':
                    renderStudentAssignments(container);
                    break;
                case 'grades':
                    renderStudentGrades(container);
                    break;
                case 'materials':
                    renderStudentMaterials(container);
                    break;
                case 'announcements':
                    renderStudentAnnouncements(container);
                    break;
                default:
                    renderStudentDashboard(container);
            }
        }

        function renderStudentDashboard(container) {
            const stats = calculateStudentStats();
            
            container.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-bold mb-2">مرحباً ${currentUser.name} 👨‍🎓</h1>
                    <p class="text-gray-400 text-lg">لوحة تحكم الطالب</p>
                </div>
                
                <!-- بطاقات الإحصائيات -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-primary">
                                <i class="fas fa-book"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.courses}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">المقررات</h3>
                        <p class="text-gray-400 text-sm">المواد المسجلة</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-blue">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.todayLectures}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">محاضرات اليوم</h3>
                        <p class="text-gray-400 text-sm">المحاضرات المجدولة اليوم</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-green">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.attendanceRate}%</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">نسبة الحضور</h3>
                        <p class="text-gray-400 text-sm">حضورك الشخصي</p>
                    </div>
                    
                    <div class="stats-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="icon-circle icon-purple">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <span class="text-3xl font-bold">${stats.pendingAssignments}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">واجبات معلقة</h3>
                        <p class="text-gray-400 text-sm">الواجبات التي تحتاج تسليم</p>
                    </div>
                </div>
                
                <!-- جدول اليوم -->
                <div class="glass-card rounded-2xl p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4">جدول اليوم</h2>
                    <div id="student-today-schedule">
                        ${renderStudentTodayScheduleContent()}
                    </div>
                </div>
                
                <!-- المعلومات الشخصية -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">معلومات التخصص</h2>
                        ${renderStudentSpecializationInfo()}
                    </div>
                    
                    <div class="glasscard rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">الإشعارات المهمة</h2>
                        <div class="space-y-3">
                            ${renderImportantNotifications()}
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // دوال مساعدة
        // =============================================
        function calculateAdminStats() {
            const specializations = (dataCache.get('specialization') || []).length;
            const doctors = (dataCache.get('user') || []).filter(u => u.role === 'doctor').length;
            const students = (dataCache.get('user') || []).filter(u => u.role === 'student').length;
            const courses = (dataCache.get('course') || []).length;
            
            return {
                specializations,
                doctors,
                students,
                courses,
                attendanceRate: 85,
                theoreticalRate: 88,
                practicalRate: 82
            };
        }

        function calculateDoctorStats() {
            const courses = (dataCache.get('course') || []).filter(c => c.doctor_id === currentUser.id).length;
            const schedules = dataCache.get('schedule') || [];
            const today = new Date().getDay();
            
            // حساب عدد الطلاب في مقررات الدكتور
            let studentCount = 0;
            const doctorCourses = (dataCache.get('course') || []).filter(c => c.doctor_id === currentUser.id);
            doctorCourses.forEach(course => {
                const courseGroups = (dataCache.get('group') || []).filter(g => g.specialization_id === course.specialization_id);
                courseGroups.forEach(group => {
                    const groupStudents = (dataCache.get('user') || []).filter(u => u.group_id === group.id && u.role === 'student').length;
                    studentCount += groupStudents;
                });
            });
            
            const todayLectures = schedules.filter(s => {
                const course = (dataCache.get('course') || []).find(c => c.id === s.course_id);
                return course && course.doctor_id === currentUser.id && s.day === today;
            }).length;
            
            return {
                courses,
                students: studentCount,
                todayLectures,
                attendanceRate: 87
            };
        }

        function calculateStudentStats() {
            const courses = (dataCache.get('course') || []).length; // مؤقت
            const schedules = dataCache.get('schedule') || [];
            const today = new Date().getDay();
            
            const todayLectures = schedules.filter(s => s.group_id === currentUser.group_id && s.day === today).length;
            
            return {
                courses,
                todayLectures,
                attendanceRate: 92,
                pendingAssignments: 3
            };
        }

        function renderSpecializationChart() {
            const specializations = dataCache.get('specialization') || [];
            let html = '<div class="space-y-4">';
            
            specializations.forEach(spec => {
                const students = (dataCache.get('user') || []).filter(u => u.role === 'student' && u.specialization_id === spec.id).length;
                const totalStudents = (dataCache.get('user') || []).filter(u => u.role === 'student').length;
                const percentage = totalStudents > 0 ? Math.round((students / totalStudents) * 100) : 0;
                
                html += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span>${spec.name}</span>
                            <span>${students} طالب (${percentage}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderRecentAnnouncements() {
            const announcements = (dataCache.get('announcement') || []).slice(0, 3);
            
            if (announcements.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-bullhorn text-4xl mb-3"></i>
                        <p>لا توجد إعلانات حالياً</p>
                    </div>
                `;
            }
            
            let html = '<div class="space-y-4">';
            announcements.forEach(announcement => {
                const timeAgo = getTimeAgo(announcement.createdAt);
                
                html += `
                    <div class="glass-card rounded-xl p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold">${announcement.title}</h3>
                            <span class="text-sm text-gray-400">${timeAgo}</span>
                        </div>
                        <p class="text-gray-300 text-sm">${announcement.content.substring(0, 100)}...</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs text-gray-400">
                                <i class="fas fa-user ml-1"></i> ${announcement.author || 'الإدارة'}
                            </span>
                            <button onclick="viewAnnouncement('${announcement.id}')" class="text-teal-400 text-sm hover:text-teal-300">
                                قراءة المزيد <i class="fas fa-arrow-left ml-1"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderTodayLectures() {
            const schedules = dataCache.get('schedule') || [];
            const today = new Date().getDay();
            const currentTime = new Date().getHours() * 60 + new Date().getMinutes();
            
            const todayLectures = schedules.filter(schedule => {
                const course = (dataCache.get('course') || []).find(c => c.id === schedule.course_id);
                return course && course.doctor_id === currentUser.id && schedule.day === today;
            }).sort((a, b) => {
                const timeA = parseTime(a.start_time);
                const timeB = parseTime(b.start_time);
                return timeA - timeB;
            });
            
            if (todayLectures.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar-times text-4xl mb-3"></i>
                        <p>لا توجد محاضرات مجدولة اليوم</p>
                    </div>
                `;
            }
            
            let html = '<div class="space-y-3">';
            todayLectures.forEach(lecture => {
                const course = (dataCache.get('course') || []).find(c => c.id === lecture.course_id);
                const room = (dataCache.get('room') || []).find(r => r.id === lecture.room_id);
                const group = (dataCache.get('group') || []).find(g => g.id === lecture.group_id);
                const startTime = parseTime(lecture.start_time);
                const isUpcoming = startTime > currentTime;
                const isOngoing = startTime <= currentTime && parseTime(lecture.end_time) > currentTime;
                
                html += `
                    <div class="p-4 rounded-xl ${isOngoing ? 'bg-teal-500/10 border border-teal-500/20' : 'bg-white/5 border border-white/10'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${course?.name || 'غير معروف'}</h3>
                                <div class="flex items-center gap-4 mt-2 text-sm text-gray-400">
                                    <span><i class="fas fa-users ml-1"></i> ${group?.name || 'غير معروف'}</span>
                                    <span><i class="fas fa-building ml-1"></i> ${room?.name || 'غير معروف'}</span>
                                    <span class="${isUpcoming ? 'text-blue-400' : isOngoing ? 'text-teal-400' : 'text-gray-400'}">
                                        <i class="fas fa-clock ml-1"></i> ${lecture.start_time} - ${lecture.end_time}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <span class="badge ${lecture.type === 'theoretical' ? 'badge-primary' : 'badge-secondary'}">
                                    ${lecture.type === 'theoretical' ? 'نظري' : 'عملي'}
                                </span>
                                ${isOngoing ? '<span class="badge badge-primary mr-2">جارية الآن</span>' : ''}
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="takeAttendance('${lecture.id}')" class="btn-primary flex-1 py-2">
                                <i class="fas fa-clipboard-check ml-2"></i> تسجيل حضور
                            </button>
                            <button onclick="viewLectureDetails('${lecture.id}')" class="btn-secondary flex-1 py-2">
                                <i class="fas fa-info-circle ml-2"></i> التفاصيل
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderRecentCourses() {
            const courses = (dataCache.get('course') || []).filter(c => c.doctor_id === currentUser.id).slice(0, 3);
            
            if (courses.length === 0) {
                return '<p class="text-gray-400 text-center">لا توجد مقررات مسندة إليك</p>';
            }
            
            let html = '';
            courses.forEach(course => {
                const specialization = (dataCache.get('specialization') || []).find(s => s.id === course.specialization_id);
                const students = calculateCourseStudents(course.id);
                
                html += `
                    <div class="p-3 rounded-lg bg-white/5">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium">${course.name}</h3>
                                <p class="text-sm text-gray-400">${specialization?.name || ''} - ${course.code}</p>
                            </div>
                            <span class="badge ${course.course_type === 'theoretical' ? 'badge-primary' : 'badge-secondary'}">
                                ${course.course_type === 'theoretical' ? 'نظري' : 'عملي'}
                            </span>
                        </div>
                        <div class="flex items-center justify-between mt-3 text-sm">
                            <span class="text-gray-400">${students} طالب</span>
                            <span class="text-gray-400">${course.hours} ساعة</span>
                            <button onclick="viewCourse('${course.id}')" class="text-teal-400 hover:text-teal-300">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function renderStudentTodayScheduleContent() {
            const schedules = dataCache.get('schedule') || [];
            const today = new Date().getDay();
            const currentTime = new Date().getHours() * 60 + new Date().getMinutes();
            
            const todayLectures = schedules.filter(schedule => 
                schedule.group_id === currentUser.group_id && schedule.day === today
            ).sort((a, b) => {
                const timeA = parseTime(a.start_time);
                const timeB = parseTime(b.start_time);
                return timeA - timeB;
            });
            
            if (todayLectures.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-calendar-times text-4xl mb-3"></i>
                        <p>لا توجد محاضرات مجدولة اليوم</p>
                    </div>
                `;
            }
            
            let html = '<div class="space-y-3">';
            todayLectures.forEach(lecture => {
                const course = (dataCache.get('course') || []).find(c => c.id === lecture.course_id);
                const doctor = (dataCache.get('user') || []).find(d => d.id === course?.doctor_id && d.role === 'doctor');
                const room = (dataCache.get('room') || []).find(r => r.id === lecture.room_id);
                const startTime = parseTime(lecture.start_time);
                const isUpcoming = startTime > currentTime;
                const isOngoing = startTime <= currentTime && parseTime(lecture.end_time) > currentTime;
                
                html += `
                    <div class="p-4 rounded-xl ${isOngoing ? 'bg-teal-500/10 border border-teal-500/20' : 'bg-white/5 border border-white/10'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${course?.name || 'غير معروف'}</h3>
                                <div class="flex items-center gap-4 mt-2 text-sm text-gray-400">
                                    <span><i class="fas fa-user-md ml-1"></i> ${doctor?.name || 'غير معروف'}</span>
                                    <span><i class="fas fa-building ml-1"></i> ${room?.name || 'غير معروف'}</span>
                                    <span class="${isUpcoming ? 'text-blue-400' : isOngoing ? 'text-teal-400' : 'text-gray-400'}">
                                        <i class="fas fa-clock ml-1"></i> ${lecture.start_time} - ${lecture.end_time}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <span class="badge ${lecture.type === 'theoretical' ? 'badge-primary' : 'badge-secondary'}">
                                    ${lecture.type === 'theoretical' ? 'نظري' : 'عملي'}
                                </span>
                                ${isOngoing ? '<span class="badge badge-primary mr-2">جارية الآن</span>' : ''}
                            </div>
                        </div>
                        <div class="mt-4">
                            <button onclick="markAttendance('${lecture.id}')" 
                                    class="btn-primary w-full py-2 ${isUpcoming ? '' : 'opacity-50 cursor-not-allowed'}"
                                    ${isUpcoming ? '' : 'disabled'}>
                                <i class="fas fa-check-circle ml-2"></i> تأكيد الحضور
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderStudentSpecializationInfo() {
            const specialization = (dataCache.get('specialization') || []).find(s => s.id === currentUser.specialization_id);
            const group = (dataCache.get('group') || []).find(g => g.id === currentUser.group_id);
            
            if (!specialization) {
                return '<p class="text-gray-400">لا توجد معلومات عن التخصص</p>';
            }
            
            return `
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div class="icon-circle icon-primary">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h3 class="font-medium">${specialization.name}</h3>
                            <p class="text-sm text-gray-400">${specialization.code} - ${specialization.levels || 8} مستويات</p>
                        </div>
                    </div>
                    
                    ${group ? `
                        <div class="flex items-center gap-3">
                            <div class="icon-circle icon-blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">${group.name}</h3>
                                <p class="text-sm text-gray-400">المجموعة الدراسية</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="p-3 rounded-lg bg-white/5">
                        <h4 class="font-medium mb-2">وصف التخصص</h4>
                        <p class="text-sm text-gray-300">${specialization.description || 'لا يوجد وصف متاح'}</p>
                    </div>
                </div>
            `;
        }

        function renderImportantNotifications() {
            // مؤقت - في النسخة النهائية ستأتي من قاعدة البيانات
            const notifications = [
                { id: 1, title: 'اختبار منتصف الفصل', message: 'سيتم عقد اختبار مادة قواعد البيانات الأسبوع القادم', type: 'exam', time: 'قبل 2 يوم' },
                { id: 2, title: 'تسليم الواجب', message: 'آخر موعد لتسليم واجب البرمجة هو يوم الخميس', type: 'assignment', time: 'قبل 5 أيام' },
                { id: 3, title: 'تغيير قاعة', message: 'تم تغيير قاعة محاضرة الشبكات إلى قاعة 305', type: 'schedule', time: 'قبل أسبوع' }
            ];
            
            let html = '';
            notifications.forEach(notif => {
                const icon = notif.type === 'exam' ? 'fa-file-alt' : 
                           notif.type === 'assignment' ? 'fa-tasks' : 'fa-calendar-alt';
                const color = notif.type === 'exam' ? 'text-red-400' : 
                            notif.type === 'assignment' ? 'text-yellow-400' : 'text-blue-400';
                
                html += `
                    <div class="p-3 rounded-lg bg-white/5">
                        <div class="flex items-start gap-3">
                            <i class="fas ${icon} ${color} mt-1"></i>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <h4 class="font-medium">${notif.title}</h4>
                                    <span class="text-xs text-gray-400">${notif.time}</span>
                                </div>
                                <p class="text-sm text-gray-300 mt-1">${notif.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        // =============================================
        // دوال مساعدة عامة
        // =============================================
        function getDayName(dayIndex) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return days[dayIndex] || 'غير محدد';
        }

        function parseTime(timeString) {
            if (!timeString) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + (minutes || 0);
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'منذ فترة';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `قبل ${diffMins} دقيقة`;
            if (diffHours < 24) return `قبل ${diffHours} ساعة`;
            if (diffDays < 7) return `قبل ${diffDays} يوم`;
            if (diffDays < 30) return `قبل ${Math.floor(diffDays / 7)} أسبوع`;
            if (diffDays < 365) return `قبل ${Math.floor(diffDays / 30)} شهر`;
            return `قبل ${Math.floor(diffDays / 365)} سنة`;
        }

        function calculateCourseStudents(courseId) {
            const course = (dataCache.get('course') || []).find(c => c.id === courseId);
            if (!course) return 0;
            
            const groups = (dataCache.get('group') || []).filter(g => g.specialization_id === course.specialization_id);
            let total = 0;
            
            groups.forEach(group => {
                const students = (dataCache.get('user') || []).filter(u => u.group_id === group.id && u.role === 'student').length;
                total += students;
            });
            
            return total;
        }

        function updateDateTime() {
            const now = new Date();
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            
            if (dateElement) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('ar-SA', options);
            }
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            }
        }

        function updateQuickStats() {
            if (currentUser.role === 'student') {
                const stats = calculateStudentStats();
                document.getElementById('quick-stats-courses').textContent = stats.courses;
                document.getElementById('quick-stats-schedule').textContent = stats.todayLectures;
            } else if (currentUser.role === 'doctor') {
                const stats = calculateDoctorStats();
                document.getElementById('quick-stats-courses').textContent = stats.courses;
                document.getElementById('quick-stats-schedule').textContent = stats.todayLectures;
            }
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentElement.querySelector('button');
            const icon = button.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 z-30 md:hidden';
            overlay.onclick = () => {
                sidebar.classList.remove('translate-x-0');
                overlay.remove();
            };
            
            if (sidebar.classList.contains('translate-x-0')) {
                sidebar.classList.remove('translate-x-0');
                document.querySelector('.fixed.inset-0.bg-black\\/50')?.remove();
            } else {
                sidebar.classList.add('translate-x-0');
                document.body.appendChild(overlay);
            }
        }

        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('translate-x-0');
            document.querySelector('.fixed.inset-0.bg-black\\/50')?.remove();
        }

        function toggleDarkMode() {
            userPreferences.darkMode = !userPreferences.darkMode;
            if (userPreferences.darkMode) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notifications-panel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                loadNotifications();
            }
        }

        function toggleQuickSearch() {
            const panel = document.getElementById('quick-search-panel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                document.getElementById('quick-search-input').focus();
            }
        }

        function loadNotifications() {
            const container = document.getElementById('notifications-list');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-bell-slash text-3xl mb-3"></i>
                    <p>لا توجد إشعارات جديدة</p>
                </div>
            `;
        }

        function markAllAsRead() {
            showToast('تم تعيين جميع الإشعارات كمقروءة', 'success');
            document.getElementById('notification-badge').classList.add('hidden');
            toggleNotifications();
        }

        function handleSidebarSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const navItems = document.querySelectorAll('#sidebar-nav button');
            
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function handleGlobalSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            if (searchTerm.length < 2) return;
            
            const results = searchIndex.filter(item => 
                item.searchText.includes(searchTerm)
            ).slice(0, 5);
            
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
            showToast(`وجدنا ${results.length} نتيجة للبحث`, 'info');
        }

        function handleQuickSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const container = document.getElementById('quick-search-results');
            
            if (searchTerm.length < 2) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">اكتب للبحث...</p>';
                return;
            }
            
            const results = searchIndex.filter(item => 
                item.searchText.includes(searchTerm)
            ).slice(0, 10);
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>لم يتم العثور على نتائج</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="space-y-2">';
            results.forEach(result => {
                html += `
                    <button onclick="searchResultClicked('${result.type}', '${result.id}')" 
                            class="w-full text-right p-3 rounded-lg hover:bg-white/5 transition-all">
                        <div class="font-medium">${result.title}</div>
                        <div class="text-sm text-gray-400">${result.description}</div>
                        <div class="text-xs text-teal-400 mt-1">${result.type === 'course' ? 'مقرر' : 
                                                               result.type === 'doctor' ? 'دكتور' : 'جدول'}</div>
                    </button>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function searchResultClicked(type, id) {
            toggleQuickSearch();
            
            switch(type) {
                case 'course':
                    viewCourse(id);
                    break;
                case 'doctor':
                    viewDoctorProfile(id);
                    break;
                case 'schedule':
                    viewScheduleDetails(id);
                    break;
            }
        }

        function setupActivityMonitor() {
            // تحديث وقت النشاط الأخير
            document.addEventListener('click', updateLastActivity);
            document.addEventListener('keypress', updateLastActivity);
            document.addEventListener('mousemove', updateLastActivity);
            
            // التحقق من انتهاء الجلسة
            setInterval(checkSessionTimeout, 60000); // كل دقيقة
        }

        function updateLastActivity() {
            lastActivity = Date.now();
        }

        function checkSessionTimeout() {
            const inactiveTime = Date.now() - lastActivity;
            if (inactiveTime > SYSTEM_CONFIG.SESSION_TIMEOUT) {
                showToast('انتهت مدة الجلسة بسبب عدم النشاط', 'warning');
                setTimeout(() => handleLogout(), 5000);
            }
        }

        // =============================================
        // دوال عرض النماذج المنبثقة
        // =============================================
        function showProfileModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">الملف الشخصي</h2>
                    <p class="text-gray-400">إدارة معلومات حسابك</p>
                </div>
                
                <div class="space-y-6">
                    <div class="flex items-center justify-center mb-6">
                        <div class="relative">
                            <div class="w-32 h-32 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-4xl font-bold text-white">
                                ${currentUser.name.charAt(0)}
                            </div>
                            <button onclick="changeAvatar()" class="absolute bottom-2 right-2 w-10 h-10 rounded-full bg-gray-800 border-2 border-gray-700 flex items-center justify-center hover:bg-gray-700">
                                <i class="fas fa-camera text-white"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">الاسم الكامل</label>
                            <input type="text" value="${currentUser.name}" class="input-field" readonly>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">البريد الإلكتروني</label>
                            <input type="email" value="${currentUser.email}" class="input-field" readonly>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">الدور</label>
                        <input type="text" value="${currentUser.role === 'admin' ? 'مدير النظام' : 
                                                 currentUser.role === 'doctor' ? 'دكتور' : 'طالب'}" 
                               class="input-field" readonly>
                    </div>
                    
                    ${currentUser.role === 'student' ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">التخصص</label>
                                <input type="text" value="${getSpecializationName(currentUser.specialization_id)}" class="input-field" readonly>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">المجموعة</label>
                                <input type="text" value="${getGroupName(currentUser.group_id)}" class="input-field" readonly>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-3 mt-8">
                        <button onclick="showEditProfileModal()" class="btn-primary flex-1 py-3">
                            <i class="fas fa-edit ml-2"></i> تعديل الملف
                        </button>
                        <button onclick="hideModal()" class="btn-secondary flex-1 py-3">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;
            showModal('profile-modal', content);
        }

        function showHelpModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">مركز المساعدة</h2>
                    <p class="text-gray-400">دعم فني وإجابات للأسئلة الشائعة</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="p-4 rounded-lg bg-white/5">
                        <h3 class="font-bold mb-2"><i class="fas fa-question-circle text-teal-400 ml-2"></i> كيف أسجل حضور المحاضرات؟</h3>
                        <p class="text-gray-300 text-sm">يمكنك تسجيل الحضور من خلال صفحة "جدول اليوم" أو "جدولي" حسب دورك في النظام.</p>
                    </div>
                    
                    <div class="p-4 rounded-lg bg-white/5">
                        <h3 class="font-bold mb-2"><i class="fas fa-question-circle text-teal-400 ml-2"></i> كيف أضيف مقرر جديد؟</h3>
                        <p class="text-gray-300 text-sm">فقط مستخدمي العمادة يمكنهم إضافة مقررات جديدة من صفحة "إدارة المقررات".</p>
                    </div>
                    
                    <div class="p-4 rounded-lg bg-white/5">
                        <h3 class="font-bold mb-2"><i class="fas fa-question-circle text-teal-400 ml-2"></i> كيف أتواصل مع الدعم الفني؟</h3>
                        <p class="text-gray-300 text-sm">يمكنك التواصل عبر البريد الإلكتروني: support@lms.edu أو الهاتف: +966 123 456 789</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="contactSupport()" class="btn-primary flex-1 py-3">
                        <i class="fas fa-headset ml-2"></i> تواصل مع الدعم
                    </button>
                    <button onclick="hideModal()" class="btn-secondary flex-1 py-3">
                        إغلاق
                    </button>
                </div>
            `;
            showModal('help-modal', content);
        }

        function showAboutModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">حول النظام</h2>
                    <p class="text-gray-400">معلومات عن نظام إدارة المحاضرات الأكاديمية</p>
                </div>
                
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-2xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold">نظام إدارة المحاضرات الأكاديمية</h3>
                        <p class="text-gray-400">الإصدار ${SYSTEM_CONFIG.VERSION}</p>
                    </div>
                    
                    <div class="p-4 rounded-lg bg-white/5">
                        <h4 class="font-bold mb-3">مميزات النظام:</h4>
                        <ul class="space-y-2 text-sm text-gray-300">
                            <li class="flex items-center gap-2">
                                <i class="fas fa-check text-teal-400"></i>
                                <span>إدارة متكاملة للمحاضرات والجداول</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i class="fas fa-check text-teal-400"></i>
                                <span>نظام حضور ذكي وتقارير متقدمة</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i class="fas fa-check text-teal-400"></i>
                                <span>واجهة عربية متكاملة وسهلة الاستخدام</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i class="fas fa-check text-teal-400"></i>
                                <span>دعم كامل للأجهزة المحمولة</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i class="fas fa-check text-teal-400"></i>
                                <span>تكامل مع Firebase للتخزين الآمن</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="text-center text-sm text-gray-400">
                        <p>© 2024 جميع الحقوق محفوظة.</p>
                        <p class="mt-1">تم التطوير باستخدام HTML5, CSS3, JavaScript, Firebase</p>
                    </div>
                    
                    <button onclick="hideModal()" class="btn-primary w-full py-3">
                        إغلاق
                    </button>
                </div>
            `;
            showModal('about-modal', content);
        }

        function showTermsModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">الشروط والأحكام</h2>
                </div>
                
                <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                    <p class="text-gray-300">يرجى قراءة الشروط والأحكام التالية بعناية قبل استخدام النظام.</p>
                    
                    <div>
                        <h3 class="font-bold mb-2">1. القبول</h3>
                        <p class="text-gray-300 text-sm">باستخدامك للنظام، فإنك توافق على الالتزام بهذه الشروط والأحكام.</p>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2">2. الاستخدام المسموح</h3>
                        <p class="text-gray-300 text-sm">يسمح باستخدام النظام للأغراض التعليمية فقط. يحظر استخدامه لأي أغراض غير قانونية.</p>
                    </div>
                    
                    <!-- إضافة المزيد من الشروط هنا -->
                </div>
                
                <button onclick="hideModal()" class="btn-primary w-full py-3">
                    فهمت ذلك
                </button>
            `;
            showModal('terms-modal', content);
        }

        function showPrivacyModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">سياسة الخصوصية</h2>
                </div>
                
                <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                    <p class="text-gray-300">نحن نحترم خصوصيتك ونلتزم بحماية بياناتك الشخصية.</p>
                    
                    <div>
                        <h3 class="font-bold mb-2">1. المعلومات التي نجمعها</h3>
                        <p class="text-gray-300 text-sm">نجمع المعلومات التي تقدمها لنا عند التسجيل واستخدام النظام.</p>
                    </div>
                    
                    <div>
                        <h3 class="font-bold mb-2">2. استخدام المعلومات</h3>
                        <p class="text-gray-300 text-sm">نستخدم معلوماتك لتقديم الخدمات وتحسين تجربة المستخدم.</p>
                    </div>
                    
                    <!-- إضافة المزيد من سياسة الخصوصية هنا -->
                </div>
                
                <button onclick="hideModal()" class="btn-primary w-full py-3">
                    فهمت ذلك
                </button>
            `;
            showModal('privacy-modal', content);
        }

        function getSpecializationName(id) {
            const spec = (dataCache.get('specialization') || []).find(s => s.id === id);
            return spec ? spec.name : 'غير محدد';
        }

        function getGroupName(id) {
            const group = (dataCache.get('group') || []).find(g => g.id === id);
            return group ? group.name : 'غير محدد';
        }

        // =============================================
        // دوال مساعدة للوظائف المتبقية
        // =============================================
        function refreshDashboard() {
            showToast('جاري تحديث البيانات...', 'info');
            setTimeout(() => {
                loadInitialData();
            }, 1000);
        }

        function takeAttendance(scheduleId) {
            showToast('تم فتح صفحة تسجيل الحضور', 'info');
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
        }

        function markAttendance(scheduleId) {
            showToast('تم تأكيد حضورك', 'success');
        }

        function viewCourse(courseId) {
            showToast('جاري تحميل معلومات المقرر...', 'info');
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
        }

        function viewDoctorProfile(doctorId) {
            showToast('جاري تحميل الملف الشخصي للدكتور...', 'info');
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
        }

        function viewLectureDetails(lectureId) {
            showToast('جاري تحميل تفاصيل المحاضرة...', 'info');
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
        }

        function viewAnnouncement(announcementId) {
            showToast('جاري تحميل الإعلان...', 'info');
            // سيتم تطوير هذه الوظيفة في النسخة النهائية
        }

        function contactSupport() {
            window.open('mailto:support@lms.edu', '_blank');
        }

        function changeAvatar() {
            showToast('ستتوفر هذه الميزة قريباً', 'info');
        }

        function showEditProfileModal() {
            showToast('ستتوفر هذه الميزة قريباً', 'info');
        }

        // =============================================
        // دوال إدارة البيانات (للوظائف المتبقية)
        // =============================================
        function showAddSpecializationModal() {
            const content = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold">إضافة تخصص جديد</h2>
                    <p class="text-gray-400">أدخل بيانات التخصص الجديد</p>
                </div>
                <form onsubmit="addSpecialization(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">اسم التخصص</label>
                            <input type="text" id="spec-name" class="input-field" required placeholder="مثل: علوم الحاسب">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">رمز التخصص</label>
                                <input type="text" id="spec-code" class="input-field" required placeholder="مثل: CS">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">عدد المستويات</label>
                                <select id="spec-levels" class="input-field">
                                    ${[1,2,3,4,5,6,7,8].map(l => `<option value="${l}">${l} مستويات</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">وصف التخصص</label>
                            <textarea id="spec-description" class="input-field" rows="3" placeholder="وصف مختصر للتخصص..."></textarea>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-8">
                        <button type="submit" class="btn-primary flex-1 py-3">إضافة</button>
                        <button type="button" onclick="hideModal()" class="btn-secondary flex-1 py-3">إلغاء</button>
                    </div>
                </form>
            `;
            showModal('help-modal', content);
        }

        async function addSpecialization(e) {
            e.preventDefault();
            if (currentUser?.role !== 'admin') {
                showToast('ليس لديك صلاحية لهذا الإجراء', 'error');
                return;
            }

            const name = document.getElementById('spec-name').value;
            const code = document.getElementById('spec-code').value;
            const description = document.getElementById('spec-description').value;
            const levels = document.getElementById('spec-levels').value;

            try {
                const docRef = await db.collection('specializations').add({
                    name: name,
                    code: code,
                    description: description || '',
                    levels: parseInt(levels),
                    status: 'active',
                    createdAt: new Date().toISOString()
                });

                showToast('تم إضافة التخصص بنجاح', 'success');
                hideModal();

                // إعادة تحميل البيانات
                await loadInitialData();
            } catch (error) {
                console.error("Error adding specialization:", error);
                showToast('فشل في إضافة التخصص: ' + error.message, 'error');
            }
        }

        // =============================================
        // تهيئة التطبيق
        // =============================================
        async function initializeApp() {
            try {
                // تهيئة Firebase
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                console.log("✅ Firebase initialized successfully");
                
                // استعادة تفضيلات المستخدم
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode === 'true') {
                    userPreferences.darkMode = true;
                    document.body.classList.add('dark-mode');
                }
                
                // مراقبة حالة المصادقة
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("👤 User is signed in:", user.email);
                        
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                currentUser = new User({
                                    id: user.uid,
                                    name: userData.name || 'مستخدم',
                                    email: user.email,
                                    role: userData.role || 'student',
                                    specialization_id: userData.specialization_id || '',
                                    group_id: userData.group_id || '',
                                    avatar: userData.avatar || '',
                                    status: userData.status || 'active'
                                });
                                
                                showDashboard();
                            }
                        } catch (error) {
                            console.error("Error loading user data:", error);
                        }
                    } else {
                        console.log("👤 No user is signed in");
                        document.getElementById('dashboard').classList.add('hidden');
                        document.getElementById('login-page').classList.remove('hidden');
                        document.getElementById('loading-screen').classList.add('hidden');
                    }
                });
                
            } catch (error) {
                console.error("❌ Error initializing Firebase:", error);
                showToast('فشل في تهيئة قاعدة البيانات', 'error');
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('login-page').classList.remove('hidden');
                }, 1000);
            }

            // تهيئة SDKs
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: DEFAULT_CONFIG,
                    onConfigChange: async (newConfig) => {
                        config = { ...DEFAULT_CONFIG, ...newConfig };
                        applyConfig();
                        await loadInitialData();
                    },
                    mapToCapabilities: (cfg) => ({
                        recolorables: [
                            {
                                get: () => cfg.background_color || DEFAULT_CONFIG.background_color,
                                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
                            },
                            {
                                get: () => cfg.surface_color || DEFAULT_CONFIG.surface_color,
                                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
                            },
                            {
                                get: () => cfg.text_color || DEFAULT_CONFIG.text_color,
                                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
                            },
                            {
                                get: () => cfg.primary_action || DEFAULT_CONFIG.primary_action,
                                set: (v) => { cfg.primary_action = v; window.elementSdk.setConfig({ primary_action: v }); }
                            },
                            {
                                get: () => cfg.secondary_action || DEFAULT_CONFIG.secondary_action,
                                set: (v) => { cfg.secondary_action = v; window.elementSdk.setConfig({ secondary_action: v }); }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => cfg.font_family || DEFAULT_CONFIG.font_family,
                            set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
                        },
                        fontSizeable: {
                            get: () => cfg.font_size || DEFAULT_CONFIG.font_size,
                            set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
                        }
                    }),
                    mapToEditPanelValues: (cfg) => new Map([
                        ['system_title', cfg.system_title || DEFAULT_CONFIG.system_title],
                        ['welcome_message', cfg.welcome_message || DEFAULT_CONFIG.welcome_message]
                    ])
                });
            }

            if (window.dataSdk) {
                const result = await window.dataSdk.init({
                    onDataChanged: (data) => {
                        allData = data;
                        updateUI();
                    }
                });
                
                if (!result.isOk) {
                    showToast('فشل في تهيئة قاعدة البيانات', 'error');
                }
            }

            // تطبيق التخصيصات
            applyConfig();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            // بدء تحميل البيانات
            await loadInitialData();
        }

        function setupEventListeners() {
            // إغلاق النماذج عند النقر خارجها
            document.getElementById('modal-overlay').addEventListener('click', hideModal);
            
            // منع إغلاق النماذج عند النقر داخلها
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.addEventListener('click', (e) => e.stopPropagation());
            });
            
            // إغلاق البحث السريع بالإسكيب
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const searchPanel = document.getElementById('quick-search-panel');
                    if (!searchPanel.classList.contains('hidden')) {
                        toggleQuickSearch();
                    }
                    const notificationsPanel = document.getElementById('notifications-panel');
                    if (!notificationsPanel.classList.contains('hidden')) {
                        toggleNotifications();
                    }
                }
            });
        }

        // بدء تشغيل التطبيق
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>